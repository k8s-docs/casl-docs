<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<link rel="canonical" type="text/html" href="https://wdk-docs.github.io/casl-docs/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://wdk-docs.github.io/casl-docs/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/casl-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/casl-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/casl-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/casl-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-192x192.png" sizes="192x192">

<title>文档 | NestJS 文档</title>
<meta name="description" content="
  






CASL (pronounced /ˈkæsəl/, like castle) is an isomorphic authorization JavaScript library which restricts what resources a given user is …">
<meta property="og:title" content="文档" />
<meta property="og:description" content="NestJs 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://wdk-docs.github.io/casl-docs/docs/" /><meta property="og:site_name" content="NestJS 文档" />

<meta itemprop="name" content="文档">
<meta itemprop="description" content="NestJs 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="文档"/>
<meta name="twitter:description" content="NestJs 文档"/>




<link rel="preload" href="/casl-docs/scss/main.scss" as="style">
<link href="/casl-docs/scss/main.scss" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/casl-docs/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">NestJS 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/casl-docs/docs/" ><span class="active">文档</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/casl-docs/docs/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">文档</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-863c9d61ac19dc6660ef85ab789f133a">指南</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-9d064ae46378a7ea4cd8395fa6f188b4">安装</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-c08345e7a1a6422ae94efe2cdf79b2e4">介绍</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-51a9859bc2f83b67fa71be170d88d343">定义规则</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-649681944f858128de1b5f1a01c61b2f">深度条件下</a></li>


    
  
    
    
	
<li>1.5: <a href="#pg-3498bbe7f8714db5f02e2accf63aa843">限制字段访问</a></li>


    
  
    
    
	
<li>1.6: <a href="#pg-c7e6f9001127982861f81d00fd317eaa">主题类型检测</a></li>


    
  
    
    
	
<li>1.7: <a href="#pg-d4173def6f5a3fd9c84a2973d3878334">行动定义别名</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-855747809fc2a2d136fdd237db304949">高级</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-ece8921c8a9bf42a0dce2f797a74f55b">Ability inheritance</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-cd471495cf7beb0aae5fa5f1ce2f6f8d">TypeScript Support</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-2af56faabe5a8af74442495478a93bce">Customize Ability</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-620096a4152f1dbfb9f132e1302b8108">Debugging and testing</a></li>


    
  
    
    
	
<li>2.5: <a href="#pg-6d06b4742afea388308a653da9b99592">Ability to database query</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-d3231b1184e4a3523ac6cf37a140903a">官方包</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-0f26e8115c358f155f08e4e727caad15">CASL Prisma</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-f1c426f5b028adc5cd307b47819ebf58">CASL Mongoose</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-140215cf4a90c64b3979f7fdb6e76f22">CASL Angular</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-967759b2c100528c84c40ea798b91042">CASL React</a></li>


    
  
    
    
	
<li>3.5: <a href="#pg-bdf4089ba2ab126166f63dc70a9a3ffb">CASL Vue</a></li>


    
  
    
    
	
<li>3.6: <a href="#pg-2cbd1663e397c8abef5d83e112a619f3">CASL Aurelia</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-f1dd821e012ff2fb15bfa486a7647ae3">食谱</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-e885a88fdfc50203dbb9ee3a8bad01d0">Cookbook Introduction</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-34cd71443a17b1e740561cc7115b3277">Less confusing can API</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-4c6eef94c958d52006827a9da7ccc6e3">Claim based Authorization</a></li>


    
  
    
    
	
<li>4.4: <a href="#pg-b3edd3f097341ab85af67ee61c3e5879">Cache abilities</a></li>


    
  
    
    
	
<li>4.5: <a href="#pg-001366d799f10789e049c841de4397c9">Roles with predefined permissions</a></li>


    
  
    
    
	
<li>4.6: <a href="#pg-7afd37d55b8ffbfe5b2b6d5b29e6800b">Roles with persisted permissions</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-db699884bd3aedc1fbac2328d8409e60">api</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-2f7a9f5a690448dfd87b7e5b19fb16e6">@casl/ability API</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-9f3a20826f3b9b5582b8c565a1690611">@casl/ability/extra API</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-4ad47675a7d3929a1b9a62c20847b0f6">支持</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-e0abdd3f2b860a0f75c5b7a292a326c8">Support CASL.js Development</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-bad9e3ce98c380a5f47dd9da802bfbe1">未找到</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-7018e070557995a2ac48303e0b59ac22">Not Found</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <p align="center">
  <a href="https://stalniy.github.io/casl/" target="_blank" rel="noopener noreferrer"><img width="150" src="docs-src/src/assets/shield.png" alt="CASL logo"></a>
<p><a href="https://opencollective.com/casljs"><img src="https://opencollective.com/casljs/all/badge.svg?label=financial+contributors" alt="Financial Contributors on Open Collective"></a>
<img src="https://github.com/stalniy/casl/workflows/CI/badge.svg" alt="build">
<a href="https://codecov.io/gh/stalniy/casl"><img src="https://codecov.io/gh/stalniy/casl/branch/master/graph/badge.svg" alt="CASL codecov"></a>
<a href="https://gitter.im/stalniy-casl/casl"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="CASL Join the chat at https://gitter.im/stalniy-casl/casl"></a></p>
<!-- [![CASL Code Climate](https://codeclimate.com/github/stalniy/casl/badges/gpa.svg)](https://codeclimate.com/github/stalniy/casl) -->
</p>
<p>CASL (pronounced /ˈkæsəl/, like <strong>castle</strong>) is an isomorphic authorization JavaScript library which restricts what resources a given user is allowed to access. It&rsquo;s designed to be incrementally adoptable and can easily scale between a simple claim based and fully featured subject and attribute based authorization. It makes it easy to manage and share permissions across UI components, API services, and database queries.</p>
<p>Heavily inspired by <a href="https://github.com/CanCanCommunity/cancancan">cancan</a>.</p>
<h2 id="features">Features</h2>
<ul>
<li><strong>Versatile</strong><br>
An incrementally adoptable and can easily scale between a simple claim based and fully featured subject and attribute based authorization.</li>
<li><strong>Isomorphic</strong><br>
Can be used on frontend and backend and complementary packages make integration with major Frontend Frameworks and Backend ORMs effortless</li>
<li><strong>TypeSafe</strong><br>
Written in TypeScript, what makes your apps safer and developer experience more enjoyable</li>
<li><strong>Tree shakable</strong><br>
The core is only 6KB mingzipped and can be even smaller!</li>
<li><strong>Declarative</strong><br>
Thanks to declarative rules, you can serialize and share permissions between UI and API or microservices</li>
</ul>
<h2 id="ecosystem">Ecosystem</h2>
<table>
<thead>
<tr>
<th>Project</th>
<th>Status</th>
<th>Description</th>
<th>Supported envinronemnts</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="packages/casl-ability">@casl/ability</a></td>
<td><a href="https://www.npmjs.com/package/@casl/ability"><img src="https://img.shields.io/npm/v/@casl/ability.svg" alt="@casl/ability-status"></a></td>
<td>CASL&rsquo;s core package</td>
<td>nodejs 8+ and ES5 compatible browsers (IE 9+)</td>
</tr>
<tr>
<td><a href="packages/casl-mongoose">@casl/mongoose</a></td>
<td><a href="https://www.npmjs.com/package/@casl/mongoose"><img src="https://img.shields.io/npm/v/@casl/mongoose.svg" alt="@casl/mongoose-status"></a></td>
<td>integration with <a href="http://mongoosejs.com/">Mongoose</a></td>
<td>nodejs 8+</td>
</tr>
<tr>
<td><a href="packages/casl-prisma">@casl/prisma</a></td>
<td><a href="https://www.npmjs.com/package/@casl/prisma"><img src="https://img.shields.io/npm/v/@casl/prisma.svg" alt="@casl/prisma-status"></a></td>
<td>integration with <a href="https://www.prisma.io/">Prisma</a></td>
<td>nodejs 12+</td>
</tr>
<tr>
<td><a href="packages/casl-angular">@casl/angular</a></td>
<td><a href="https://www.npmjs.com/package/@casl/angular"><img src="https://img.shields.io/npm/v/@casl/angular.svg" alt="@casl/angular-status"></a></td>
<td>integration with <a href="https://angular.io/">Angular</a></td>
<td>IE 9+</td>
</tr>
<tr>
<td><a href="packages/casl-react">@casl/react</a></td>
<td><a href="https://www.npmjs.com/package/@casl/react"><img src="https://img.shields.io/npm/v/@casl/react.svg" alt="@casl/react-status"></a></td>
<td>integration with <a href="https://reactjs.org/">React</a></td>
<td>IE 9+</td>
</tr>
<tr>
<td><a href="packages/casl-vue">@casl/vue</a></td>
<td><a href="https://www.npmjs.com/package/@casl/vue"><img src="https://img.shields.io/npm/v/@casl/vue.svg" alt="@casl/vue-status"></a></td>
<td>integration with <a href="https://vuejs.org">Vue</a></td>
<td>IE 11+ (uses <code>WeakMap</code>)</td>
</tr>
<tr>
<td><a href="packages/casl-aurelia">@casl/aurelia</a></td>
<td><a href="https://www.npmjs.com/package/@casl/aurelia"><img src="https://img.shields.io/npm/v/@casl/aurelia.svg" alt="@casl/aurelia-status"></a></td>
<td>integration with <a href="http://aurelia.io">Aurelia</a></td>
<td>IE 11+ (uses <code>WeakMap</code>)</td>
</tr>
</tbody>
</table>
<h2 id="documentation">Documentation</h2>
<p>A lot of detailed information about CASL, integrations and examples can be found in <a href="https://stalniy.github.io/casl/">documentation</a>.</p>
<h2 id="have-a-question">Have a question?</h2>
<p>Ask it in <a href="https://gitter.im/stalniy-casl/casl">chat</a> or on <a href="https://stackoverflow.com/questions/tagged/casl">stackoverflow</a>. Please don&rsquo;t ask questions in issues, the issue list of this repo is <strong>exclusively</strong> for bug reports and feature requests. Questions in the issue list may be closed immediately without answers.</p>
<h2 id="casl-crash-course">CASL crash course</h2>
<p>CASL operates on the abilities level, that is what a user can actually do in the application. An ability itself depends on the 4 parameters (last 3 are optional):</p>
<ol>
<li>User Action<br>
Describes what user can actually do in the app. User action is a word (usually a verb) which depends on the business logic (e.g., <code>prolong</code>, <code>read</code>). Very often it will be a list of words from CRUD - <code>create</code>, <code>read</code>, <code>update</code> and <code>delete</code>.</li>
<li>Subject<br>
The subject or subject type which you want to check user action on. Usually this is a business (or domain) entity name (e.g., <code>Subscription</code>, <code>BlogPost</code>, <code>User</code>).</li>
<li>Conditions<br>
An object or function which restricts user action only to matched subjects. This is useful when you need to give a permission on resources created by a user (e.g., to allow user to update and delete own <code>BlogPost</code>)</li>
<li>Fields<br>
Can be used to restrict user action only to matched subject&rsquo;s fields (e.g., to allow moderator to update <code>hidden</code> field of <code>BlogPost</code> but not update <code>description</code> or <code>title</code>)</li>
</ol>
<p>Using CASL you can describe abilities using regular and inverted rules. Let&rsquo;s see how</p>
<p><strong>Note:</strong> all the examples below will be written in TypeScript but CASL can be used in similar way in ES6+ and Nodejs environments.</p>
<h3 id="1-define-abilities">1. Define Abilities</h3>
<p>Lets define <code>Ability</code> for a blog website where visitors:</p>
<ul>
<li>can read blog posts</li>
<li>can manage (i.e., do anything) own posts</li>
<li>cannot delete a post if it was created more than a day ago</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;@casl/ability&#39;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;../models&#39;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// application specific interfaces
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * @param user contains details about logged in user: its id, name, email, etc
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilitiesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// can read blog posts
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;BlogPost&#39;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#8f5902;font-style:italic">// can manage (i.e., do anything) own posts
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;manage&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;BlogPost&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">user.id</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#8f5902;font-style:italic">// cannot delete a post if it was created more than a day ago
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;delete&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;BlogPost&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">createdAt</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$lt</span>: <span style="color:#204a87;font-weight:bold">Date.now</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">24</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1000</span> <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Do you see how easily business requirements were translated into CASL&rsquo;s rules?</p>
<p><strong>Note</strong>: you can use class instead of string as a subject type (e.g., <code>can('read', BlogPost)</code>)</p>
<p>And yes, <code>Ability</code> class allow you to use some MongoDB operators to define conditions. Don&rsquo;t worry if you don&rsquo;t know MongoDB, it&rsquo;s not required and explained in details in <a href="https://stalniy.github.io/casl/en/guide/define-rules">Defining Abilities</a></p>
<h3 id="2-check-abilities">2. Check Abilities</h3>
<p>Later on you can check abilities by using <code>can</code> and <code>cannot</code> methods of <code>Ability</code> instance.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// in the same file as above
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getLoggedInUser</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// app specific function
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilitiesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BlogPost</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// business entity
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">props</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">props</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// true if ability allows to read at least one Post
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;BlogPost&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// the same as
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BlogPost</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// true, if user is the author of the blog post
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BlogPost</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">author</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}));</span>

<span style="color:#8f5902;font-style:italic">// true if there is no ability to read this particular blog post
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ONE_DAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">24</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">postCreatedNow</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BlogPost</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">createdAt</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">postCreatedAWeekAgo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">BlogPost</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">createdAt</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">ONE_DAY</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// can delete if it&#39;s created less than a day ago
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postCreatedNow</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postCreatedAWeekAgo</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// you can even throw an error if there is a missed ability
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">postCreatedAWeekAgo</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Of course, you are not restricted to use only class instances in order to check permissions on objects. See <a href="https://stalniy.github.io/casl/en/guide/intro">Introduction</a> for the detailed explanation.</p>
<h3 id="3-database-integration">3. Database integration</h3>
<p>CASL has a complementary package <a href="packages/casl-mongoose">@casl/mongoose</a> which provides easy integration with MongoDB and <a href="http://mongoosejs.com/">mongoose</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">accessibleRecordsPlugin</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">mongoose</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;mongoose&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">plugin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">accessibleRecordsPlugin</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">getUserLoggedInUser</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// app specific function
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilitiesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">BlogPost</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">model</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#4e9a06">&#34;BlogPost&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">mongoose</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Schema</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">String</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">author</span>: <span style="color:#204a87;font-weight:bold">mongoose.Types.ObjectId</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">String</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">createdAt</span>: <span style="color:#204a87;font-weight:bold">Date</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">hidden</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Boolean</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">})</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// returns mongoose Query, so you can chain it with other conditions
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">posts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">BlogPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">accessibleBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">hidden</span>: <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// you can also call it on existing query to enforce permissions
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">hiddenPosts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">BlogPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">hidden</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">accessibleBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// you can even pass the action as a 2nd parameter. By default action is &#34;read&#34;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">updatablePosts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">BlogPost</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">accessibleBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>See <a href="https://stalniy.github.io/casl/en/package/casl-mongoose">Database integration</a> for details.</p>
<h3 id="4-advanced-usage">4. Advanced usage</h3>
<p><strong>CASL is incrementally adoptable</strong>, that means you can start your project with simple claim (or action) based authorization and evolve it later, when your app functionality evolves.</p>
<p><strong>CASL is composable</strong>, that means you can implement alternative conditions matching (e.g., based on <a href="https://www.npmjs.com/package/@hapi/joi">joi</a>, <a href="https://www.npmjs.com/package/ajv">ajv</a> or pure functions) and field matching (e.g., to support alternative syntax in fields like <code>addresses.*.street</code> or <code>addresses[0].street</code>) logic.</p>
<p>See <a href="https://stalniy.github.io/casl/en/advanced/customize-ability">Advanced usage</a> for details.</p>
<h3 id="5-examples">5. Examples</h3>
<p>Looking for examples? Check <a href="https://github.com/stalniy/casl-examples">CASL examples</a> repository.</p>
<h2 id="want-to-help">Want to help?</h2>
<p>Want to file a bug, contribute some code, or improve documentation? Excellent! Read up on guidelines for <a href="https://github.com/stalniy/casl/blob/master/CONTRIBUTING.md">contributing</a>.</p>
<p>If you&rsquo;d like to help us sustain our community and project, consider <a href="https://opencollective.com/casljs/contribute">to become a financial contributor on Open Collective</a></p>
<h2 id="contributors">Contributors</h2>
<h3 id="code-contributors">Code Contributors</h3>
<p>This project exists thanks to all the people who contribute. [<a href="CONTRIBUTING.md">Contribute</a>].
<a href="https://github.com/stalniy/casl/graphs/contributors"><img src="https://opencollective.com/casljs/contributors.svg?width=890&button=false" /></a></p>
<h3 id="financial-contributors">Financial Contributors</h3>
<p>Become a financial contributor and help us sustain our community. [<a href="https://opencollective.com/casljs/contribute">Contribute</a>]</p>
<h4 id="individuals">Individuals</h4>
<p><a href="https://opencollective.com/casljs"><img src="https://opencollective.com/casljs/individuals.svg?width=890"></a></p>
<h4 id="organizations">Organizations</h4>
<p>Support this project with your organization. Your logo will show up here with a link to your website. [<a href="https://opencollective.com/casljs/contribute">Contribute</a>]</p>
<p><a href="https://opencollective.com/casljs/organization/0/website"><img src="https://opencollective.com/casljs/organization/0/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/1/website"><img src="https://opencollective.com/casljs/organization/1/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/2/website"><img src="https://opencollective.com/casljs/organization/2/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/3/website"><img src="https://opencollective.com/casljs/organization/3/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/4/website"><img src="https://opencollective.com/casljs/organization/4/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/5/website"><img src="https://opencollective.com/casljs/organization/5/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/6/website"><img src="https://opencollective.com/casljs/organization/6/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/7/website"><img src="https://opencollective.com/casljs/organization/7/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/8/website"><img src="https://opencollective.com/casljs/organization/8/avatar.svg"></a>
<a href="https://opencollective.com/casljs/organization/9/website"><img src="https://opencollective.com/casljs/organization/9/avatar.svg"></a></p>
<h2 id="license">License</h2>
<p><a href="http://www.opensource.org/licenses/MIT">MIT License</a></p>
<p>Copyright (c) 2017-present, Sergii Stotskyi</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-863c9d61ac19dc6660ef85ab789f133a">1 - 指南</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9d064ae46378a7ea4cd8395fa6f188b4">1.1 - 安装</h1>
    
	<h2 id="需求">需求</h2>
<p>CASL 是同构的，所以可以在浏览器和 Nodejs 环境中使用。
它需要 ES5 兼容环境和 ES6 的“Map”类，这意味着最低支持的 ie 版本是 IE11，最低的 Nodejs 版本是 8.x。
但我们强烈建议使用最新的 Node.js 环境和浏览器，因为他们的 JS VM 工作得更快。</p>
<p>此外，' @casl/vue &lsquo;和&rsquo; @casl/aurelia &lsquo;使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">ES6 WeakMap</a>，所以它需要 polyfill 或更新版本的浏览器。</p>
<h2 id="语义版本控制">语义版本控制</h2>
<p>CASL 在其所有官方项目中遵循<a href="https://semver.org/">语义版本管理</a>。
可以在<a href="https://github.com/stalniy/casl/releases">发布说明</a>或每个包中的&rsquo; CHANGELOG.md &lsquo;文件中找到更改。</p>
<h2 id="官方软件包及其版本">官方软件包及其版本</h2>
<table>
<thead>
<tr>
<th>Project</th>
<th>Status</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../intro">@casl/ability</a></td>
<td><a href="https://www.npmjs.com/package/@casl/ability"><img src="https://img.shields.io/npm/v/@casl/ability.svg" alt="@casl/ability-status"></a></td>
<td>CASL&rsquo;s core package</td>
</tr>
<tr>
<td><a href="../../package/casl-mongoose">@casl/mongoose</a></td>
<td><a href="https://www.npmjs.com/package/@casl/mongoose"><img src="https://img.shields.io/npm/v/@casl/mongoose.svg" alt="@casl/mongoose-status"></a></td>
<td>integration with <a href="http://mongoosejs.com/">Mongoose</a></td>
</tr>
<tr>
<td><a href="../../package/casl-prisma">@casl/prisma</a></td>
<td><a href="https://www.npmjs.com/package/@casl/prisma"><img src="https://img.shields.io/npm/v/@casl/prisma.svg" alt="@casl/prisma-status"></a></td>
<td>integration with <a href="https://www.prisma.io/">Prisma</a></td>
</tr>
<tr>
<td><a href="../../package/casl-angular">@casl/angular</a></td>
<td><a href="https://www.npmjs.com/package/@casl/angular"><img src="https://img.shields.io/npm/v/@casl/angular.svg" alt="@casl/angular-status"></a></td>
<td>integration with <a href="https://angular.io/">Angular</a></td>
</tr>
<tr>
<td><a href="../../package/casl-react">@casl/react</a></td>
<td><a href="https://www.npmjs.com/package/@casl/react"><img src="https://img.shields.io/npm/v/@casl/react.svg" alt="@casl/react-status"></a></td>
<td>integration with <a href="https://reactjs.org/">React</a></td>
</tr>
<tr>
<td><a href="../../package/casl-vue">@casl/vue</a></td>
<td><a href="https://www.npmjs.com/package/@casl/vue"><img src="https://img.shields.io/npm/v/@casl/vue.svg" alt="@casl/vue-status"></a></td>
<td>integration with <a href="https://vuejs.org">Vue</a></td>
</tr>
<tr>
<td><a href="../../package/casl-aurelia">@casl/aurelia</a></td>
<td><a href="https://www.npmjs.com/package/@casl/aurelia"><img src="https://img.shields.io/npm/v/@casl/aurelia.svg" alt="@casl/aurelia-status"></a></td>
<td>integration with <a href="http://aurelia.io">Aurelia</a></td>
</tr>
</tbody>
</table>
<h2 id="第三方包">第三方包</h2>
<p>我们也可以在我们的项目中使用第三方包。
要找到它们，只需<a href="https://www.npmjs.com/search?q=keywords:casl">使用“casl”关键字在 NPM 上搜索</a></p>
<blockquote>
<p>在<a href="https://docs.npmjs.com/cli/v7/configuring-npm/package-json#keywords">package.json#keywords</a>数组中添加“casl”，以显示基于 casl 的包在该列表中</p>
</blockquote>
<h2 id="npm-yarn-pnpm">NPM, YARN, PNPM</h2>
<p>通过包管理器安装是推荐的 CASL 安装方式。
要安装最新的稳定版本，请运行:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install @casl/ability
<span style="color:#8f5902;font-style:italic"># or</span>
yarn add @casl/ability
<span style="color:#8f5902;font-style:italic"># or</span>
pnpm add @casl/ability
</code></pre></div><h2 id="cdn">CDN</h2>
<p>为了进行原型设计或学习，你可以使用最新的版本:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@casl/ability&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><p>对于产品，我们建议链接到一个特定的版本号，以避免来自新版本的意外破坏:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@casl/ability@5.1.0&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><p>记住，CASL 依赖于<a href="https://www.npmjs.com/package/@ucast/mongo">@ucast/mongo2js</a>，而<a href="https://www.npmjs.com/package/@ucast/core">@ucast/core</a>， <a href="https://www.npmjs.com/package/@ucast/js">@ucast/js</a>和<a href="https://www.npmjs.com/package/@ucast/mongo">@ucast/mongo</a>，这就是为什么你需要在&rsquo; @casl/ability &lsquo;之前指定所有这些库:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@ucast/core&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@ucast/mongo&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@ucast/js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@ucast/mongo2js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@casl/ability&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><h2 id="下载和使用-ltscriptgt-标签">下载和使用 &lt;script&gt; 标签</h2>
<p>只需<a href="https://cdn.jsdelivr.net/npm/@casl/ability">从 CDN 下载 CASL</a>并包含一个脚本标记。
' casl &lsquo;将被注册为一个全局变量。</p>
<blockquote>
<p>希望你知道自己在做什么</p>
</blockquote>
<h2 id="不同构建的解释">不同构建的解释</h2>
<p>In the <code>dist/</code> <a href="https://cdn.jsdelivr.net/npm/@casl/ability/dist/">directory of the NPM package</a> you will find many different builds of CASL.js.
Here’s an overview of the difference between them:</p>
<table>
<thead>
<tr>
<th>Build</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>es6m/index.mjs</td>
<td>minified ES6 code with ES modules support.</td>
</tr>
<tr>
<td>Intended for bundlers (e.g., <a href="https://rollupjs.org/guide/en/">rollup</a>, <a href="https://webpack.js.org/">webpack</a>) to create bundle for modern browsers or modern Nodejs version that support ES modules</td>
<td></td>
</tr>
<tr>
<td>es6c/index.js</td>
<td>minified ES6 code with Commonjs modules support.</td>
</tr>
<tr>
<td>Intended for modern nodejs environments that support ES6 but doesn&rsquo;t support ES modules</td>
<td></td>
</tr>
<tr>
<td>es5m/index.js</td>
<td>minified ES5 code with ES modules support.</td>
</tr>
<tr>
<td>Should be used by bundlers (e.g., <a href="https://rollupjs.org/guide/en/">rollup</a>, <a href="https://webpack.js.org/">webpack</a>) to tree shake the module and skip babel&rsquo;s transpile process</td>
<td></td>
</tr>
<tr>
<td>umd/index.js</td>
<td><strong>deprecated</strong>, minified ES5 code with UMD.</td>
</tr>
<tr>
<td>Intended for AMD apps and simple prototypes in a browser</td>
<td></td>
</tr>
<tr>
<td>types</td>
<td>contains <a href="http://www.typescriptlang.org/">typescript</a> type declaration files</td>
</tr>
</tbody>
</table>
<p>All official packages has the same directory layout (except of <code>@casl/mongoose</code> which does not have es5m version and packages that integrate CASL with UI frameworks which don&rsquo;t have es6c version).</p>
<h2 id="webpack">Webpack</h2>
<p>Webpack 在严格的模式下运行 ESM JavaScript。
问题是 webpack4 只读取&rsquo; package.json &lsquo;的&rsquo; main &lsquo;属性，而忽略&rsquo; resolve.mainFields &lsquo;中的其他所有内容。
所有 casl 相关的包，包括 ucast，在&rsquo; main &lsquo;属性中分发 CommonJS 文件。
这就导致了下一个问题</p>
<blockquote>
<p>ERROR in ./node_modules/@casl/ability/dist/es6m/index.mjs
Can&rsquo;t import the named export &lsquo;xxx&rsquo; from non EcmaScript module (only default export is available)</p>
</blockquote>
<p>The best way to fix it is to upgrade to webpack 5 which reads <code>exports</code> property of package.json when import packages and properly and works with ESM imports.
But if you stuck with webpack 4, read <a href="https://github.com/stalniy/casl/issues/427#issuecomment-757539486">this comment</a> for possible workarounds.</p>
<h2 id="csp-环境">CSP 环境</h2>
<p>一些环境，如谷歌 Chrome 应用程序，强制内容安全策略(CSP)，禁止使用“new Function()”来计算表达式。</p>
<p>CASL 不使用任何被禁止的函数，因此可以在任何环境中使用它。</p>
<h2 id="开发构建">开发构建</h2>
<p><strong>Important</strong>: GitHub ' /dist &lsquo;文件夹中的构建文件在发布期间不会签入。要从 GitHub 上最新的源代码中使用 CASL，您必须自己构建它!导航你的项目根目录并运行:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git clone git@github.com:stalniy/casl.git
<span style="color:#204a87">cd</span> casl
pnpm i -r
<span style="color:#204a87">cd</span> packages/casl-ability
npm run build
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c08345e7a1a6422ae94efe2cdf79b2e4">1.2 - 介绍</h1>
    
	<p><a href="https://badge.fury.io/js/%40casl%2Fability"><img src="https://badge.fury.io/js/%40casl%2Fability.svg" alt="@casl/ability NPM version"></a>
<a href="https://www.npmjs.com/package/%40casl%2Fability"><img src="https://img.shields.io/npm/dm/%40casl%2Fability.svg" alt=""></a>
<a href="https://gitter.im/stalniy-casl/casl"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="CASL Join the chat"></a></p>
<h2 id="什么是-casl">什么是 CASL?</h2>
<p>CASL (pronounced /ˈkæsəl/, like <strong>castle</strong>) is an isomorphic authorization JavaScript library which restricts what resources a given client is allowed to access. It&rsquo;s designed to be incrementally adoptable and can easily scale between a simple claim based and fully featured subject and attribute based authorization. It makes it easy to manage and share permissions across UI components, API services, and database queries.</p>
<blockquote>
<p>CASL implements <a href="https://en.wikipedia.org/wiki/Attribute-based_access_control">Attribute Based Access Control</a></p>
</blockquote>
<h2 id="入门">入门</h2>
<p>The easiest way to try out CASL.js is using the <a href="https://codesandbox.io/s/github/stalniy/casl-examples/tree/master/packages/hello-world">Hello World example</a>. Feel free to open it in another tab and follow along as we go through some basic examples. Alternatively you can create Nodejs project and install <code>@casl/ability</code> as a dependency.</p>
<blockquote>
<p>The <a href="../install">Installation page</a> provides more options of installing CASL.</p>
</blockquote>
<h2 id="基本">基本</h2>
<p>CASL operates on the abilities level, that is what a user can actually do in the application. An ability itself depends on the 4 parameters (last 3 are optional):</p>
<ol>
<li><strong>User Action</strong><br>
Describes what user can actually do in the app. User action is a word (usually a verb) which depends on the business logic (e.g., <code>prolong</code>, <code>read</code>). Very often it will be a list of words from CRUD - <code>create</code>, <code>read</code>, <code>update</code> and <code>delete</code>.</li>
<li><strong>Subject</strong><br>
The subject or subject type which you want to check user action on. Usually this is a business (or domain) entity (e.g., <code>Subscription</code>, <code>Article</code>, <code>User</code>). The relation between subject and subject type is the same as relation between an object instance and its class.</li>
<li><strong>Fields</strong><br>
Can be used to restrict user action only to matched subject&rsquo;s fields (e.g., to allow moderator to update <code>status</code> field of an <code>Article</code> and disallow to update <code>description</code> or <code>title</code>)</li>
<li><strong>Conditions</strong><br>
Criteria which restricts user action only to matched subjects. This is useful when you need to give a permission on specific subjects (e.g., to allow user to manage own <code>Article</code>)</li>
</ol>
<p>At the core of CASL is a system that enables us to declaratively define and check user permissions using clear javascript syntax:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><blockquote>
<p>CASL has sophisticated support for TypeScript but in this guide we will use JavaScript for the purpose of ease. See <a href="../../advanced/typescript">CASL TypeScript</a> for details</p>
</blockquote>
<p>In the example above, we have just defined an <code>Ability</code> instance which permits doing anything in the app except for deleting users. As you probably guessed, <code>can</code> and <code>cannot</code> accept the same arguments but have different meanings: <code>can</code> permits an action on the specified subject and <code>cannot</code> forbids it. Both may accept up to 4 arguments (in exactly the same order as listed in <a href="#basics">concepts section</a>). In this case, <code>manage</code> and <code>delete</code> are user actions and <code>all</code> and <code>User</code> are subjects.</p>
<blockquote>
<p><code>manage</code> and <code>all</code> are special keywords in CASL. <code>manage</code> represents any action and <code>all</code> represents any subject.</p>
</blockquote>
<p>Now let&rsquo;s try to check permissions</p>
<div class="highlight" data-filename="app.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility.js&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>In the example above, the <code>Ability</code> instance allows us to check permissions in a pretty readable way. By the way, all these examples demonstrate checking permissions based on a subject type (i.e. an object type or class), but CASL really shines when you need to restrict objects based on their attributes (i.e. properties).</p>
<h2 id="条件">条件</h2>
<p>The most common requirement for mid-sized apps is the ability to limit users so that they can perform actions only on their own resources. CASL allows us to do this by passing an object of conditions as the 3rd argument to <code>can</code> and <code>cannot</code> methods on the definition step.</p>
<p>Before diving into the details, let&rsquo;s first consider requirements for the permissions of a blog website. In such a blog, a user</p>
<ul>
<li>can <code>read</code> any <code>Article</code></li>
<li>can <code>update</code> own <code>Article</code>&rsquo;s</li>
<li>can <code>create</code> a <code>Comment</code> for any Article</li>
<li>can <code>update</code> own <code>Comment</code></li>
</ul>
<p>Let&rsquo;s translate this to CASL:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span>
  <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isLoggedIn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
      <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Do you see how real business requirements are easily translated to code? Now let&rsquo;s check them!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#39;./defineAbility&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#8f5902;font-style:italic">/* intentionally not defined */</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>As you see, you can do checks on the subject the same way you do it on the subject&rsquo;s type! But what does the <code>article</code> variable hold inside? How does CASL know the subject type of the object referenced by this variable?</p>
<p>Do you remember that a subject and its type belong to each other in the same way as an object instance and its class? CASL remembers this as well and retrieves <code>article.constructor.name</code> as its subject type.</p>
<blockquote>
<p>Classes are natural in backend but not always makes sense in frontend development. CASL supports other ways to detect subject type, see <a href="../subject-type-detection">Subject type detection</a> for details.</p>
</blockquote>
<p>Let&rsquo;s get back to our example and define classes for <code>Article</code> and <code>Comment</code> entities:</p>
<div class="highlight" data-filename="entities.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Entity</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attrs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attrs</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Entity</span> <span style="color:#000;font-weight:bold">{}</span>
</code></pre></div><p>And this is how the example with missed <code>article</code> variable looks eventually:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// user can read any article
</span></code></pre></div><p>And few more examples just to get familiar with:</p>
<div class="highlight" data-filename="app.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isLoggedIn</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ownArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">anotherArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">anotherArticle</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false, we can&#39;t update articles which were not written by us
</span></code></pre></div><blockquote>
<p>Despite the fact that <code>can</code> and <code>cannot</code> functions in <code>defineAbility</code> callback are similar to <code>can</code> and <code>cannot</code> methods of <code>Ability</code> class, they have completely different purposes and accept different arguments. See <a href="../../cookbook/less-confusing-can-api">Make <code>can</code> API less confusing</a> if it confuses you.</p>
</blockquote>
<p><strong>Pay attention</strong> that conditions object contains the same keys as the entity we want to check. This is how CASL matches entities by conditions. In our case, it just checks that <code>authorId</code> in <code>Article</code> instance equals to <code>authorId</code> in conditions object. Conditions may have several fields, in that case all fields should match (<code>AND</code> logic).</p>
<p>But conditions are not restricted to simple equality checks! Thanks to <a href="https://github.com/stalniy/ucast">ucast</a> <code>Ability</code> instances can match objects using <a href="http://docs.mongodb.org/manual/reference/operator/query/">MongoDB query language</a>.</p>
<blockquote>
<p>If you are not familiar with MongoDB query language, see <a href="../conditions-in-depth">CASL conditions in depth</a> for details</p>
</blockquote>
<p>You can define the same pair of action and subject with different conditions multiple times. For example, let&rsquo;s allow our blog users to share drafts and publish articles:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sharedWith</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>In such case, the pair of action/subject rules are combined by logical <code>OR</code>. More formally, this can be translated as &ldquo;users can read Article if it&rsquo;s published OR users can read Article if it&rsquo;s not published AND shared with them&rdquo;.</p>
<p>But that&rsquo;s not all, if you need more granular permission checks, you can define them on subject&rsquo;s attributes (i.e., fields)!</p>
<h2 id="fields">Fields</h2>
<p>Sometimes you may need to restrict which fields a user can access. For example, let&rsquo;s allow only moderators to publish <code>Article</code>:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span>
  <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isModerator</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">]);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Here we defined that any user can update <code>title</code> and <code>description</code> fields of their own <code>Article</code>s and only moderators can update <code>published</code> field.</p>
<blockquote>
<p>If fields are not specified, a user is allowed to access any field.</p>
</blockquote>
<p>To check permissions use the same <code>can</code> and <code>cannot</code> methods of <code>Ability</code> instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">moderator</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isModerator</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ownArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">moderator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">foreignArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">moderator</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">foreignArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span></code></pre></div><blockquote>
<p>For more complex cases, you can use nested fields and wildcards, see <a href="../restricting-fields">Restricting field access</a> for details</p>
</blockquote>
<h2 id="检查逻辑">检查逻辑</h2>
<p>Let&rsquo;s consider a simple example where user can publish articles:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// (1)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;do&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;SomethingUndeclared&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// (2)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// (3)
</span></code></pre></div><p>Line <code>(1)</code> returns <code>true</code> as we expected. Line <code>(2)</code> return <code>false</code> because for any unknown subject or action CASL returns <code>false</code>, by default everything is forbidden (if <code>manage</code> and <code>all</code> keywords are not used). But what would you expect line <code>(3)</code> to return? The answer may be unexpected for some of you, it returns <code>true</code> as well. <strong>Why?!</strong></p>
<p>Let&rsquo;s get back to our experience for a while. Historically, majority of permissions management libs were built on top of roles or flags. So, a user either has permission or not. This can be expressed in pseudo code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read_article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update_article&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>This is interpreted as &ldquo;user can read ALL articles and user can update ALL articles&rdquo;. So, this is &ldquo;all or nothing&rdquo; mindset.</p>
<p><strong>But CASL is different!</strong> It allows us to ask different questions to our permissions. So, when you check on a</p>
<ul>
<li>subject, you ask &ldquo;can I read THIS article?&rdquo;</li>
<li>subject type, you ask &ldquo;can I read SOME article?&rdquo; (i.e., at least one article)</li>
</ul>
<p>It&rsquo;s very useful when you don&rsquo;t have an instance to check but know its type (for example, during creation), so this allows your app to fail fast.</p>
<blockquote>
<p>If you do checks on a subject type, you need to check permissions one more time on the final subject, right before sending request to API or database.</p>
</blockquote>
<h2 id="反向规则">反向规则</h2>
<p>This guide talk a lot about allowable permissions but nothing about disallowable ones. This is for the reason. The direct logic is much simpler to understand, and we recommend to use it whenever possible.</p>
<p>To define an inverted rule, you need to use the 2nd argument in the callback of <code>defineAbility</code>. Let&rsquo;s give a user a permission to do anything but not delete:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span></code></pre></div><p>As you should know direct rules are checked by logical <code>OR</code> on the other hand inverted ones are checked by logical <code>AND</code>. So, in the example above user:</p>
<ul>
<li>can do anything on all entities</li>
<li>and cannot delete any entity</li>
</ul>
<p>When defining direct and inverted rules for the same pair of action and subject the order of rules matters: <code>cannot</code> declarations should follow after <code>can</code>, otherwise they will be overridden by <code>can</code>. For example, let&rsquo;s disallow to read all private objects (those that have property <code>private = true</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// true!
</span></code></pre></div><p>Here we got an unexpected result because direct rule is the last one. To fix the result just revert those rules and <strong>always remember to put inverted rules after the direct one!</strong></p>
<h3 id="禁止的原因">禁止的原因</h3>
<p>The good point about inverted rules is that they help to explicitly forbid particular actions. Moreover they allow to add explanation. Let&rsquo;s see how</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">because</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You are not allowed to read private information&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>We can get this message back by checking permissions using <code>ForbiddenError</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// You are not allowed to read private information
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>To learn more about <code>ForbiddenError</code>, see <a href="../../api#forbidden-error">ForbiddenError API</a></p>
</blockquote>
<h2 id="更新规则">更新规则</h2>
<p>Sometimes, especially in frontend application development, we need to update <code>Ability</code> instance&rsquo;s rules (e.g., on login or logout). To do this, we can use <code>update</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">([]);</span> <span style="color:#8f5902;font-style:italic">// forbids everything
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#8f5902;font-style:italic">// switch to readonly mode
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;all&#34;</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>
</code></pre></div><p>Also we can use <code>AbilityBuilder</code> to create rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>To track when rules are updated, we can subscribe to <code>update</code> (before ability is updated) or <code>updated</code> (after ability is updated) events of <code>Ability</code> instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">unsubscribe</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">({</span> <span style="color:#000">rules</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">target</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `rules` is an array passed to `update` method
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `target` is an Ability instance that triggered event
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">unsubscribe</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// removes subscription
</span></code></pre></div><h2 id="还有什么">还有什么?</h2>
<p>CASL does not have a concept of &ldquo;a role&rdquo; and this makes it very powerful! As CASL allows to describe user abilities in your application, you can use it to:</p>
<ol>
<li>Implement <a href="https://en.wikipedia.org/wiki/Feature_toggle">feature toggles</a><br>
Hide unfinished feature or show it to beta testers only.</li>
<li>Conduct <a href="https://en.wikipedia.org/wiki/A/B_testing">A/B testing</a><br>
Based on age, region, country or whatever hide features for some users and show for others</li>
<li>Simple Business Logic<br>
Disallow users to watch video if their subscription has been expired</li>
</ol>
<blockquote>
<p>See <a href="../../cookbook/roles-with-static-permissions">Roles with predefined permissions</a> for details.</p>
</blockquote>
<h2 id="准备好了">准备好了?</h2>
<p>我们已经简要介绍了 CASL.js 核心的所有特性——本指南的其余部分将涵盖它们和其他高级特性，并提供更详细的细节，所以请务必通读全文!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-51a9859bc2f83b67fa71be170d88d343">1.3 - 定义规则</h1>
    
	<p>There are 3 ways you can define abilities:</p>
<ul>
<li>using <code>defineAbility</code> function</li>
<li>using <code>AbilityBuilder</code> class</li>
<li>using <code>JSON</code> objects</li>
</ul>
<p>In order to understand which way to use, let&rsquo;s learn more about each one.</p>
<h2 id="defineability-function">defineAbility function</h2>
<p>This function is a <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> that allows to create <code>Ability</code> instance using <code>can</code> and <code>cannot</code> methods. It allows to define and use <code>Ability</code> instance without writing too much code.</p>
<h3 id="defineability-example">defineAbility example</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>You can pass multiple actions, subjects and fields in the single <code>can</code> (or <code>cannot</code>) function. So, instead of</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>you can do:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><blockquote>
<p>To learn more about <code>can</code> and <code>cannot</code> functions' parameters, read <a href="../../api#abilitybuilder">AbilityBuilder API</a></p>
</blockquote>
<h3 id="when-to-use-defineability">When to use defineAbility</h3>
<ul>
<li>unit tests</li>
<li>examples and learning resources</li>
<li>prototypes or really simple applications</li>
</ul>
<p>So, to keep examples simple and clear, we will use <code>defineAbility</code> in majority of code snippets in this documentation.</p>
<h3 id="why-defineability-is-not-recommended">Why defineAbility is not recommended</h3>
<p>There is nothing extremely wrong with this function but there are several drawbacks when you use it in your app:</p>
<ol>
<li>In most cases, rules depends on user request, so using callback style to define permissions, adds additional nesting and increases cognitive complexity.</li>
<li>It can create only <code>Ability</code> instance which works with <a href="../conditions-in-depth">MongoDB conditions</a>, so you won&rsquo;t be able to use another language to match conditions.</li>
</ol>
<blockquote>
<p>See <a href="../../advanced/customize-ability">Customize Ability</a> to know more about different ability classes and possibilities to customize it.</p>
</blockquote>
<h2 id="abilitybuilder-class">AbilityBuilder class</h2>
<p>This class implements <code>can</code> and <code>cannot</code> functions, that makes possible to write rules using <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> syntax. <strong>This is the recommended way to define rules using DSL syntax</strong></p>
<h3 id="abilitybuilder-example">AbilityBuilder example</h3>
<p><a href="#defineability-example">defineAbility example</a> written using <code>AbilityBuilder</code> class looks a bit more wordy:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>But it allows to define rules without additional nesting, this is especially important when you build rules based on conditional logic:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isAdmin</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// read-write access to everything
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// read-only access to everything
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>To learn more about <code>can</code> and <code>cannot</code> functions' parameters, read <a href="../../api#abilitybuilder">AbilityBuilder API</a></p>
</blockquote>
<p>For more advanced cases, it&rsquo;s possible to use <code>rules</code> property of <code>AbilityBuilder</code> and create <code>Ability</code> instance manually:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// defined permissions
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="when-to-use-abilitybuilder">When to use AbilityBuilder</h3>
<ul>
<li>in apps which have static permissions (i.e., permissions are not changed by admin user but defined inside system)</li>
<li>anywhere where you use custom subclasses of <code>PureAbility</code></li>
</ul>
<blockquote>
<p>See <a href="../../advanced/customize-ability">Customize Ability</a> to learn more about <code>PureAbility</code> class.</p>
</blockquote>
<h2 id="json-objects">JSON objects</h2>
<p>It&rsquo;s not required to use <code>AbilityBuilder</code> to define rules in the app, especially if your rules are dynamic (i.e., stored in database or managed by admin users). In such cases, the preferred way is to use <code>JSON</code> objects. You can directly pass array of <code>JSON</code> rules into <code>Ability</code> constructor. Such rules are called raw rules</p>
<blockquote>
<p>you can read more about TypeScript types and their shapes in <a href="../../advanced/typescript">TypeScript Support</a></p>
</blockquote>
<h3 id="json-objects-example">JSON objects example</h3>
<p>The same example using <code>JSON</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">inverted</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">conditions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>
</code></pre></div><p>Pay attention to the <code>inverted</code> field, it indicates that a rule is an inverted one (i.e., forbids something).</p>
<h3 id="the-shape-of-raw-rule">The shape of raw rule</h3>
<p>The simplified version (without generics) of raw rule shape in <a href="http://www.typescriptlang.org/">TypeScript</a> looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RawRule</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">action</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#000">subject?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#8f5902;font-style:italic">/** an array of fields to which user has (or not) access */</span>
  <span style="color:#000">fields?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#8f5902;font-style:italic">/** an object of conditions which restricts the rule scope */</span>
  <span style="color:#000">conditions?</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#8f5902;font-style:italic">/** indicates whether rule allows or forbids something */</span>
  <span style="color:#000">inverted?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#8f5902;font-style:italic">/** message which explains why rule is forbidden */</span>
  <span style="color:#000">reason?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Don&rsquo;t worry if you are not familiar with TypeScript, you still have time to learn it ;) Kidding, or not?</p>
<p>In the example above, <code>?</code> after field name means optional field, so everything is optional except <code>action</code>. <code>string[]</code> means an array of strings and <code>string | string[]</code> means either regular <code>string</code> or an array of strings. Now you know almost everything about TypeScript, do not thank :)</p>
<h3 id="when-to-use-json-objects">When to use JSON objects</h3>
<ul>
<li>in apps, that have dynamic permissions (i.e., permissions are changed by admin user)</li>
<li>in apps, that receive permissions via network layer (e.g., single page applications or microservices)</li>
<li>to make the app&rsquo;s bundle size smaller (if you don&rsquo;t use <code>AbilityBuilder</code> or <code>defineAbility</code>, they can be shook out by bundlers such as <a href="https://rollupjs.org/guide/en/">rollup</a> or <a href="https://webpack.js.org/">webpack</a>)</li>
</ul>
<p>Now, as we know all possible ways to define rules, let&rsquo;s dive deeper into <code>can</code> and <code>cannot</code> methods.</p>
<h2 id="rules">Rules</h2>
<p>You can define as much rules as you need, CASL builds an index under the hood to keep checking logic fast. So, don&rsquo;t worry about performance.</p>
<p>You can define the same pair of action and subject with different conditions multiple times. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;review&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>In such case, the pair of action/subject rules are combined by logical <code>OR</code>. More formally this can be translated as &ldquo;users can read Article if it&rsquo;s published OR users can read Article if it&rsquo;s not published AND in review status&rdquo;.</p>
<p>But be careful, because <code>OR</code> logic returns <code>true</code> if one of its expressions are <code>true</code>, so the next code will always return <code>true</code>, even for articles that were not published:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// (2)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>More formally this code can be read as &ldquo;can read any article OR can read published articles&rdquo;. As you see, the first statement always valid, so the <code>(2)</code> <code>can</code> with conditions has no effect.</p>
<p>It&rsquo;s also possible to restrict scope of direct rule with the inverted one for the same pair of action and subject. In such case, inverted rules are combined with direct ones by logical <code>AND</code>.</p>
<p>Let&rsquo;s change the example above to disallow reading unpublished articles:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// direct rule
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// inverted rule
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This is read as &ldquo;can read any article AND cannot read unpublished articles&rdquo;.</p>
<h3 id="inverted-rules-order">Inverted rules order</h3>
<p>It is important that in the example above <code>cannot read article unpublished</code> line comes after the <code>can read article</code> line. If they were reversed, <code>cannot read article unpublished</code> would be overridden by <code>can read article</code>.</p>
<blockquote>
<p>The rule of thumb is to define general rules first and more specific after general ones.</p>
</blockquote>
<p>It was done so in order to be able to override inverted rules by regular ones.</p>
<h3 id="best-practice">Best practice</h3>
<p>Direct logic is easier to reason about for human mind, so use direct rules as much as possible! Moreover, this allows to keep permissions clean, more readable and reduces the risk of giving wrong permissions to the wrong users.</p>
<blockquote>
<p>You can remember this rule as: <strong>Give permissions, don&rsquo;t take them away</strong></p>
</blockquote>
<p>So, are there a valid usecases for inverted rules? <strong>Yes</strong>! They work very well when are not combined with regular rules and defined explicitly to express why particular action on particular subject was forbidden, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">hasPaidSubscription</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hasPaidSubscription</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">hasPaidSubscription</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;BlogPost&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;BlogPost&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">because</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You have not paid for monthly subscription&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-649681944f858128de1b5f1a01c61b2f">1.4 - 深度条件下</h1>
    
	<p>Thanks to <a href="https://github.com/stalniy/ucast">ucast</a>, we can define permissions using <a href="http://docs.mongodb.org/manual/reference/operator/query/">MongoDB query language</a>.</p>
<p>Don&rsquo;t worry, if you are not familiar with MongoDB query language. We will go through some of its operators in this guide. But before we start, let&rsquo;s see how useful it may be by creating simple article scheduling logic, that allows to read articles only if their <code>createdAt</code> is in the past:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">today</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">setHours</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">createdAt</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$lte</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">today</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Or let&rsquo;s allow to read articles that are in <code>review</code> or <code>published</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Do you see the power it brings?</p>
<h2 id="mongodb-and-its-query-language">MongoDB and its query language</h2>
<p><a href="https://www.mongodb.com/">MongoDB</a> is a general purpose, document-based, distributed database built for modern applications and for the cloud era. In simple words, this is a <a href="https://en.wikipedia.org/wiki/NoSQL">NoSQL</a> database that stores records in <code>JSON</code> (actually in <a href="https://docs.mongodb.com/manual/reference/glossary/#term-bson">BSON</a>) format.</p>
<p>As they decided to store records in <code>JSON</code>, they needed a new query language that would allow to get filtered records from their database. This is how they created own query language.</p>
<p>JavaScript is a superset of <code>JSON</code>, that&rsquo;s why we decided to use MongoDB query language to restrict permissions for subjects based on their properties.</p>
<p><strong>You don&rsquo;t need to know anything about MongoDB</strong> in order to use CASL, you need to know only subset of its query language operators.</p>
<p>Query is what you pass in conditions to <code>can</code> and <code>cannot</code> functions (3rd or 4th argument if you pass fields). So, it&rsquo;s an object which defines restrictions on a JavaScript object and if that restrictions are matched then a matched object is returned.</p>
<p>Let&rsquo;s see at examples of queries:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queries</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// (1)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hidden</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// (2)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$exists</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;inProgress&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">price</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$gte</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$lte</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// (3)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">tags</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$all</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;permission&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;casl&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$regex</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">/@gmail.com$/i</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;cities.address&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$elemMatch</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">postalCode</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$regex</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">/^AB/</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// (4)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">];</span>
</code></pre></div><p>We can combine any amount of fields inside single query, all their restrictions are tested according to <code>AND</code> logic. If we do not specify operator, the query uses <code>$eq</code> operator (equality operator). So, a query like <code>(2)</code> matches objects if their <code>private</code> and <code>hidden</code> property values equal to <code>false</code> (i.e., <code>!object.private &amp;&amp; !object.hidden</code>).</p>
<p>We can specify multiple operators for the same field, in this case each operator must return <code>true</code> to match a field value. So, <code>(3)</code> matches objects only if <code>price</code> property value is between 10 and 50 inclusively (i.e., <code>object.price &gt;= 10 &amp;&amp; object.price &lt;= 50</code>).</p>
<p>To access nested property value, you can use dot notation as in <code>(4)</code>.</p>
<h2 id="supported-operators">Supported operators</h2>
<p>CASL uses only subset of MongoDB operators which cover majority of cases.</p>
<blockquote>
<p>If you need to use more operators or define custom ones, read <a href="../../advanced/customize-ability">Customize ability</a></p>
</blockquote>
<p>The list of operators:</p>
<ol>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/eq">$eq</a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/ne">$ne</a><br>
object value should equal specified value. <code>$ne</code> means <code>not $eq</code></li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/lt">$lt</a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/lte">$lte</a><br>
object value should be less than specified value. Can be used for <code>Date</code>s, numbers and strings. <code>$lte</code> is a combination of <code>$lt</code> and <code>$eq</code>, so it&rsquo;s an inclusive check.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/gt">$gt</a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/gte">$gte</a><br>
object value should be greater than specified value. Can be used for <code>Date</code>s, numbers and strings. <code>$gte</code> is a combination of <code>$gt</code> and <code>$eq</code>, so it&rsquo;s an inclusive check.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/in">$in</a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/nin">$nin</a><br>
Checks that object&rsquo;s property is of the specified array values. Can be used for single value and for arrays as well. If object&rsquo;s property is an array it checks for intersection. <code>$nin</code> means <code>not $in</code></li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/all">$all</a><br>
Checks that object&rsquo;s property should contain all elements from the specified array. Can be used for arrays only.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/size">$size</a><br>
Checks that array length equals to specified value. Can be used for arrays only</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/regex">$regex</a><br>
Allows to test object&rsquo;s property value using <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expression</a>. Can be used for strings only</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/exists">$exists</a><br>
Checks that property exists in the object.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/elemMatch">$elemMatch</a><br>
Checks nested elements shape. Use <code>$elemMatch</code> operator to specify multiple criteria on the elements of an array such that at least one array element satisfies all the specified criteria. If you specify only a single condition in the <code>$elemMatch</code> expression, <code>$elemMatch</code> is not necessary. See <a href="https://docs.mongodb.com/manual/tutorial/query-arrays/#specify-multiple-criteria-for-array-elements">Specify Multiple Conditions for Array Elements</a> for details.</li>
</ol>
<h2 id="why-logical-query-operators-are-not-included">Why logical query operators are not included</h2>
<p>CASL doesn&rsquo;t use <code>$and</code>, <code>$or</code>, <code>$nor</code> and <code>$not</code> operators. This is because the same behavior can be achieved by combining <code>can</code> and <code>cannot</code> rules. Combination of <code>can</code> rules for the same pair of action and subject allows to mimic <code>$or</code> operator and combination of <code>cannot</code> rules allows to mimic <code>$not</code> and <code>$and</code> operators. Moreover as we discussed in this guide, all properties inside conditions object are checked by <code>AND</code> logic, this is another way to mimic <code>$and</code> operator.</p>
<p><code>$nor</code> cannot be reproduced in any way, so if you are sure that you need it, I&rsquo;d recommend to rethink your permission logic together with the client or product owner. But if you are 100% sure, please read how to <a href="../../advanced/customize-ability">Customize ability</a>.</p>
<h2 id="checking-logic-in-casl">Checking logic in CASL</h2>
<p>When you define rules with conditions, the last are converted to functions that checks whether object matches specified MongoDB query. Let&rsquo;s see an example:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defaultAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defaultAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">createdAt</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$lte</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>The example above says that article can be read if it&rsquo;s in review or published and its creation date is in the past or today. Before starting let&rsquo;s define simple class that represents <code>Article</code> entity.</p>
<div class="highlight" data-filename="entities.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createdAt</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createdAt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createdAt</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>It&rsquo;s not mandatory to use classes, CASL perfectly works with plain javascript objects, see <a href="../subject-type-detection">Subject type detection</a> for details.</p>
</blockquote>
<p>Now we can test which articles user can read:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#39;./defineAbility&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#39;./entities&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">today</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">setHours</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">tomorrow</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#8f5902;font-style:italic">/* logic to calculate date for tomorrow */</span> <span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;review&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">today</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// (1), true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;published&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">today</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// (2), true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;draft&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">today</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// (3), false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;review&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tomorrow</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// (4), false
</span></code></pre></div><p><code>(1)</code> and <code>(2)</code> returns <code>true</code> because article&rsquo;s status is one of the specified and <code>today</code> less then the specified value in conditions.
<code>(3)</code> fails because article&rsquo;s status is not listed inside <code>$in</code> operator and <code>(4)</code> fails because article&rsquo;s <code>createdAt</code> is in future.</p>
<p>The same logic is applicable to other operators in conditions.</p>
<h2 id="common-conditions">Common conditions</h2>
<p>This section describes the way to construct conditions for common cases.</p>
<h3 id="match-one-of-few-items-in-a-scalar-property">Match one of few items in a scalar property</h3>
<p>Suppose we have an <code>Article</code> object which has a property <code>status</code>. We want to restrict the user to access only articles that are in few specific statuses.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;inReview&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h3 id="match-specified-item-in-an-array-property">Match specified item in an array property</h3>
<p>Suppose we have an <code>Article</code> object which has a property <code>categories</code>. We want to restrict the user to access only articles in one specified category.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">categories</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;javascript&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">categories</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">categories</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">categories</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;javascript&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;acl&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h3 id="match-one-of-few-items-in-an-array-property">Match one of few items in an array property</h3>
<p>Suppose we have an <code>Article</code> object which has a property <code>categories</code>. We want to restrict the user to access only articles in few specified categories.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">categories</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;javascript&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;frontend&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">categories</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">categories</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">categories</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;javascript&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;acl&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h3 id="match-nested-property-value">Match nested property value</h3>
<p>Suppose we have an <code>Address</code> object which has property <code>country</code> which is an object of 2 fields: <code>isoCode</code> and <code>name</code>. We want to restrict user to access only those addresses that are located in the specified country.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Address&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;country.isoCode&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;UA&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Address</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isoCode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">country</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">isoCode</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">isoCode</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// const address = new Address(&#39;UA&#39;, &#39;Ukraine&#39;);
</span><span style="color:#8f5902;font-style:italic">// console.log(ability.can(&#39;read&#39;, address)); // true
</span></code></pre></div><h3 id="match-several-properties-of-a-nested-array-property">Match several properties of a nested array property</h3>
<p>Suppose we have a wishlist of products in some e-shop and we want to share wishlist item to somebody else and give him <code>update</code> permission.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;WishlistItem&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">sharedWith</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">$elemMatch</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permission</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">WishlistItem</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sharedWith</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sharedWith</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sharedWith</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">wishlistItem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">WishlistItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL in Action&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permission</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permission</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wishlistItem</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3498bbe7f8714db5f02e2accf63aa843">1.5 - 限制字段访问</h1>
    
	<p>Sometimes you may need to restrict which fields a user can access. For example, let&rsquo;s allow only moderators to publish <code>Article</code>:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isModerator</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now we can check permissions on fields:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">moderator</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isModerator</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">moderator</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p><strong>Be attentive when you define rules for fields with conditions</strong>, the result of the check will be different depending on whether you pass a subject or subject type! To illustrate the difference let&rsquo;s define a simple class:</p>
<div class="highlight" data-filename="entities.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">description</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">authorId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">description</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">description</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authorId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">authorId</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">published</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And let&rsquo;s check permissions:</p>
<div class="highlight" data-filename="app.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ownArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL in Action&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">anotherArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL in Vue apps&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">anotherArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true!
</span></code></pre></div><p>So, the last check returned <code>true</code> and at the first sight it seems wrong! But it&rsquo;s not. Similarly to <a href="../intro#checking-logic">checking logic</a> without fields, we ask different questions:</p>
<ul>
<li>when we check on particular <code>Article</code> instance, we are asking <strong>can user update this article&rsquo;s title</strong></li>
<li>and when we check on subject type, we are asking <strong>can user update title of at least one article?</strong></li>
</ul>
<p>Another way to check permissions is to extract all permitted fields from <code>Ability</code> instance using <code>permittedFieldsOf</code> helper from <code>@casl/ability/extra</code> sub-module. The same checking logic applies here:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permittedFieldsOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// the same code from app.js, the example above
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ARTICLE_FIELDS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;authorId&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">fieldsFrom</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rule</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">rule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">ARTICLE_FIELDS</span> <span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// [&#39;title&#39;, &#39;description&#39;]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">anotherArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// []
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// [&#39;title&#39;, &#39;description&#39;] !
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// do something if can update published field
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>CASL knows nothing about shapes of our entities, so the only way to tell him is to provide a <code>fieldsFrom</code> function. This function should return a list of fields from rule. Rule has no fields if it&rsquo;s allowed (or disallowed) to manage all of them. In this case, we return all fields, otherwise return what is inside our rule.</p>
<p>This method is very useful in combination with <a href="https://lodash.com/docs/4.17.15#pick">lodash.pick</a> to extract permitted fields from user request</p>
<blockquote>
<p>If you need <code>pick</code> with support for wildcards, check [this implementation][pick.wildcars]</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">pick</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;lodash/pick&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permittedFieldsOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// the same code from app.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">reqBody</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;CASL&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;powerful&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// only moderators are allowed to change this field!
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rawArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pick</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reqBody</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// { title: &#39;CASL&#39;, description: &#39;powerful&#39; }
</span></code></pre></div><p>Thanks to this, users, who try to send attributes, won&rsquo;t be able to overcome permissions' restrictions.</p>
<blockquote>
<p>To know more about <code>@casl/ability/extra</code> check its <a href="../../api#extra-submodule">API documentation</a></p>
</blockquote>
<h2 id="nested-fields">Nested fields</h2>
<p>CASL allows you to define permissions on nested fields, to do this just use dot notation, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;address.city&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="field-patterns">Field patterns</h2>
<p>It&rsquo;s also possible to define permissions for fields using patterns. You can use <code>*</code> to match any symbol except dot (i.e., <code>.</code>) and <code>**</code> to match any symbol. For example, you want to allow access to all fields of a nested field (in spite of the nesting level):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;address.**&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.city.name&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>Or you can give access to only first level of nested fields:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;address.*&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.city.name&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span></code></pre></div><p>Or you can give access to top level fields using pattern. Suppose <code>User</code> instance has multiple fields for street like <code>street1</code>, <code>street2</code>, etc:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;street*&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;street&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;street1&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;street2&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h3 id="field-patterns-table">Field patterns table</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>address.*</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td>address.**</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.lat')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td>address.*.name</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.*.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.name')</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td>address.**.name</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.*.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td>*.name</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', '*.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.name')</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td>**.name</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', '*.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.code')</code></td>
<td><code>false</code></td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c7e6f9001127982861f81d00fd317eaa">1.6 - 主题类型检测</h1>
    
	<p>Let&rsquo;s consider an example:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>We allowed everyone to read articles, now let&rsquo;s test it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>What do you think the last line returns? It returns <code>false</code>, but why? Because <code>article</code> variable is not of <code>Article</code> type. Now you should have a question:</p>
<h2 id="how-does-casl-detect-subject-type">How does CASL detect subject type?</h2>
<p>The first thing to clarify is &ldquo;what is subject type?&rdquo;. A subject type is basically a type of an object, in OOP class represents instance metadata and represents object metadata information.</p>
<blockquote>
<p>Starting from v5, CASL perceives string, function and class as a subject type. Any other type is perceived as a subject, for which CASL needs to detect subject type.</p>
</blockquote>
<p>When we pass an object as the 2nd argument in <code>ability.can</code>, CASL gets <code>object.constructor.modelName</code> as subject type, and fallbacks to <code>object.constructor.name</code> if <code>modelName</code> is not specified.</p>
<p>In the example above, <code>article</code> variable contains a plain object, its constructor doesn&rsquo;t have <code>modelName</code>, so CASL gets its <code>constructor.name</code> as a subject type. Eventually, we get <code>Object</code>. There are no rules for <code>Object</code> subject type, that&rsquo;s why we got <code>false</code> when tried to check whether it&rsquo;s possible to read that object. So, how can we fix that example? The easiest way is to use a special class for our <code>Article</code> model:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p><strong>The example above won&rsquo;t work</strong> in production if we use minimization. To fix it, we need to set a static property on <code>Article</code> class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">get</span> <span style="color:#000">modelName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>This is fine for backend where classes are naturally used to describe and encapsulate Domain Logic but not for frontend. Usually frontend deals with <a href="https://en.wikipedia.org/wiki/Data_transfer_object">DTO</a> objects (i.e., plain js objects).</p>
<p>CASL provides 2 options to handle DTO objects:</p>
<ol>
<li>Use <code>subject</code> helper.</li>
<li>Use custom subject type detection algorithm.</li>
</ol>
<h2 id="subject-helper">subject helper</h2>
<p>CASL provides built-in <code>subject</code> helper which sets subject type to provided object. So, the example above we can rewrite to:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>It defines readonly non-configurable and non-enumerable <code>__caslSubjectType__</code> property on the provided DTO, so it can be used in the subject&rsquo;s type detection algorithm.</p>
<blockquote>
<p>CASL will throw an exception if you try to use <code>subject</code> helper with different subject type for an object processed by the helper previously</p>
</blockquote>
<p>So, now you have 2 options:</p>
<ol>
<li>Use <code>subject</code> helper everywhere you use <code>ability.can</code> as shown in the example above.</li>
<li>Set subject type for all <a href="https://en.wikipedia.org/wiki/Data_transfer_object">DTO</a>s after retrieving them from server</li>
</ol>
<p>So, let&rsquo;s see what we mean for the 2nd option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getArticles</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/api/articles&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">article</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>The 2nd approach is a bit hacky because it mixes responsibilities. Now, your services coupled with CASL. This is fine for short term or small-medium apps but should be avoided for large apps</p>
</blockquote>
<p>Now we can safely check permissions on articles using <code>ability.can</code> without worrying about subject&rsquo;s type as it was defined previously.</p>
<p>To make a code a bit more readable, you can alias <code>subject</code> to <code>a</code> or <code>an</code> depending on the context, so the example above may look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">subject</span> <span style="color:#000">as</span> <span style="color:#000">an</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getArticles</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/api/articles&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">an</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// read as &#34;an Article object&#34;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="custom-subject-type-detection">Custom subject type detection</h2>
<p>Sometimes you will need to define your own type detection algorithm (e.g., <a href="https://graphql.org/">GraphQL</a> provides metadata field <code>__typename</code> which returns the type of the object)</p>
<p>For such cases, we can override built-in algorithm by providing <code>detectSubjectType</code> option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">__</span><span style="color:#000">typename</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#0000cf;font-weight:bold">__</span><span style="color:#000">typename</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>Custom detection function must return a subject type (either string, class or function).</p>
<p>The same can be achieved using <code>defineAbility</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">__</span><span style="color:#000">typename</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#0000cf;font-weight:bold">__</span><span style="color:#000">typename</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>It&rsquo;s important to note that <code>detectSubjectType</code> is responsible for mapping objects to their corresponding types. When we pass a class, a function or a string in <code>ability.can</code>, they are automatically perceived as a subject type and <code>detectSubjectType</code> is not called for them.</p>
<h3 id="use-classes-as-subject-types">Use classes as subject types</h3>
<p>As we said before, it&rsquo;s common to use classes to model Domain Logic on backend. So, some of you may want to use classes as subject types in permission definition. To do this, we need a custom <code>detectSubjectType</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>Or with <code>AbilityBuilder</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>If you want to use classes in TypeScript, you need to cast <code>object.constructor</code> (read <a href="https://github.com/microsoft/TypeScript/issues/3841">this TypeScript issue</a> for details):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ExtractSubjectType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Subjects</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Article</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Actions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Subjects</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#8f5902;font-style:italic">// if you don&#39;t use permission specific types, you can cast return value to `SubjectType` type
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">constructor</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">ExtractSubjectType</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Subjects</span><span style="color:#000;font-weight:bold">&gt;,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d4173def6f5a3fd9c84a2973d3878334">1.7 - 行动定义别名</h1>
    
	<p>Aliases gives a possibility to combine several actions into one. This also simplifies checks when we need to ensure that user can do both actions together (e.g., <code>delete</code> and <code>update</code>).</p>
<p>To define an alias, we need to use <code>createAliasResolver</code> function. It accepts a single argument - aliases to actions map. For example, here we define modify alias as a combination of update and delete actions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createAliasResolver</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">resolveAction</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAliasResolver</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">modify</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">resolveAction</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>When you check abilities by alias, it means that user has all required actions (or doesn&rsquo;t have at least one), so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><strong>Be aware</strong> that aliases work only in one direction! It means that <code>modify</code> is an alias for <code>update</code> and <code>delete</code> but <code>update</code> and <code>delete</code> do not automatically form <code>modify</code> alias. To understand what this means, let&rsquo;s consider the same example but with different rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createAliasResolver</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">resolveAction</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAliasResolver</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">modify</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">resolveAction</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false &lt;---
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>We got <code>false</code> for <code>modify</code> action, even though we can <code>delete</code> and <code>update</code> a Post! Aliases are resolved once on <code>Ability</code> instantiation level or when you call <code>ability.update</code>. It was done this way in order to make <code>ability.can</code> faster.</p>
<p>You can also define aliases on aliases, they are resolved recursively:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createAliasResolver</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">resolveAction</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAliasResolver</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">modify</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">access</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;access&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">resolveAction</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;access&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h2 id="invalid-usage">Invalid usage</h2>
<p>In any environment that is not production (determined by <code>process.env.NODE_ENV</code>), <code>createAliasResolver</code> analyses passed in object and forbids to:</p>
<ol>
<li>Create an alias for <code>manage</code> action.<br>
<code>manage</code> is reserved and represents any action, so there is no need to alias it (e.g., <code>createAliasResolver({ access: 'manage' })</code>).</li>
<li>Create an alias to itself (e.g., <code>createAliasResolver({ access: 'access' })</code>).</li>
</ol>
<p>It doesn&rsquo;t detect cycles through several levels of indirection, so you need to ensure this by yourself.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-855747809fc2a2d136fdd237db304949">2 - 高级</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-ece8921c8a9bf42a0dce2f797a74f55b">2.1 - Ability inheritance</h1>
    
	<p>TODO</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cd471495cf7beb0aae5fa5f1ce2f6f8d">2.2 - TypeScript Support</h1>
    
	<p>CASL is written in <a href="https://typescriptlang.org/">TypeScript</a> and this brings several benefits:</p>
<ul>
<li>better safety as you can control what actions and subjects can be used</li>
<li>better IDE integration as you can get hints on what classes you can use and arguments you need to pass inside</li>
<li>easier library support, we can forget about synchronization issues between <code>.d.ts</code> and <code>.js</code> files</li>
</ul>
<p>So, let&rsquo;s play around with them</p>
<blockquote>
<p>Minimum supported TypeScript version is <strong>3.8.3</strong>. CASL uses <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-8.html#type-only-imports-and-export"><code>export type</code> syntax</a></p>
</blockquote>
<h2 id="permissions-inference">Permissions inference</h2>
<p><code>Ability</code> class accepts 2 <strong>optional</strong> generic parameters:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Subject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MongoQuery</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PossibleAbilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Subject</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Conditions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">MongoQuery</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">PossibleAbilities</span><span style="color:#a40000">,</span> <span style="color:#c4a000">Conditions</span><span style="color:#000;font-weight:bold">&gt;();</span>
</code></pre></div><blockquote>
<p><code>Subject</code> is a special type that represents all possible subjects that <code>Ability</code> can accept. So, it&rsquo;s <code>object | string | Function | undefined</code>.</p>
</blockquote>
<p>Don&rsquo;t be scared by the complexity, <code>Ability</code> uses that types by default, so the example above is the same as the one below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>These types are enough to protect you from passing wrong arguments but you can go further and make them even stricter. To illustrate how, let&rsquo;s consider a blog application, which has <code>User</code>, <code>Article</code> and <code>Comment</code> entities with the next user&rsquo;s permissions:</p>
<ul>
<li>can <code>create</code>, <code>update</code>, <code>delete</code> own <code>Article</code> or <code>Comment</code></li>
<li>can <code>read</code> any <code>Article</code>, any <code>Comment</code> and any <code>User</code></li>
</ul>
<p>So, let&rsquo;s translate this to CASL by specifying all possible actions and all possible subjects as generic parameters:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;create&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Subjects</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;Comment&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Actions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Subjects</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>If you try to type <code>ability.can(</code> in <a href="https://code.visualstudio.com/">VSCode</a> (or other TypeScript supported IDEs), it provides hints:</p>
<p><img src="./casl-action-hints.png" alt="CASL TypeScript action hints"></p>
<p>The same happens when you try to specify the 2nd argument:</p>
<p><img src="./casl-subject-hints.png" alt="CASL TypeScript subject hints"></p>
<p>The same behavior works for <code>AbilityBuilder</code> and <code>defineAbility</code> function:</p>
<p><img src="./casl-abilitybuilder.png" alt="CASL TypeScript AbilityBuilder hints"></p>
<h2 id="infer-subject-types-from-interfaces-and-classes">Infer subject types from interfaces and classes</h2>
<p>You can also specify interfaces as subjects:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Comment</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Action</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;create&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Subject</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Article</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">Comment</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;User&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Action</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Subject</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;write&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// error because non-existing action name
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Coment&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// error because of typo
</span></code></pre></div><p>and classes:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">content</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Action</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;create&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Subject</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">Article</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Action</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Subject</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">());</span>
</code></pre></div><p>This may be a bit routine to specify all possible subject types, especially if you have more than 3 of them. To make it easier, CASL provide <code>InferSubjects</code> typescript helper which can infer subjects from <a href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#discriminated-unions">tagged union</a>s (this helper checks <code>kind</code> and special <code>__caslSubjectType__</code> properties in order to determine the tag)</p>
<blockquote>
<p><code>__caslSubjectType__</code> is set by <code>subject</code> helper, to learn more check <a href="../../guide/subject-type-detection">Subject type detection</a></p>
</blockquote>
<p><img src="./casl-tagged-union-subject.png" alt="CASL TypeScript infer tagged union subject"></p>
<p>classes</p>
<p><img src="./casl-class-subject.png" alt="CASL TypeScript infer class subject"></p>
<p>and even discriminated classes (you need to pass <code>true</code> to the 2nd generic parameter of <code>InferSubjects</code>).</p>
<p><img src="./casl-discriminated-class-subject.png" alt="CASL TypeScript infer discriminated class subject"></p>
<p>The same parameter allows to infer <code>modelName</code> static property from classes (in case you want to use strings and not classes to check on subject type)</p>
<p><img src="./casl-class-subject-with-name.png" alt="CASL TypeScript infer class modelName"></p>
<p>Moreover, the same behavior also works in complementary packages! So, you will get hints for React&rsquo;s <code>Can</code> component, Vue&rsquo;s <code>$can</code> function, Mongoose&rsquo;s plugins and others.</p>
<blockquote>
<p>To learn more, read docs for a complementary package for of your choice</p>
</blockquote>
<p>But even this is not the end and you can go even further!</p>
<h2 id="safer-permissions-inference">Safer permissions inference</h2>
<p>For the most cases the suggested approach above should be enough but if you prefer to ensure extreme type safety, you can define dependencies between actions and subjects. For example, user can only read information about users in your app and nothing more but can manage articles:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CRUD</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;create&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Abilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">CRUD</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">];</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;();</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// build time error! because it&#39;s not allowed to create users
</span></code></pre></div><h2 id="application-ability">Application Ability</h2>
<p>From the first sight, it looks like that in order to use safer generic parameters, your app&rsquo;s code will become more complicated and this is true. But there is an escape hatch - <strong>Companion object pattern</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">CRUD</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;create&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Abilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">CRUD</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">];</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>
</code></pre></div><p>This simple pattern comes to TypeScript from Scala, and it&rsquo;s a way to pair together types and objects. In TypeScript, values and types live in a separate namespaces, this allows to use the same name for a type and a class. TypeScript understands which one to use baed on the context.</p>
<h2 id="abilitybuilder-type-inference">AbilityBuilder type inference</h2>
<p><code>AbilityBuilder</code> constructor accepts the single argument which is a type of <code>Ability</code> we want to build:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">builder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><blockquote>
<p>Starting from v5, <code>AbilityBuilder</code> accepts required parameter, <code>Ability</code> class to build</p>
</blockquote>
<p>Thanks to this <code>AbilityBuilder</code> can infer all needed types from <code>Ability</code> types. This is especially useful when we define <code>AppAbility</code> because then we will have IDE hints and type safety for:</p>
<ul>
<li>specified action</li>
<li>specified subject type</li>
<li><strong>properties used in conditions</strong></li>
<li><strong>specified fields</strong></li>
</ul>
<p>We can use either tagged interfaces (supports <code>kind</code>, <code>__typename</code> and <code>__caslSubjectType__</code> tag fields) or classes:</p>
<p><img src="./casl-abilitybuilder-conditions-hints.png" alt="CASL TypeScript: AbilityBuilder conditions hints"></p>
<p><img src="./casl-abilitybuilder-fields-hints.png" alt="CASL TypeScript: AbilityBuilder fields hints"></p>
<p>The cool thing is that all that safety is subject type dependent! Try to pass <code>User</code> subject type in place of <code>Post</code> and see it by yourself!</p>
<h3 id="nested-fields-with-dot-notation">Nested fields with dot notation</h3>
<p>If we need to define conditions based on nested fields, we can do this by defining a separate interface:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">kind</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">name</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">address</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">street</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">building</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FlatUser</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;address&#34;</span><span style="color:#000;font-weight:bold">][</span><span style="color:#4e9a06">&#34;street&#34;</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">FlatUser</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#8f5902;font-style:italic">// It also works for fields
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">FlatUser</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="useful-type-helpers">Useful type helpers</h2>
<h3 id="rawrule">RawRule</h3>
<p>Sometimes you may need to create <code>RawRule</code>s manually (or fetch them from db). In that case, you will need to type them explicitly. Use <code>RawRuleOf&lt;AppAbility&gt;</code> in case if you have type for <code>AppAbility</code> or <code>RawRuleFrom&lt;Abilities, Conditions&gt;</code> otherwise.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">RawRuleOf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">RawRuleFrom</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MongoQuery</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbilities</span><span style="color:#000;font-weight:bold">&gt;;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rawRules</span>: <span style="color:#204a87;font-weight:bold">RawRuleOf</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">}];</span>

<span style="color:#8f5902;font-style:italic">// or
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppRawRule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">RawRuleFrom</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbilities</span><span style="color:#a40000">,</span> <span style="color:#c4a000">MongoQuery</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getRulesFromDb</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppRawRule</span><span style="color:#a40000">[]</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// implementation
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="ruleof">RuleOf</h3>
<p>Similar to <code>RawRule</code> helpers, there is a helper <code>RuleOf&lt;Ability&gt;</code> for <code>Rule&lt;Abilities, Conditions&gt;</code>. It&rsquo;s very unlikely that you will need to work with this types on application layer.</p>
<h3 id="abilityoptionsof">AbilityOptionsOf</h3>
<p>Similar to <code>RawRule</code>, if you don&rsquo;t want to explicitly use <code>AbilityOptions&lt;Abilities, Conditions&gt;</code>, you can use <code>AbilityOptionsOf&lt;Ability&gt;</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityOptionsOf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;@casl/ability&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;read&#39;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#39;update&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;Article&#39;</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbilities</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">options</span>: <span style="color:#204a87;font-weight:bold">AbilityOptionsOf</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">subject</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#8f5902;font-style:italic">/* custom implementation */</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbilities</span><span style="color:#000;font-weight:bold">&gt;([],</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="anyability-and-anymongoability">AnyAbility and AnyMongoAbility</h3>
<p>These 2 types represents any <code>PureAbility</code> instance and any <code>Ability</code> instance. They are usually a good fit for restrictions in generic types. For example, this is how <code>AnyAbility</code> is used in <code>AbilityBuilder</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span> <span style="color:#c4a000">extends</span> <span style="color:#c4a000">AnyAbility </span><span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#c4a000">AnyAbility</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// implementation details
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="mongoquery">MongoQuery</h3>
<p>There are 2 types that represents built-in mongo operators:</p>
<ul>
<li><code>MongoQuery&lt;T&gt;</code> is an actual mongo query.<br>
Is used as a conditions restriction in <code>Ability</code> class. Actually <code>Ability</code> is a <code>PureAbility</code> with conditions being restricted to <code>MongoQuery</code>.</li>
<li><code>MongoQueryOperators&lt;T&gt;</code> represents supported MongoDB operators and it&rsquo;s a union of <code>MongoQueryFieldOperators&lt;T&gt;</code> and <code>MongoQueryTopLevelOperators&lt;T&gt;</code> that represent supported field and document level operators respectively</li>
</ul>
<h3 id="forcedsubject">ForcedSubject</h3>
<p>Represents an object (i.e., POJO) that has been casted to specific subject by using <code>subject</code> helper.</p>
<blockquote>
<p>See <a href="../../guide/subject-type-detection#subject-helper">Subject type detection</a> for details</p>
</blockquote>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2af56faabe5a8af74442495478a93bce">2.3 - Customize Ability</h1>
    
	<p>CASL was built with extensibility in mind and this allows you to extend conditions with custom operators, provide custom field matchers and even use your own implementation to match conditions (e.g., using functions or <a href="https://json-schema.org/">json-schema</a>)! Let&rsquo;s see how</p>
<h2 id="extend-conditions-with-custom-operators">Extend conditions with custom operators</h2>
<p>Thanks to <a href="https://github.com/stalniy/ucast">ucast</a>, it&rsquo;s possible to <a href="../../guide/conditions-in-depth">define conditions in CASL</a> using MongoDB query language. Usually this is enough but sometimes you may want to restrict possible operators, add non-standard operator or one of those that is not included in CASL by default (e.g., <a href="https://docs.mongodb.com/manual/reference/operator/query/nor/">$nor</a>).</p>
<p>Let&rsquo;s see an example of how to add <code>$nor</code> operator. To do this, we will use <code>buildMongoQueryMatcher</code> helper function from <code>@casl/ability</code> package. It allows to add or override existing operators:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Abilities</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buildMongoQueryMatcher</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$nor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@ucast/mongo2js&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">conditionsMatcher</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">buildMongoQueryMatcher</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">$nor</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">nor</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">$nor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">user.id</span> <span style="color:#000;font-weight:bold">}],</span>
  <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">conditionsMatcher</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>We use <code>user: any</code> for the purpose of ease, you should avoid this in real apps</p>
</blockquote>
<p><code>buildMongoQueryMatcher</code> extends existing set of operators, so if you want to restrict available operators, you should not use it. For example, let&rsquo;s allow to use only <code>$eq</code> and <code>$in</code> operators:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">Abilities</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">MongoQueryFieldOperators</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">ConditionsMatcher</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">AbilityClass</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;@casl/ability&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">within</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$eq</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">eq</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createFactory</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">BuildMongoQuery</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#39;@ucast/mongo2js&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">RestrictedMongoQuery</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">BuildMongoQuery</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#a40000">,</span> <span style="color:#c4a000">Pick</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">MongoQueryFieldOperators</span><span style="color:#a40000">,</span> <span style="color:#a40000">&#39;$</span><span style="color:#c4a000">eq</span><span style="color:#a40000">&#39;</span> <span style="color:#a40000">|</span> <span style="color:#a40000">&#39;$</span><span style="color:#c4a000">in</span><span style="color:#a40000">&#39;</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">conditionsMatcher</span>: <span style="color:#204a87;font-weight:bold">ConditionsMatcher</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">RestrictedMongoQuery</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createFactory</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">$in</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$eq</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">within</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">eq</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#a40000">,</span> <span style="color:#c4a000">RestrictedMongoQuery</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;Article&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">user.id</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;Article&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;draft&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;published&#39;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">conditionsMatcher</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>Read <a href="https://github.com/stalniy/ucast/tree/master/packages/mongo2js#custom-operator">@ucast/mongo2js docs</a> page to learn how to create custom operators.</p>
</blockquote>
<p>By restricting operators, you not only disallow other developers to use more complex conditions but also make your frontend bundle size smaller (thanks to bundlers with tree-shaking support).</p>
<h2 id="custom-conditions-matcher-implementation">Custom conditions matcher implementation</h2>
<p>If you want to implement custom conditions matcher, you should use <code>PureAbility</code> class instead of <code>Ability</code>. <code>PureAbility</code> is a parent class for <code>Ability</code>, the only difference between them is that <code>Ability</code> has restriction on <code>Conditions</code> generic parameter and has default values for <code>conditionsMatcher</code> and <code>fieldMatcher</code> options.</p>
<blockquote>
<p>The prefix &ldquo;Pure&rdquo; has nothing to do with functional programming. It just means this class has no predefined configuration.</p>
</blockquote>
<p>Conditions matcher is a factory function that accepts <code>rule.conditions</code> and returns a function that accepts an object and returns boolean. All these restrictions on conditions matcher is enforced by <code>ConditionsMatcher</code> generic type which you can import from <code>@casl/ability</code>.</p>
<p>Let&rsquo;s implement the matcher that allows to use a function as conditions matcher:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PureAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityTuple</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">MatchConditions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PureAbility</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AbilityTuple</span><span style="color:#a40000">,</span> <span style="color:#c4a000">MatchConditions</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PureAbility</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">lambdaMatcher</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">matchConditions</span>: <span style="color:#204a87;font-weight:bold">MatchConditions</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">matchConditions</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">authorId</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">({</span> <span style="color:#000">status</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;draft&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">));</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">conditionsMatcher</span>: <span style="color:#204a87;font-weight:bold">lambdaMatcher</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>Conditions matchers can be only synchronous!</p>
</blockquote>
<p>We don&rsquo;t recommend to use functions for matching logic if you need to serialize rules or convert them to a database query. The default matcher should cover majority of cases.</p>
<h2 id="custom-field-matcher">Custom field matcher</h2>
<p>Field matcher is responsible for matching fields passed as 3rd argument to <code>can</code> method of <code>Ability</code> instance. It is a factory function that returns a function which accepts field and returns boolean. This logic is enforced by <code>FieldMatcher</code> type from <code>@casl/ability</code>.</p>
<blockquote>
<p>We cannot imagine a reasonable case to override field matching logic, <a href="../../guide/restricting-fields">default implementation</a> should be more than enough.</p>
</blockquote>
<p>You can use this to reduce your bundle size or enforce simpler logic. For example, let&rsquo;s implement simple field matcher that doesn&rsquo;t support field patterns:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">FieldMatcher</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fieldMatcher</span>: <span style="color:#204a87;font-weight:bold">FieldMatcher</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fields</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">field</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">field</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;content&#34;</span><span style="color:#000;font-weight:bold">]);</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">fieldMatcher</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-620096a4152f1dbfb9f132e1302b8108">2.4 - Debugging and testing</h1>
    
	<p>Sometimes it may be a bit complicated to understand why some action in the app is forbidden for a particular user. In this guide, you will learn common pitfalls and ways to investigate the underlying reasons. Let&rsquo;s start.</p>
<h2 id="debugging">Debugging</h2>
<p><code>Ability</code>&rsquo;s <code>can</code> and <code>cannot</code> methods return boolean result and doesn&rsquo;t explain the reason or which rule forbids the action. To get the rule which allows or forbids an action on a subject, you can use <code>relevantRuleFor</code> method. It accepts the same arguments as <code>can</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relevantRuleFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// instance of internal `Rule` class
</span></code></pre></div><p>You can use <code>rule.conditions</code> or <code>rule.fields</code> fields to understand which rule causes the unexpected result. <code>relevantRuleFor</code> returns <code>null</code> if rule cannot be found, this is the case when you check permissions on non-existing action or subject:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relevantRuleFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// null
</span></code></pre></div><p>This method is especially helpful when you use combination of direct rules with conditions and inverted rules:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><blockquote>
<p>For simplicity, I will use <code>subject</code> helper instead of a class to create subjects with bound type. You can read more about other ways to do it in <a href="../../guide/subject-type-detection">Subject type detection</a></p>
</blockquote>
<p>Now let&rsquo;s check:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relevantRuleFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">}));</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conditions</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// { authorId: 1 }
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">forbiddenRule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relevantRuleFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}));</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">forbiddenRule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conditions</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// { private: true }
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">anotherRule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relevantRuleFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">}));</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">anotherRule</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// null, no matching rule
</span></code></pre></div><p>Another way to understand why the action is forbidden is to use <a href="../../guide/intro#forbidden-reasons">Forbidden reasons</a> feature. It allows to assign a user friendly explanation to rule</p>
<blockquote>
<p>Forbidden reasons doesn&rsquo;t support direct rules. See <a href="https://github.com/stalniy/casl/issues/264">#264</a> to track the status of this feature</p>
</blockquote>
<div class="highlight" data-filename="defineAbilityWithReasons.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">because</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Private content is protected by law&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relevantRuleFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// instance of internal `Rule` class
</span></code></pre></div><p>We can use the same <code>relevantRuleFor</code> method but check <code>rule.reason</code> field instead:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbilityWithReasons&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">relevantRuleFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}));</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">reason</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Private content is protected by law
</span></code></pre></div><h2 id="testing">Testing</h2>
<p><code>Ability</code> instance is pure in terms of functional programming. It means that for the same rules, its <code>can</code> method returns always the same result. That&rsquo;s why, there is no big profit in testing CASL permissions, instead you should test rule distribution logic. <strong>This sounds correct, but only at the first sight</strong>. Let&rsquo;s consider an example:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * This function is responsible for rule distribution logic.
</span><span style="color:#8f5902;font-style:italic"> * And we need to test it, not ability checks!
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isAdmin</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rules</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><p>Now we want to ensure that admin users can do anything and other can only read non-private articles. Using <a href="https://mochajs.org/">mocha</a> + <a href="http://chaijs.com/">chai</a> or <a href="https://jestjs.io/">jest</a> we can do it (we will use mocha and chai):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineRulesFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Permissions&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;when user is an admin&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">beforeEach</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">isAdmin</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#000;font-weight:bold">});</span>

    <span style="color:#000">it</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;can do anything&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">expect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equal</span><span style="color:#000;font-weight:bold">([{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;all&#34;</span> <span style="color:#000;font-weight:bold">}]);</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#000">describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;when user is a regular user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">beforeEach</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">isRegular</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#000;font-weight:bold">});</span>

    <span style="color:#000">it</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;can read non private article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">expect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">deep</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">contain</span><span style="color:#000;font-weight:bold">([</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">},</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">conditions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">inverted</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">]);</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Do you see the issue? <strong>We&rsquo;ve just tested implementation details and this is bad!</strong> Why?</p>
<p>Rules logic is very expressive and you can achieve the same results using a different combination of rules. For example &ldquo;user can read non private articles&rdquo; can be expressed in another way:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isAdmin</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rules</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And now we have only 1 direct rule that allows to read non-private articles! So, we have the same permissions, the same set of supported cases but our tests are <strong>red</strong> and that&rsquo;s bad. So, if we test rules' distribution logic, very likely we will need to fix old tests when we decide to change rules for some reason.</p>
<p>Permissions logic is quite important, so the correct way to test it is to test particular cases. This saves your time from fixing tests that relies too much on implementation details and will make sure that the next version of CASL won&rsquo;t break your permission system (if it does please <a href="https://github.com/stalniy/casl/issues/new">create an issue</a>). Eventually tests should look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Permissions&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#000">describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;when user is an admin&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">beforeEach</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">isAdmin</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>
      <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">});</span>

    <span style="color:#000">it</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;can do anything&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">expect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">be</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#000">describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;when user is a regular user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">beforeEach</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">isRegular</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>
      <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">});</span>

    <span style="color:#000">it</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;can read non private article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">expect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">be</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000">expect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#000;font-weight:bold">}))).</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">be</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000">expect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">}))).</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">be</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000">expect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}))).</span><span style="color:#000">to</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">be</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6d06b4742afea388308a653da9b99592">2.5 - Ability to database query</h1>
    
	<p>Sometimes you need to restrict which records are returned from the database based on what the user is able to do in the app. <code>@casl/ability/extra</code> provides <code>rulesToQuery</code> helper function which helps to convert rules into a particular database&rsquo;s query. This function accepts 4 arguments:</p>
<ol>
<li>An instance of <code>PureAbility</code></li>
<li><code>action</code> for which you want to get rules</li>
<li><code>subjectType</code> which you plan to query</li>
<li>conversion function which takes rule as the only argument and returns database query chunk</li>
</ol>
<p>The helper aggregates all query chunks into a single object that has <code>$or</code> and <code>$and</code> properties. Query chunk for direct rules are collected in <code>$or</code> array and inverted - in <code>$and</code> array. <strong>This function returns <code>null</code></strong> if the provided ability does not allow to perform the provided action on the provided subject type.</p>
<blockquote>
<p>See <a href="../../package/casl-mongoose">@casl/mongoose</a> to get details about integration with <a href="https://www.mongodb.com/">MongoDB</a></p>
</blockquote>
<p>To understand the logic better let&rsquo;s implement <strong>a basic helper</strong> for <a href="https://sequelize.org/">sequelize</a>.</p>
<div class="highlight" data-filename="toSequelizeQuery.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">rulesToQuery</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;@casl/ability/extra&#39;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Op</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;sequelize&#39;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * Tricky way to walk recursively over deeply nested object.
</span><span style="color:#8f5902;font-style:italic"> * See https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/parse#Parameters
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">symbolize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">keyToSymbol</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#39;$&#39;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">symbol</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Op</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">slice</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)];</span>
      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">symbol</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">ruleToSequelize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rule</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">inverted</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$not</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">rule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conditions</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">rule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">conditions</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">toSequelizeQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">action</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rulesToQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">action</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ruleToSequelize</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">symbolize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">accessibleBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">action</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">toSequelizeQuery</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">action</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">query</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// there is no accessible records, so no need to send query to db
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">findAll</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#000">where</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">query</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">toSequelizeQuery</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">accessibleBy</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>In this example, we used <code>rulesToQuery</code> to iterate over rules and aggregate sequelize query. <code>$not</code> operator is used to invert the result of inverted rules' conditions. As of sequelize v6, operator aliases are removed (<a href="https://github.com/sequelize/sequelize/issues/10820">sequelize#10820</a>), so we need to convert string based keys into symbols. To do so, we used a trick of stringifying and parsing JSON object with custom <code>reviver</code> argument, which detects keys that starts with <code>$</code> and replaces them with the respective symbol.</p>
<p>Then, we can use this function to define static method or scope in your model. Here, we will define static method because its usage looks more natural and readable than custom scope:</p>
<div class="highlight" data-filename="Article.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Model</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">DataTypes</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sequelize&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">accessibleBy</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;./toSequelizeQuery&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sequelize</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Model</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">accessibleBy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">accessibleBy</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">init</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">DataTypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">STRING</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">allowNull</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">DataTypes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BOOLEAN</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">allowNull</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">defaultValue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#8f5902;font-style:italic">// other columns&#39; definitions
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">sequelize</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">modelName</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>Now we can fetch accessible records using our static method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Sequelize</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sequelize&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">defineArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;./Article&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sequelize</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Sequelize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sqlite::memory&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineArticle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sequelize</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}));</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">articles</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">accessibleBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">articles</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">main</span><span style="color:#000;font-weight:bold">().</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>This implementation is basic because it doesn&rsquo;t support joins. See <a href="https://github.com/stalniy/casl/issues/8">#8</a> to track status of SQL support in CASL.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d3231b1184e4a3523ac6cf37a140903a">3 - 官方包</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0f26e8115c358f155f08e4e727caad15">3.1 - CASL Prisma</h1>
    
	<p>@include: packages/casl-prisma/README.md</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f1c426f5b028adc5cd307b47819ebf58">3.2 - CASL Mongoose</h1>
    
	<p>@include: packages/casl-mongoose/README.md</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-140215cf4a90c64b3979f7fdb6e76f22">3.3 - CASL Angular</h1>
    
	<p>@include: packages/casl-angular/README.md</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-967759b2c100528c84c40ea798b91042">3.4 - CASL React</h1>
    
	<p>@include: packages/casl-react/README.md</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bdf4089ba2ab126166f63dc70a9a3ffb">3.5 - CASL Vue</h1>
    
	<p>@include: packages/casl-vue/README.md</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2cbd1663e397c8abef5d83e112a619f3">3.6 - CASL Aurelia</h1>
    
	<p>@include: packages/casl-aurelia/README.md</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f1dd821e012ff2fb15bfa486a7647ae3">4 - 食谱</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e885a88fdfc50203dbb9ee3a8bad01d0">4.1 - Cookbook Introduction</h1>
    
	<h2 id="the-cookbook-vs-the-guide">The Cookbook vs the Guide</h2>
<p>How is the cookbook different from the guide? Why is this necessary?</p>
<ul>
<li><strong>Greater Focus</strong>. In the guide, we&rsquo;re essentially telling a story. Each section builds on and assumes knowledge from each previous section. In the cookbook, each recipe stands on its own. This means recipes focus on one specific topic or use case, rather than having to give a general overview.</li>
<li><strong>Greater Depth</strong>. To avoid making the guide too long, we try to include only the simplest possible examples to help you understand each feature. Then we move on. In the cookbook, we can include more complex examples, combining features in interesting ways. Each recipe can also be as long and detailed as it needs to be, in order to fully explore its niche.</li>
<li><strong>Greater Complexity</strong>. In the guide, we assume at least intermediate familiarity with ES2015 JavaScript. In the cookbook however, you will see more TypeScript code, frontend and backend frameworks and libraries and real-world examples.</li>
</ul>
<blockquote>
<p>For most of cookbook&rsquo;s content, you are expected to have a basic understanding of concepts like JavaScript, npm/yarn, commonjs, ES import/export, Node.js module resolution algorithm. Depending on the recipe you are expected to know frontend or backend libraries and frameworks.</p>
</blockquote>
<h2 id="cookbook-contributions">Cookbook Contributions</h2>
<p>The Cookbook gives developers examples to work off of that both cover common or interesting use cases, and also progressively explain more complex detail. Our goal is to move beyond a simple introductory example, and demonstrate concepts that are more widely applicable, as well as some caveats to the approach.</p>
<p>If you’re interested in contributing, please initiate collaboration by filing an issue under the tag <strong>cookbook idea</strong> with your concept so that we can help guide you to a successful pull request. After your idea has been approved, please follow the template below as much as possible. Some sections are required, and some are optional. Following the numerical order is strongly suggested, but not required.</p>
<p>Recipes should generally:</p>
<ul>
<li>Solve a specific, common problem</li>
<li>Start with the simplest possible example to demonstrate the issue</li>
<li>Introduce complexities one at a time</li>
<li>Link to other docs, rather than re-explaining concepts</li>
<li>Describe the problem, rather than assuming familiarity</li>
<li>Explain the process, rather than just the end result</li>
<li>Explain the pros and cons of your strategy, including when it is and isn&rsquo;t appropriate</li>
<li>Mention alternative solutions, if relevant, but leave in-depth explorations to a separate recipe</li>
</ul>
<p>We ask you to follow the template below. We understand, however, that there are times when you may necessarily need to deviate for clarity or flow. Either way, all recipes should at some point discuss the nuance of the choice made using this pattern, preferably in the form of the alternative patterns section.</p>
<h3 id="the-issue">The issue</h3>
<p><em>required</em></p>
<ol>
<li>Articulate the problem in a sentence or two.</li>
<li>Show the simplest possible solution which leads to issues in the long run.</li>
<li>Explain the <strong>disadvantages</strong> of this solution</li>
</ol>
<h3 id="the-solution">The solution</h3>
<p><em>required</em></p>
<ol>
<li>Provide the suggested way to solve the issue</li>
<li>Explain the <strong>advantages</strong> in comparison to the simplest solution described in the section above</li>
<li>Discuss why this may be a compelling solution. Links for a reference are not required but encouraged</li>
<li>Walk through a few terse examples</li>
</ol>
<h3 id="demo">Demo</h3>
<p><em>required</em></p>
<p>Demonstrate the code that would power a common or interesting use case by embedding a codesandbox/scrimba/codepen/jsfiddle example.</p>
<h3 id="when-to-avoid">When To Avoid</h3>
<p><em>optional</em></p>
<p>This section is not required, but heavily recommended. Here, we’ll take an honest look at when the pattern is useful and when it should be avoided, or when something else makes more sense.</p>
<h3 id="alternative-ways">Alternative Ways</h3>
<p><em>optional</em></p>
<p>Similar to the previous section this one is optional, but very encouraged. The answer to most questions about development is <strong>&ldquo;It depends!&quot;</strong>. So, it’s important to explore other methods to let people compare and understand whether this solution makes sense in their situation.</p>
<h2 id="thank-you">Thank you</h2>
<p>It takes time to contribute to documentation, and if you spend the time to submit a PR to this section of our docs, you do so with our gratitude.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-34cd71443a17b1e740561cc7115b3277">4.2 - Less confusing can API</h1>
    
	<h2 id="the-issue">The issue</h2>
<p>CASL uses <code>can</code> and <code>cannot</code> function names to both define and check permissions. For some of you, it may look confusing and you would like to be more explicit and not rely on the execution context.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// define abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// check abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><strong>The main disadvantage</strong> is that you need to remember the context and differences between function signatures of <a href="../../guide/intro"><code>can</code> that defines ability</a> and <code>can</code> that checks it.</p>
<h2 id="the-solution">The solution</h2>
<p>What we can do is to use different variables' names, so the example above looks this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// define abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">allow</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">forbid</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">forbid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// check abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The same example using pure <code>AbilityBuilder</code> can be written in similar way using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment#Assigning_to_new_variable_names">object-destructuring</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// define abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span>: <span style="color:#204a87;font-weight:bold">allow</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span>: <span style="color:#204a87;font-weight:bold">forbid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">forbid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// check abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><strong>The main advantage</strong> is that everybody clearly sees that <code>allow</code> and <code>can</code> are different methods and potentially may have different signatures (because they different!).</p>
<blockquote>
<p>See <a href="../../guide/define-rules">Define rules</a> for other ways to define ability.</p>
</blockquote>
<h2 id="when-to-avoid">When to avoid</h2>
<p>This approach really makes it easy to work with CASL for junior developers and those who prefers explicit code over conventions or context. If contextual code doesn&rsquo;t bother you, you can avoid this.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4c6eef94c958d52006827a9da7ccc6e3">4.3 - Claim based Authorization</h1>
    
	<h2 id="the-issue">The issue</h2>
<p>You need to implement simple authorization (i.e., permission management) logic based on claims (or actions). In other words, you have action (or a claim) but don&rsquo;t have the concept of &ldquo;subject&rdquo; on which this action can be applied (or it&rsquo;s not important in your app). This concept is very similar to <a href="https://en.wikipedia.org/wiki/Claims-based_identity">claim based identity</a>.</p>
<p>The easiest way to achieve this is to create an array of all possible actions (or claims) and check if a claim exists on the user object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ACTIONS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;publish&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">];</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">publishArticle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">article</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;publish&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You cannot publish articles&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// logic to publish article
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>What are <strong>the disadvantages</strong> of handmade solution:</p>
<ol>
<li>You need to test.<br>
It&rsquo;s very important to know that your permissions logic is reliable otherwise it doesn&rsquo;t make sense.</li>
<li>You need to support it (i.e., fix bugs).<br>
If you find a bug, you need to fix it and add tests. But what would you do if the bug is found by the attacker?</li>
<li>You need to evolve it.<br>
The world constantly changes, the same way your business requirements changes. If you need to add more complex permissions logic (e.g., permission per subject or per attribute), you will need to implement and test it yourself.</li>
</ol>
<p>All that consumes time and resources, as a result postpones the delivery of your product.</p>
<h2 id="the-solution">The solution</h2>
<p>Fortunately, CASL supports claim based authorization. The example above can be represented in CASL:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PureAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PureAbility</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Actions</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;review&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;publish&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;publish&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">publishArticle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">article</span>: <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ability</span>: <span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;publish&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You cannot publish articles&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// logic to publish article
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p><strong>The advantages</strong> of this:</p>
<ol>
<li>You can start with simple permissions logic and evolve it together with your business requirements.</li>
<li>Thanks to tree-shaking in <a href="https://rollupjs.org/guide/en/">rollup</a> and <a href="https://webpack.js.org/">webpack</a> CASL takes only 1.5KB for claim based authorization.</li>
<li>No need to support own solution. Lots of people use and create issues for OpenSource libraries like CASL, so you get support, bug fix and new features for free.</li>
</ol>
<h2 id="when-to-avoid">When To Avoid</h2>
<p>Sometimes applications use merged action and subject as a claim: <code>create_article</code>, <code>read_article</code>, <code>read_user</code>. In such cases, it&rsquo;d better separate actions and subjects. This will allow you to add conditions and fields to your abilities later without refactoring the whole application.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b3edd3f097341ab85af67ee61c3e5879">4.4 - Cache abilities</h1>
    
	<blockquote>
<p>This recipe targets backend developers. We use <a href="https://expressjs.com/">express</a> library in this guide, so its knowledge (or knowledge of similar framework) is required.</p>
</blockquote>
<h2 id="the-issue">The issue</h2>
<p>It takes considerable amount of time or requires additional roundtrip to the database to construct an <code>Ability</code> instance.</p>
<p>Let&rsquo;s consider an example where user can manage own devices but <strong>devices doesn&rsquo;t have</strong> a reference to the owner. In such cases, we need to fetch all device ids in order to create an <code>Ability</code>:</p>
<div class="highlight" data-filename="defineAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Abilities</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getDevicesOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../services/device&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">devices</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">getDevicesOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ids</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">devices</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">device</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Device&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span>: <span style="color:#204a87;font-weight:bold">ids</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#8f5902;font-style:italic">// other rules
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rules</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rules</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>The underlying database is not important for this guide. The same principles works for any other database system.</p>
</blockquote>
<h2 id="the-solution">The solution</h2>
<p>To speed things up, you can cache creation of the ability instance.</p>
<h2 id="demo">Demo</h2>
<p>There are several ways to do this:</p>
<blockquote>
<p>Make sure that you wrap all async express middlewares in try/catch as express 4.x doesn&rsquo;t support <code>Promise</code> rejections. We don&rsquo;t do this in the examples below for the sake of simplicity.</p>
</blockquote>
<h3 id="in-memory-lru-cache">In memory LRU cache</h3>
<p><a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_Recently_Used_.28LRU.29">LRU cache</a> is a type of cache which discards least recently used entries, hence allows to store abilities for the most active users, that users who generate the highest load on your system.</p>
<blockquote>
<p>There is quite popular <a href="https://www.npmjs.com/package/lru-cache">lru-cache</a> Node.js package which we will use in this guide but you can use any other implementation the same way.</p>
</blockquote>
<p>So, let&rsquo;s create a middleware that defines <code>Ability</code> instance of <code>Request</code> object:</p>
<div class="highlight" data-filename="provideAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LruCache</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;lru-cache&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// store abilities of 1000 most active users
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ABILITIES_CACHE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">LruCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ABILITIES_CACHE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ABILITIES_CACHE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">ABILITIES_CACHE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">next</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now we can use this middleware to provide <code>Ability</code> instance for a particular user and check its permissions:</p>
<div class="highlight" data-filename="boot.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">provideAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./provideAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">express</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">express</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// app configuration and other middlewares
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;app is listening on http://localhost:3000&#34;</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><blockquote>
<p>Don&rsquo;t forget to invalidate cache when user adds or removes devices</p>
</blockquote>
<h3 id="in-session-storage">In session storage</h3>
<p>If the application uses stored sessions and <a href="#in-memory-lru-cache">LRU cache</a> doesn&rsquo;t satisfy your needs, you can store <code>Ability</code> rules in user&rsquo;s session (e.g., Redis, Memcached). Why do we store rules and not <code>Ability</code> instance? Because session storage serializes object before storing it. Rules are easily serializable and <code>Ability</code> instance is not, but can be created from rules.</p>
<p>Sessions in express usually are implemented with help of <a href="https://www.npmjs.com/package/express-session">express-session</a> and <a href="https://www.npmjs.com/package/connect-redis">connect-redis</a>. We will do it the same way.</p>
<p>So, the only thing which is left is to implement <code>provideAbility</code> middleware that saves rules for a particular user in his session storage. Pay attention that we use <code>defineRulesFor</code> and not <code>defineAbilityFor</code> function:</p>
<div class="highlight" data-filename="provideAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Abilities</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineRulesFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">rules</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abilityRules</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abilityRules</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">rules</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abilityRules</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rules</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">next</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And make sure that you correctly configure express-session in your <code>app.ts</code> file. It should be something like this:</p>
<div class="highlight" data-filename="app.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">provideAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./provideAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">express</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">session</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express-session&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">redis</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">createRedisStore</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;connect-redis&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">express</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">RedisStore</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createRedisStore</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000">session</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#000">store</span>: <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RedisStore</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">client</span>: <span style="color:#204a87;font-weight:bold">redis.createClient</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000">secret</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;my app session secret&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// app configuration and other middlewares
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="in-jwt-token-payload">In JWT token payload</h3>
<p>If the app uses stateless <a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JWT</a> tokens, you can embed the rules into its payload:</p>
<div class="highlight" data-filename="login.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">jwt</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;jsonwebtoken&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineRulesFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">login</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jwt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sign</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">req.user.id</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">rules</span>: <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#4e9a06">&#34;secret&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">expiresIn</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1d&#34;</span> <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">token</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And implement <code>provideAbility</code> middleware that creates ability out of jwt token which is provided by client in <code>Authorization</code> header:</p>
<div class="highlight" data-filename="provideAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Abilities</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">jwt</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;jsonwebtoken&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineRulesFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authorization</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jwt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">verify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;jwtSecret&#34;</span><span style="color:#000;font-weight:bold">));</span>

    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">next</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">next</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>You can use <code>packRules</code> and <code>unpackRules</code> to minimize rules payload size in 2 times. Check the <a href="../../api/casl-ability-extra#pack-rules">API docs of @casl/ability/extra</a> for details</p>
</blockquote>
<h2 id="when-to-avoid">When to avoid</h2>
<p>There are few cases when you should avoid caching:</p>
<ol>
<li>The amount of abilities is small.</li>
<li>The requests to the database are cached in service layer.</li>
<li>Your permissions are dynamic and it makes hard to keep cache in sync with the datastore state.</li>
<li>You can rethink domain model to simplify permissions logic (denormalize some entities or add additional foreign keys).</li>
</ol>
<h2 id="alternative-ways">Alternative ways</h2>
<p>Another way is to rethink domain (or data) model, so that you can build abilities from the information which you load for every request (e.g., completely on <code>user</code>&rsquo;s details). In the case described in <a href="#the-issue">The issue</a>, we could add <code>userId</code> field to <code>Device</code> model and that would make things work fast without additional caching.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-001366d799f10789e049c841de4397c9">4.5 - Roles with predefined permissions</h1>
    
	<blockquote>
<p>This recipe targets backend developers. We use <a href="https://www.typescriptlang.org">TypeScript</a> and <a href="https://en.wikipedia.org/wiki/Relational_database">RDBMS</a> in this guide, so the basic knowledge of both is required.</p>
</blockquote>
<h2 id="the-issue">The issue</h2>
<p>The application can be used by multiple users with different roles. Each role has predefined set of permissions.</p>
<blockquote>
<p>This is also known as <a href="https://searchsecurity.techtarget.com/definition/role-based-access-control-RBAC">RBAC (Role based access control)</a>.</p>
</blockquote>
<h2 id="the-solution">The solution</h2>
<p>First of all, we need to define tables for <code>users</code> and <code>roles</code>. <code>users</code> table stores <code>id</code>, <code>email</code>, <code>password</code> and <code>roleId</code>. <code>roles</code> table stores only <code>id</code> and <code>name</code>.</p>
<blockquote>
<p>Tables' structure may be different in your application. We are going to use the simplest but sufficient structure to solve <a href="#the-issue">The issue</a></p>
</blockquote>
<p>As our roles has a predefined set of permissions which are not required to be changeable in runtime, we are going to define role permissions in the code. For each role we will have a separate function. Then depending on the role name, we will call that function to define permissions and create <code>Ability</code> instance. Using <code>Ability</code> instance we can guarantee that a user can do only what his role allows him to do.</p>
<blockquote>
<p>In the next Demo, we are not going to implement REST API as the main intention of this recipe is to solve <a href="#the-issue">The issue</a>.</p>
</blockquote>
<h2 id="demo">Demo</h2>
<p>To make things simple, we will use SQLite database. This also allows to quickly setup the demo on local machine and even run it in a browser.</p>
<p>The demo domain is very simple, this is an app that allows to invite users. This app has 2 roles:</p>
<ul>
<li><code>member</code> user can
<ul>
<li>invite any user</li>
<li>update information about himself</li>
</ul>
</li>
<li><code>admin</code> user can
<ul>
<li>manage everything</li>
</ul>
</li>
</ul>
<p>In order to start, we need to create a migration script for <code>users</code> and <code>roles</code> tables and seed our database with default records. To do this, we will use <a href="http://knexjs.org/">knex</a> SQL builder.</p>
<blockquote>
<p>We are not going to walk through knex&rsquo;s API and usage, so if you are not familiar with it, take some time to look through its documentation. Anyway, don&rsquo;t worry, it&rsquo;s quite expressive.</p>
</blockquote>
<details>
<summary>Initial migration</summary>
<div class="highlight" data-filename="migrations/20200401110244_init.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">up</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schema</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">integer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roleId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">unsigned</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>

      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">foreign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roleId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">references</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">inTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">down</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div></details>
<details>
<summary>Initial seeds</summary>
<div class="highlight" data-filename="seeds/init.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">()]);</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin&#34;</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member&#34;</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">roleId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">roleId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div></details>
<p>Now, let&rsquo;s define all possible actions and subjects.</p>
<h3 id="abilities">Abilities</h3>
<p>This app has only <code>User</code> subject, users can only <code>update</code> himself and invite other users, so:</p>
<div class="highlight" data-filename="appAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;invite&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">subjects</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">actions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">subjects</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Exclude</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">typeof</span> <span style="color:#c4a000">subjects</span><span style="color:#a40000">[</span><span style="color:#c4a000">number</span><span style="color:#a40000">],</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">all</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbilities</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>
</code></pre></div><blockquote>
<p>See <a href="../../advanced/typescript#useful-type-helpers">TypeScript support</a> to get details about type helpers.</p>
</blockquote>
<p><code>typeof actions[number]</code> converts readonly array into union of its values, this allows to reuse actions and subjects defined in value scope inside type scope.</p>
<p>Having all possible subjects and actions, we can define roles' permissions in the same file:</p>
<div class="highlight" data-filename="appAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../models/User&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// abilities definition from previous example
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">DefinePermissions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">builder</span>: <span style="color:#204a87;font-weight:bold">AbilityBuilder</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Roles</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;member&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rolePermissions</span>: <span style="color:#204a87;font-weight:bold">Record</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Roles</span><span style="color:#a40000">,</span> <span style="color:#c4a000">DefinePermissions</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">member</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invite&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">user.id</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000">admin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><blockquote>
<p>Do you see how readable this definition object is? The function signature says &ldquo;member user can&rdquo; and the body describes what the member user can do. Looks very similar to how we described our requirements at the beginning of <a href="#demo">Demo</a> section, don&rsquo;t it?</p>
</blockquote>
<p>We imported <code>User</code> data class in order to make our functions a bit more strongly typed, its shape is the following:</p>
<div class="highlight" data-filename="models/User.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">role</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>We created <code>rolePermissions</code> object that holds our permission definitions functions instead of using regular functions. This allows us to retrieve role specific function by accessing properties of this object, this is very convenient and efficient.</p>
</blockquote>
<p>Finally, let&rsquo;s create a function that defines <code>Ability</code> instance for our user, let&rsquo;s do this in the same file:</p>
<div class="highlight" data-filename="services/appAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../models/User&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// abilities definition from the example above
</span><span style="color:#8f5902;font-style:italic">// roles definition from the example above
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AppAbility</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">builder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">rolePermissions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">role</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;function&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">rolePermissions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">role</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">builder</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Trying to use unknown role &#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">role</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;`</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">builder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>We need to ensure that permissions' definition function for a particular role exists because TypeScript can&rsquo;t help us to ensure that roles in the database reflects our types. So, we fail fast.</p>
</blockquote>
<h3 id="putting-together">Putting together</h3>
<p>First of all, we need a function that returns a user by its email and another one that updates a user by its id:</p>
<div class="highlight" data-filename="services/users.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">db</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./db&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./models/User&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">findUserByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users.email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;roles.name&#34;</span> <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">innerJoin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;roles.id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users.roleId&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserChanges</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Exclude</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">User</span><span style="color:#a40000">,</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">role</span><span style="color:#a40000">&#34;</span> <span style="color:#a40000">|</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">id</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">updateUserById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">changes</span>: <span style="color:#204a87;font-weight:bold">UserChanges</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">changes</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now we can implement <code>updateUserDetails</code> function:</p>
<div class="highlight" data-filename="updateUserDetails.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">findUserByEmail</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updateUserById</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UserChanges</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/users&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">updateUserDetails</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#8f5902;font-style:italic">/** email of a user who initiates the request (i.e., logged in user) */</span>
  <span style="color:#000">initiatorEmail</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#8f5902;font-style:italic">/** an email of user to be updated */</span>
  <span style="color:#000">userToBeUpdatedEmail</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#8f5902;font-style:italic">/** an object of changes to be applied */</span>
  <span style="color:#000">changes</span>: <span style="color:#204a87;font-weight:bold">UserChanges</span>
<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findUserByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">initiatorEmail</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">userToBeUpdated</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userToBeUpdatedEmail</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">initiatorEmail</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">user</span> : <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findUserByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userToBeUpdatedEmail</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userToBeUpdated</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">updateUserById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userToBeUpdated</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">changes</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>We intentionally made this function to accept both initiator and user whose details needs to be updated in order to show that permissions' logic works correctly. In real world apps, this function should accept only initiator and update his details!</p>
</blockquote>
<p>Let&rsquo;s go line by line in order to understand the code:</p>
<ol>
<li>We created <code>updateUserDetails</code> that accepts 3 arguments: 1st represents user&rsquo;s email who initiates the request (i.e., logged in user), 2nd is an email of a user whose details will be updated and 3rd is an object of changes.</li>
<li>Inside the function, we find initiator user in order to create <code>Ability</code> instance for it.</li>
<li>We also find user whose details needs to be updated, so we have his id.</li>
<li>Using <code>ForbiddenError</code> class, we ensure that user can update own details. If not, a <code>ForbiddenError</code> will be thrown. Also pay attention that we call <code>subject</code> function. It assigns a particular subject type to a plain JavaScript object (see <a href="../../guide/subject-type-detection#subject-helper">subject helper</a> for details).</li>
<li>We call <code>updateUserById</code> function to update user details by id in the database.</li>
</ol>
<p>To test this function, let&rsquo;s create a simple script:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">updateUserDetails</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./updateUserDetails&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">updateUserDetails</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;654321&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: own details were successfully updated&#34;</span><span style="color:#000;font-weight:bold">))</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: cannot update own details&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">updateUserDetails</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;admin@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;654321&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: admin details were successfully updated&#34;</span><span style="color:#000;font-weight:bold">))</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: admin details are NOT ALLOWED to be updated&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>If you run this code, you will get:</p>
<pre tabindex="0"><code>[member]: own details were successfully updated
[member]: admin details are NOT ALLOWED to be updated
</code></pre><p>At this point, you have enough details to implement <code>inviteUser</code> function by yourself ;) So, we will just go through its logic:</p>
<ol>
<li><code>inviteUser</code> accepts 2 arguments: initiator&rsquo;s email and email of the user to be invited.</li>
<li>Retrieve initiator user by its email.</li>
<li>Check that initiator is allowed to invite a user.</li>
<li>Check if the user to be invited has not been registered in the system before.</li>
<li>If not, send an email to this user with invitation message.</li>
</ol>
<h3 id="conclusion">Conclusion</h3>
<p>That&rsquo;s it! You now have a powerful role based access control powered by CASL! We hope this tutorial was helpful and made your understanding of CASL.js even better :)</p>
<h2 id="alternative-patterns">Alternative patterns</h2>
<p>This pattern is very powerful and scales very good. Even if at some point in the future, you will need to allow users to change permissions dynamically (e.g., via REST API or User Interface), you can easily do this, read <a href="../roles-with-persisted-permissions">Roles with persisted permissions</a> recipe for details.</p>
<p>If you need to implement claim based permissions, check <a href="../claim-authorization">Claim based Authorization</a> recipe.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7afd37d55b8ffbfe5b2b6d5b29e6800b">4.6 - Roles with persisted permissions</h1>
    
	<blockquote>
<p>This recipe targets backend developers. We use <a href="https://www.typescriptlang.org">TypeScript</a> and <a href="https://en.wikipedia.org/wiki/Relational_database">RDBMS</a> in this guide, so the basic knowledge of both is required.</p>
</blockquote>
<h2 id="the-issue">The issue</h2>
<p>The application can be used by multiple users with different roles. Roles' permissions should be configurable through API (e.g., REST API or User Interface). So, we don&rsquo;t need to change or redeploy the app in order to change permissions.</p>
<blockquote>
<p>This is also known as <a href="https://searchsecurity.techtarget.com/definition/role-based-access-control-RBAC">RBAC (Role based access control)</a>.</p>
</blockquote>
<h2 id="the-solution">The solution</h2>
<p>In order to achieve this, we need to store permissions in the database.</p>
<p>First of all, we need to gather all possible actions and subjects, in order to validate them before saving permission to the database.</p>
<p>When all combinations of actions and subjects are known, we can create a table for <code>roles</code>. It should have at least 2 columns: <code>id</code> and <code>name</code>. Then we need to choose one of 2 options to connect roles with permissions:</p>
<ol>
<li>Add <code>permissions</code> column of JSON (or TEXT) data type into <code>roles</code> and store all rules in that single column.<br>
<strong>The main advantage</strong> is that it&rsquo;s very simple to manage and retrieve.
<strong>The main disadvantage</strong> is that most ORMs doesn&rsquo;t support partial updates of JSON (and especially TEXT) column, instead they update the whole value as a primitive value. This may lead to unexpected results if several users update permissions of the same role at the same time (the last one will reset changes of others).</li>
<li>Create a separate table for <code>permissions</code> which has <code>action</code>, <code>subject</code>, <code>conditions</code> and <code>roleId</code> fields.<br>
<strong>The main advantage</strong> is that you can do partial updates using regular SQL.
<strong>The main disadvantage</strong> more complicated queries (you need to join <code>roles</code> and <code>permissions</code>) and bigger eventual database size.</li>
</ol>
<p>We will use the 1st option in this guide because permissions are not changed often, so the risk of conflict is acceptable for us. Moreover this <code>permissions</code> field will contain an array that is acceptable by <code>Ability</code> instance (i.e., <code>RawRuleOf&lt;AppAbility&gt;[]</code>).</p>
<blockquote>
<p>If it&rsquo;s not acceptable for your situation, use raw SQL syntax of your RDBMS to partially update JSON column or use 2nd option.</p>
</blockquote>
<p>We also need a table for <code>users</code>. Every user may have only 1 role, in other words every row in <code>users</code> table should have <code>roleId</code> field.</p>
<p>Having users, roles and permissions, we can create <code>Ability</code> instance for every user request. The logic for the REST API is the following:</p>
<ol>
<li>User sends request to access some resources.</li>
<li>If it&rsquo;s not authenticated, sends back an error that he needs to login.</li>
<li>If it&rsquo;s authenticated, the app fetches it together with permissions from the database.</li>
<li>The app creates an <code>Ability</code> instance based on user&rsquo;s permissions</li>
<li>Using <code>Ability</code> instance, the app checks whether user can do a particular action on requested resource.</li>
<li>If not, it&rsquo;s sends error back that user has no permission to do what he attempted to do.</li>
<li>If user has permissions, then proceed with the actual action.</li>
</ol>
<p>Enough theory, let&rsquo;s see some examples!</p>
<blockquote>
<p>In the next Demo, we are not going to implement REST API as the main intention of this recipe is to solve <a href="#the-issue">The issue</a>.</p>
</blockquote>
<h2 id="demo">Demo</h2>
<p>To make things simple, we will use SQLite database. This also allows to quickly setup the demo on local machine and even run it in a browser.</p>
<p>As a domain, we will use blog application. This is the most known domain, so we won&rsquo;t spent time explaining its details and instead will concentrate on the actual issue.</p>
<p>In our blog, we have 2 roles: <code>member</code> (any registered user) and <code>admin</code>. So, <code>admin</code> can do everything and <code>member</code>:</p>
<ul>
<li>can read all articles</li>
<li>can manage own articles</li>
</ul>
<p>We will use <a href="http://knexjs.org/">knex</a> SQL builder to work with the database.</p>
<blockquote>
<p>We are not going to walk through knex&rsquo;s API and usage, so if you are not familiar with it, take some time to look through its documentation. Anyway, don&rsquo;t worry, it&rsquo;s quite expressive.</p>
</blockquote>
<p>So, let&rsquo;s define the table structure for our database. It includes 3 tables: <code>users</code>, <code>roles</code> and <code>articles</code>. Also we will seed our database with default records:</p>
<ul>
<li>2 roles: admin and member</li>
<li>2 users: 1 admin and 1 member</li>
</ul>
<p>You can find the migration and seeds below:</p>
<details>
<summary>Initial migration</summary>
<div class="highlight" data-filename="migrations/20200401110234_init.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">up</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schema</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">integer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roleId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">unsigned</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>

      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">foreign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roleId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">references</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">inTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;articles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">integer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authorId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">unsigned</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>

      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">foreign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authorId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">references</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">inTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;permissions&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">down</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;articles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div></details>
<p>and initial seed:</p>
<div class="highlight" data-filename="seeds/init.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">()]);</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">permissions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">([{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;all&#34;</span> <span style="color:#000;font-weight:bold">}]),</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">permissions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">([</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">},</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">conditions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${user.id}&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">]),</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">roleId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">roleId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><blockquote>
<p>We used <code>${user.id}</code> in <code>conditions</code> property of permissions. This is just a placeholder which we will replace it later with the id of a particular user.</p>
</blockquote>
<p>Now, let&rsquo;s define all possible actions and subjects:</p>
<div class="highlight" data-filename="services/appAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">RawRuleOf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ForcedSubject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">subjects</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Abilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">actions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">subjects</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Exclude</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">typeof</span> <span style="color:#c4a000">subjects</span><span style="color:#a40000">[</span><span style="color:#c4a000">number</span><span style="color:#a40000">],</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">all</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span>: <span style="color:#204a87;font-weight:bold">RawRuleOf</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;[])</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><blockquote>
<p>See <a href="../../advanced/typescript#useful-type-helpers">TypeScript support</a> to get details about type helpers.</p>
</blockquote>
<p><code>typeof actions[number]</code> converts readonly array into union of its values, this allows to reuse actions and subjects defined in value scope inside type scope. We also export <code>createAbility</code> function to make it easier to create <code>Ability</code> instance with bound generic parameters.</p>
<p>In order to work with our database on higher level, we need to create services.</p>
<h3 id="services">Services</h3>
<p>We need to create 2 services: one to fetch <code>users</code> and another to manage <code>articles</code>.</p>
<p>Let&rsquo;s start from a function that will allow us to fetch a single user by some conditions from the database. This function also will prepare user&rsquo;s permissions, so we can directly pass them in <code>createAbility</code> function:</p>
<div class="highlight" data-filename="services/users.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">db</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../db&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../models/User&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">interpolate</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../helpers/interpolate&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">findBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">where</span>: <span style="color:#204a87;font-weight:bold">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Record</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">keyof</span> <span style="color:#c4a000">User</span><span style="color:#a40000">,</span> <span style="color:#c4a000">any</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">...</span><span style="color:#000">user</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">innerJoin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users.roleId&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;roles.id&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users.email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;roles.permissions&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;roles.name&#34;</span> <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">permissions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">interpolate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">user</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Let&rsquo;s go line by line to understand what happens in the function:</p>
<ul>
<li>
<p>we import <code>db</code>, this is a knex connection instance</p>
</li>
<li>
<p>we import <code>User</code>, this is just an interface for users that has the next shape:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">RawRuleOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../services/appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">role</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">permissions</span>: <span style="color:#204a87;font-weight:bold">RawRuleOf</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;[];</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>As you can see, its permissions property has the type that <code>Ability</code> instance accepts in the first parameter. This was done intentionally to simplify ability creation.</p>
</li>
<li>
<p>we import <code>interpolate</code> function, this function takes a JSON template and replaces all placeholder (e.g., <code>${user.id}</code>) with the provided variables inside context. This function uses <code>reviver</code> argument of <code>JSON.parse</code> method to iterate deeply over the object but it&rsquo;s not important for this guide. You can use any template library you like (e.g., <a href="https://mustache.github.io/">mustache</a>, <a href="http://underscorejs.org/#template">underscore template</a>).</p>
</li>
<li>
<p>in <code>findBy</code> function, we join users and roles to get user&rsquo;s permissions and role and preprocess permissions' template with the <code>interpolate</code> function (so that, it replaces <code>${user.id}</code> placeholders with the actual <code>user.id</code> value).</p>
</li>
</ul>
<p>The service for articles is more complicated, it will check users' ability to do a particular action on the provided article instance. For the sake of simplicity, we&rsquo;ll show only <code>create</code> function (all the rest are similar):</p>
<div class="highlight" data-filename="services/articles.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">db</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../db&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../models/Article&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">articles</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Article</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#4e9a06">&#34;articles&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span>: <span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">partialArticle</span>: <span style="color:#204a87;font-weight:bold">Omit</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Article</span><span style="color:#a40000">,</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">id</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">partialArticle</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">partialArticle</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">...</span><span style="color:#000">partialArticle</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// other functions
</span></code></pre></div><p>In this service, we use <code>ForbiddenError</code> class which allows to throw an error if user doesn&rsquo;t have an ability to do something. We also wrap <code>partialArticle</code> with <code>subject</code> call. This allows <code>Ability</code> instance to detect subject type of a plain object.</p>
<blockquote>
<p>See <a href="../../guide/subject-type-detection#subject-helper">Subject type detection</a> for details.</p>
</blockquote>
<p><code>Article</code> is an interface that enforces the shape of our articles:</p>
<div class="highlight" data-filename="models/Article.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">description</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now, when service layer is finished, we can put it together!</p>
<h3 id="putting-together">Putting together</h3>
<p>We need to start from connecting things together, to do so we need to fetch users and create <code>Ability</code> instances for each one:</p>
<div class="highlight" data-filename="main.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">findBy</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/users&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">createAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">main() {</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">admin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">author</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">findBy</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin@casl.io&#34;</span> <span style="color:#000;font-weight:bold">}),</span> <span style="color:#000">findBy</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member@casl.io&#34;</span> <span style="color:#000;font-weight:bold">})]);</span>

  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">adminAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">admin</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">authorAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">author</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// the rest of the code
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>We also need to create 2 articles, one that is written by admin and another by author:</p>
<div class="highlight" data-filename="main.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#8f5902;font-style:italic">// imports here
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">main() {</span>
  <span style="color:#8f5902;font-style:italic">// fetch users &amp; create ability instances
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">adminArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;CASl and TypeScript&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Is very powerful&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">admin</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">};</span>

  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">authorArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;CASl and TypeScript&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Is very powerful&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">author</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">};</span>

  <span style="color:#8f5902;font-style:italic">// the rest of the code
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And finally let&rsquo;s check our permissions:</p>
<ul>
<li><code>admin</code> user should be able to create article in spite of who wrote it</li>
<li><code>member</code> user should be able to only create articles that were written by him</li>
</ul>
<div class="highlight" data-filename="main.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#8f5902;font-style:italic">// other imports here
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">articles</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/articles&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">main() {</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adminAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">adminArticle</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[admin]: created article written by himself&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">authorAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">adminArticle</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: cannot create an article written by admin&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adminAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">authorArticle</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[admin]: created article written by author&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">authorAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">authorArticle</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[author]: created article written by himself&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;\nAll articles &#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rawArticles</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#000">rawArticles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forEach</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">article</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">prefix</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authorId</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">admin</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#4e9a06">&#34;[admin]&#34;</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;[author]&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">prefix</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">${</span><span style="color:#000">article</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Let&rsquo;s call <code>main</code> function and see the results:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ npm start

<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by himself
<span style="color:#ce5c00;font-weight:bold">[</span>author<span style="color:#ce5c00;font-weight:bold">]</span>: cannot create an article written by admin
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by author
<span style="color:#ce5c00;font-weight:bold">[</span>author<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by himself

All articles
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>author<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>author<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
</code></pre></div><p>Everything works as we it should! Now let&rsquo;s allow members to create any article. To do so, we need to update permissions of <code>member</code> role and we will do this using <a href="http://knexjs.org/">knex</a>:</p>
<div class="highlight" data-filename="updateMemberRole.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">db</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./db&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">db</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#000">permissions</span>: <span style="color:#204a87;font-weight:bold">JSON.stringify</span><span style="color:#000;font-weight:bold">([</span>
      <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">conditions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${user.id}&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">]),</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;member&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Permissions of &#34;member&#34; role has been updated&#39;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">destroy</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>After updating member&rsquo;s permissions and running <code>main</code> function again, we got this results:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ npm start

<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: created own article
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by admin &lt;---
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by author
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by himself

All articles
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
</code></pre></div><p>As you can see, member is now allowed to create articles created by admins!</p>
<h3 id="conclusion">Conclusion</h3>
<p>That&rsquo;s it! You now have a fully manageable CASL powered permissions logic in your app. We hope this tutorial was helpful and made your development experience with CASL.js even more enjoyable :)</p>
<p>You can find the source code of this solution on <a href="https://github.com/stalniy/casl-persisted-permissions-example">Github</a>.</p>
<h2 id="when-to-avoid">When to avoid</h2>
<ol>
<li>If you have a predefined set of permissions for every role which very unlikely to change.</li>
<li>If you start a new project and not sure whether you need to dynamically configure permissions.</li>
</ol>
<h2 id="alternative-patterns">Alternative patterns</h2>
<p>As an alternative you can implement <a href="../roles-with-static-permissions">predefined permissions with CASL</a>. It brings the same benefits but with less overhead.</p>
<p>If you need to implement claim based permissions, check <a href="../claim-authorization">Claim based Authorization</a> recipe.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-db699884bd3aedc1fbac2328d8409e60">5 - api</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-2f7a9f5a690448dfd87b7e5b19fb16e6">5.1 - @casl/ability API</h1>
    
	<p><code>@casl/ability</code> contains 2 modules:</p>
<ul>
<li>
<p>core module which provides <code>Ability</code> and other core classes</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">core</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div></li>
<li>
<p>extra module which provides additional helper functions</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">extra</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div></li>
</ul>
<p>This page describes API documentation for core package only. Check <a href="../casl-ability-extra">@casl/ability/extra API</a> to get information about helper functions.</p>
<blockquote>
<p>All examples on this page uses <a href="https://www.typescriptlang.org/">TypeScript</a></p>
</blockquote>
<h2 id="pureability">PureAbility</h2>
<p><code>PureAbility</code> is a base class that implements the functionality of checking permissions. The prefix &ldquo;Pure&rdquo; has nothing to do with functional programming. It just means this class has no predefined configuration.</p>
<p>It is a generic class that accepts 2 parameters:</p>
<ol>
<li><code>Abilities</code> is either a string literal type that represents possible actions or a tuple of 2 elements that represents all possible actions on all possible subjects. By default, equals to <code>[string, Subject]</code></li>
<li><code>Conditions</code> is a shape of conditions. There is no restriction on this parameter, so it can be anything.</li>
</ol>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PureAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Abilities</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ClaimAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PureAbility</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PureAbility</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p><strong>See also</strong>: <a href="../../advanced/typescript">TypeScript Support</a></p>
<h3 id="pureability-constructor">PureAbility constructor</h3>
<ul>
<li>
<p><strong>Parameters</strong> (<code>A</code> is shortened from <code>Abilities</code>):</p>
<ul>
<li><code>rules: RawRuleFrom&lt;A, Conditions&gt;[] = []</code></li>
<li><code>options: AbilityOptions&lt;A, Conditions&gt; = {}</code>
<ul>
<li><code>detectSubjectType?: (subject?: Subject) =&gt; string</code>
allows to check <a href="../../guide/subject-type-detection">subject type detection</a> logic</li>
<li><code>conditionsMatcher?: ConditionsMatcher&lt;Conditions&gt;</code>
allows to change the language to match conditions. See <a href="../../advanced/customize-ability">Customize Ability</a> for details</li>
<li><code>fieldMatcher?: FieldMatcher</code>
allows to change the logic how fields are matched. See <a href="../../advanced/customize-ability#custom-field-matcher">Custom field matcher</a> for details</li>
<li><code>resolveAction?: ResolveAction&lt;Normalize&lt;A&gt;[0]&gt;</code>
allows to pass a function that resolves aliases to actions. See <a href="../../guide/define-aliases">Define action aliases</a> for details</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Usage</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PureAbility</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>
</code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="../../guide/define-rules">Define rules</a></p>
</li>
</ul>
<h3 id="update">update</h3>
<p>Updates rules of <code>PureAbility</code> instance. This method completely replaces all previously define rules with new ones.</p>
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>rules: RawRuleFrom&lt;A, Conditions&gt;[]</code></li>
</ul>
</li>
<li>
<p><strong>Returns</strong>: <code>this</code></p>
</li>
<li>
<p><strong>Emits</strong>:</p>
<ul>
<li><code>update</code> - before updating instance</li>
<li><code>updated</code> - after instance has been updated</li>
</ul>
</li>
<li>
<p><strong>Usage</strong><br>
Use it when you need to update permissions. In the common scenario, you need to do this on login, logout and when user permissions are changed.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PureAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PureAbility</span><span style="color:#000;font-weight:bold">([{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;all&#34;</span> <span style="color:#000;font-weight:bold">}]);</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">([]);</span> <span style="color:#8f5902;font-style:italic">// took back all permissions
</span></code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="../../guide/intro">CASL guide</a></p>
</li>
</ul>
<h3 id="can-of-pureability">can of PureAbility</h3>
<p>Checks that the provided action and subject satisfy permissions. Depending on <code>Abilities</code> generic parameter this function accepts either single <code>action</code> argument (when <code>Abilities</code> is a string) or 3 arguments (when <code>Abilities</code> is a tuple).</p>
<ul>
<li>
<p><strong>Parameters</strong></p>
<ul>
<li><code>action: string</code> - an action to check</li>
<li><code>subject: Subject</code> - a subject to check</li>
<li><code>field?: string</code> - a field to check</li>
</ul>
</li>
<li>
<p><strong>Returns</strong>: <code>boolean</code></p>
</li>
<li>
<p><strong>Usage</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">PureAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">claimAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PureAbility</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#8f5902;font-style:italic">// the 1st generic is a string, so the method accepts only single parameter
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">claimAbility</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PureAbility</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#8f5902;font-style:italic">// the 1st argument is a tuple, so the method accepts 2-3 parameters
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="../../guide/intro">CASL guide</a></p>
</li>
</ul>
<h3 id="cannot-of-pureability">cannot of PureAbility</h3>
<p>This method works the same way as <a href="#can-of-pure-ability">can</a> but returns inverted result.</p>
<h3 id="relevantrulefor">relevantRuleFor</h3>
<p>This method returns a rule that matches provided action, subject and field. If rule cannot be found it returns <code>null</code>. May be useful for debugging.</p>
<ul>
<li><strong>Parameters</strong>: accepts the same parameters as <a href="#can-of-pure-ability">can</a></li>
<li><strong>Returns</strong>: <code>Rule&lt;Abilities, Conditions&gt; | null</code></li>
<li><strong>See also</strong>: <a href="../../advanced/debugging-testing">Debugging and testing</a></li>
</ul>
<h3 id="rulesfor">rulesFor</h3>
<p>This method returns all registered rules for provided action, subject and field. Useful for debugging and for extensions. Contrary to <code>relevantRuleFor</code> accepts subject type as the 2nd argument or:</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>action: string</code> - an action to check</li>
<li><code>subjectType: SubjectType</code> - a subject type to check (this one is optional if <code>Abilities</code> is a string literal type)</li>
<li><code>field?: string</code> - a field to check</li>
</ul>
</li>
<li><strong>Returns</strong>: <code>Rule&lt;Abilities, Conditions&gt;[]</code></li>
</ul>
<h3 id="possiblerulesfor">possibleRulesFor</h3>
<p>Similar to <a href="#rules-for">rulesFor</a> but it accepts only up to 2 parameters (depending on the type of 1st generic parameter). Returns all possible rules ignoring field level restrictions. Useful for debugging and for extensions.</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>action: string</code></li>
<li><code>subjectType: SubjectType</code></li>
</ul>
</li>
<li><strong>Returns</strong>: <code>Rule&lt;Abilities, Conditions&gt;[]</code></li>
</ul>
<h3 id="on">on</h3>
<p>Allows to register event handler on specific event. Currently, only 2 events are supported:</p>
<ul>
<li>
<p><code>update</code>, triggered before an instance is updated</p>
</li>
<li>
<p><code>updated</code>, triggered after an instance is updated</p>
</li>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>event: 'update' | 'updated'</code></li>
<li><code>handler: (event: Event) =&gt; void</code></li>
</ul>
</li>
<li>
<p><strong>Returns</strong>: a function that removes event handler</p>
</li>
<li>
<p><strong>Usage</strong><br>
Useful for frontend frameworks integration. Usually you have a single ability instance in the app and a lot of places which need to recheck permissions when the instance&rsquo;s rules are changed.</p>
</li>
</ul>
<h3 id="rules-property-of-pureability">rules property of PureAbility</h3>
<p>Returns an array of <code>RawRule</code>s passed in <code>PureAbility</code> constructor.</p>
<h3 id="detectsubjecttype">detectSubjectType</h3>
<p>Can be used to detect subject type of object. Works for both subject types and subject instances.</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>subject: Subject</code></li>
</ul>
</li>
<li><strong>Returns</strong>: <code>string</code></li>
</ul>
<h2 id="ability">Ability</h2>
<p><code>Ability</code> extends <a href="#pure-ability"><code>PureAbility</code></a>. It sets default values for 2 options:</p>
<ul>
<li><code>conditionsMatcher</code> into <a href="#mongo-query-matcher"><code>mongoQueryMatcher</code></a></li>
<li><code>fieldMatcher</code> into <a href="#field-pattern-matcher"><code>fieldPatternMatcher</code></a>.</li>
</ul>
<p>It also enforces <code>MongoQuery</code> restriction on the <code>Conditions</code> generic parameter. By default, it is <code>Ability&lt;Abilities, MongoQuery&gt;</code>.</p>
<h2 id="abilitybuilder">AbilityBuilder</h2>
<p>This class allows to define <code>Ability</code> or <code>PureAbility</code> instance in declarative way. It accepts a single generic parameter <code>T extends AnyAbility</code>. You don&rsquo;t need to provide it, as TypeScript will always infer it for you (just don&rsquo;t forget to pass class of <code>Ability</code> in constructor).</p>
<h3 id="abilitybuilder-constructor">AbilityBuilder constructor</h3>
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>AbilityType: AbilityClass&lt;TAbility&gt;</code></li>
</ul>
</li>
<li>
<p><strong>Usage</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="../../guide/define-rules">Define rules</a></p>
</li>
</ul>
<h3 id="can-of-abilitybuilder">can of AbilityBuilder</h3>
<p>Registers a <code>RawRule</code> instance in <code>rules</code> array. Depending on the passed in <code>Ability</code> generic parameter, this function accepts either single <code>action</code> argument (when <code>Abilities</code> generic of <code>Ability</code> is a string) or 3 arguments (when <code>Abilities</code> is a tuple). In general it accepts 1-4 parameters.</p>
<ul>
<li>
<p><strong>Parameters</strong>: this method has 2 overloads</p>
<ul>
<li><code>action: string | string[]</code></li>
<li><code>subjectType: string | Function</code></li>
<li><code>fields: string[]</code></li>
<li><code>conditions: Conditions</code></li>
<li><strong>and</strong></li>
<li><code>action: string | string[]</code></li>
<li><code>subjectType: string | Function</code></li>
<li><code>conditions: Conditions</code></li>
</ul>
</li>
<li>
<p><strong>Returns</strong> <code>RuleBuilder</code>, a class that allows to further change constructed <code>RawRule</code> (e.g., add forbidden reason).</p>
</li>
<li>
<p><strong>Usage</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PureAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// action only Ability type
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ClaimAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PureAbility</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ClaimAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PureAbility</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ClaimAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ClaimAbility</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// or action and subject Ability type
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;firstName&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;lastName&#34;</span><span style="color:#000;font-weight:bold">]);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="../../guide/define-rules">Define rules</a></p>
</li>
</ul>
<h3 id="cannot-of-abilitybuilder">cannot of AbilityBuilder</h3>
<p>Registers an inverted <code>RawRule</code> inside <code>AbilityBuilder</code>. Accepts the same parameters and has the same behavior as <a href="#can-of-ability-builder">can method</a>.</p>
<h3 id="build">build</h3>
<p>Builds an instance of provided <code>Ability</code> class.</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>options?: AbilityOptionsOf&lt;TAbility&gt;</code></li>
</ul>
</li>
<li><strong>Returns</strong> a new <code>TAbility</code> instance</li>
</ul>
<h3 id="rules-property-of-abilitybuilder">rules property of AbilityBuilder</h3>
<p>Contains an array of <code>RawRule</code>s registered by <a href="#can-of-ability-builder"><code>can</code></a> and <a href="#cannot-of-ability-builder"><code>cannot</code></a> methods.</p>
<h2 id="defineability">defineAbility</h2>
<p>This function allows to define <a href="#ability"><code>Ability</code></a> instance in a compact form. Cannot be used to create <code>PureAbility</code> instances. It&rsquo;s very useful for writing tests and documentation.</p>
<ul>
<li><strong>Signature</strong> (<code>T</code> is <code>TAbility</code>):
<ul>
<li><code>&lt;T extends AnyAbility&gt;(define: DSL&lt;T, void&gt;, options?: AbilityOptionsOf&lt;T&gt;) =&gt; T</code></li>
<li><code>&lt;T extends AnyAbility&gt;(define: DSL&lt;T, Promise&lt;void&gt;&gt;, options?: AbilityOptionsOf&lt;T&gt;) =&gt; Promise&lt;T&gt;</code></li>
</ul>
</li>
<li><strong>See also</strong>: <a href="../../guide/define-rules">Define rules</a></li>
</ul>
<h2 id="forbiddenerror">ForbiddenError</h2>
<p>This class is useful if you want to stop execution of the next code in case if user doesn&rsquo;t have permission to do something. Has private <code>constructor</code>, so cannot be instantiated with <code>new</code> (in TypeScript). It&rsquo;s a generic class that accepts <code>TAbility</code> as a single parameter. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// fetch article from database
</span></code></pre></div><h3 id="static-from">static from</h3>
<p>Creates a <code>ForbiddenError</code> instance from provided <code>Ability</code> instance.</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>ability: TAbility</code></li>
</ul>
</li>
<li><strong>Returns</strong> <code>ForbiddenError</code> instance</li>
</ul>
<h3 id="static-setdefaultmessage">static setDefaultMessage</h3>
<p>Allows to change default error message for all <code>ForbiddenError</code>s. By default, the error is <code>Cannot execute &quot;${error.action}&quot; on &quot;${error.subjectType}&quot;</code></p>
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>messageOrFn: string | GetErrorMessage</code> - message or function that returns string</li>
</ul>
</li>
<li>
<p><strong>Returns</strong> void</p>
</li>
<li>
<p><strong>Usage</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setDefaultMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Not authorized&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// or more verbose
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setDefaultMessage</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#4e9a06">`You are not allowed to </span><span style="color:#4e9a06">${</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">action</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> on </span><span style="color:#4e9a06">${</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subjectType</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div></li>
</ul>
<h3 id="setmessage">setMessage</h3>
<p>Changes message of a particular <code>ForbiddenError</code> instance.</p>
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>message: string</code></li>
</ul>
</li>
<li>
<p><strong>Returns</strong> <code>this</code></p>
</li>
<li>
<p><strong>Usage</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">setMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You cannot update posts&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div></li>
</ul>
<h3 id="throwunlesscan">throwUnlessCan</h3>
<p>Accepts the same parameters as <a href="#can-of-pure-ability">PureAbility&rsquo;s can method</a>. Throws a <code>ForbiddenError</code> if user cannot do the provided action on provided subject.</p>
<h2 id="getdefaulterrormessage">getDefaultErrorMessage</h2>
<p>A function that returns default error message for <code>ForbiddenError</code>. Is useful to revert back default message after setting it using <a href="#static-set-default-message"><code>ForbiddenError.setDefaultMessage</code></a>.</p>
<h2 id="fieldpatternmatcher">fieldPatternMatcher</h2>
<p>This factory function accepts an array of fields and creates a function that matches fields by patterns using wildcards (i.e., <code>*</code>). It&rsquo;s used as a default field matcher option in <code>Ability</code> class.</p>
<ul>
<li>
<p><strong>Factory Parameters</strong>:</p>
<ul>
<li><code>fields: string[]</code></li>
</ul>
</li>
<li>
<p><strong>Factory Returns</strong> <code>MatchField</code></p>
</li>
<li>
<p><strong>Matcher Parameters</strong>:</p>
<ul>
<li><code>field: string</code></li>
</ul>
</li>
<li>
<p><strong>Matcher Returns</strong> <code>boolean</code></p>
</li>
<li>
<p><strong>Usage</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">fieldPatternMatcher</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">matchField</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fieldPatternMatcher</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.**&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">matchField</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">matchField</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="#ability">Ability API</a>, <a href="../../guide/restricting-fields">Restricting field access</a>, <a href="../../advanced/customize-ability">Customize Ability</a></p>
</li>
</ul>
<h2 id="mongoquerymatcher">mongoQueryMatcher</h2>
<p>This factory function creates a matcher that matches subjects based on <a href="http://docs.mongodb.org/manual/reference/operator/query/">MongoDB query language</a>. It&rsquo;s used as a default field matcher option in <code>Ability</code> class.</p>
<ul>
<li>
<p><strong>Factory Parameters</strong>:</p>
<ul>
<li><code>conditions: MongoQuery</code></li>
</ul>
</li>
<li>
<p><strong>Factory Returns</strong> <code>ConditionsMatcher&lt;MongoQuery&gt;</code></p>
</li>
<li>
<p><strong>Matcher Parameters</strong>:</p>
<ul>
<li><code>object: Record&lt;PropertyKey, any&gt;</code></li>
</ul>
</li>
<li>
<p><strong>Matcher Returns</strong> <code>boolean</code></p>
</li>
<li>
<p><strong>Usage</strong><br>
Can be passed as <code>conditionsMatcher</code> option to <code>Ability</code> and <code>PureAbility</code> classes</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">mongoQueryMatcher</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">matchConditions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mongoQueryMatcher</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">matchConditions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">}));</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">matchConditions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="#ability">Ability API</a>, <a href="../../guide/conditions-in-depth">Conditions in depth</a>, <a href="../../advanced/customize-ability">Customize Ability</a></p>
</li>
</ul>
<h2 id="buildmongoquerymatcher">buildMongoQueryMatcher</h2>
<p>This is a factory of factory. It allows to extend <code>mongoQueryMatcher</code> with custom mongo operators. See <a href="https://github.com/stalniy/ucast">ucast</a> for details</p>
<ul>
<li><strong>Factory Parameters</strong>:
<ul>
<li><code>parsingInstructions: Record&lt;string, ParsingInstruction&gt;</code></li>
<li><code>interpreters: Record&lt;string, JsOperator&gt;</code></li>
</ul>
</li>
<li><strong>Factory Returns</strong> extended <code>mongoQueryMatcher</code></li>
<li><strong>Usage</strong><br>
The result of this function can be passed as <code>conditionsMatcher</code> option to <code>Ability</code> and <code>PureAbility</code> classes.</li>
<li><strong>See also</strong>: <a href="#mongo-query-matcher">mongoQueryMatcher API</a>, <a href="../../advanced/customize-ability">Customize Ability</a></li>
</ul>
<h2 id="createaliasresolver">createAliasResolver</h2>
<p>Creates a function that resolves alias to real actions. Can be passed as <code>resolveAction</code> option to <code>Ability</code> and <code>PureAbility</code> classes.</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>aliasMap: AliasMap</code></li>
</ul>
</li>
<li><strong>Returns</strong> <code>(action: string | string[]) =&gt; string | string[]</code></li>
<li><strong>See also</strong>: <a href="../../guide/define-aliases">Define Action Aliases</a></li>
</ul>
<h2 id="detectsubjecttype-1">detectSubjectType</h2>
<p>The default subject type detection logic. Can be passed as <code>detectSubjectType</code> option to <code>Ability</code> and <code>PureAbility</code> classes. Can be used to extend the default logic. The checking logic is the following:</p>
<ul>
<li>
<p>if <code>subject</code> is <code>undefined</code>, returns <code>all</code></p>
</li>
<li>
<p>if <code>subject</code> is a <code>ForcedSubject</code>, returns its forced type</p>
</li>
<li>
<p>if <code>subject</code> is an object, returns <code>constructor.modelName || constructor.name</code></p>
</li>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>subject?: {}</code></li>
</ul>
</li>
<li>
<p><strong>Returns</strong> a string (i.e., subject type)</p>
</li>
<li>
<p><strong>See also</strong>: <a href="../../guide/subject-type-detection">Subject type detection</a></p>
</li>
</ul>
<h2 id="subject">subject</h2>
<p>Sets subject type for a plain object. You shouldn&rsquo;t use this if you use classes or define custom <code>detectSubjectType</code> algorithm. Accepts 2 generic parameters <code>TSubjectType</code> and <code>TObject</code>.</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>subjectType: TSubjectType</code></li>
<li><code>object: TObject</code></li>
</ul>
</li>
<li><strong>Returns</strong> <code>TObject &amp; ForcesSubject&lt;TSubjectType&gt;</code></li>
<li><strong>See also</strong>: <a href="../../guide/subject-type-detection">Subject type detection</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9f3a20826f3b9b5582b8c565a1690611">5.2 - @casl/ability/extra API</h1>
    
	<h2 id="rulestoquery">rulesToQuery</h2>
<p>This is a helper iterator function that allows to aggregate conditions from permissions into a database query.</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>ability: TAbility</code></li>
<li><code>action: string</code></li>
<li><code>subjectType: SubjectType</code></li>
<li><code>convert: (rule: RuleOf&lt;TAbility&gt;) =&gt; object</code></li>
</ul>
</li>
<li><strong>Returns</strong> <code>null</code> if user is not allowed to run specified <code>action</code> on specified <code>subjectType</code>, otherwise returns an object of optional <code>$and</code> and <code>$or</code> fields. <code>$and</code> contains results of transformation from inverted rules and <code>$or</code> contains results of direct rules.</li>
<li><strong>See also</strong>: <a href="../../advanced/ability-to-database-query">Ability to database query</a>, <a href="../../package/casl-mongoose#accessible-records-plugin">@casl/mongoose</a></li>
</ul>
<h2 id="rulestoast">rulesToAST</h2>
<p>This function converts rules into <a href="github.com/stalniy/ucast">ucast</a> AST.</p>
<ul>
<li><strong>Parameters</strong>:
<ul>
<li><code>ability: TAbility</code></li>
<li><code>action: string</code></li>
<li><code>subjectType: SubjectType</code></li>
</ul>
</li>
<li><strong>Returns</strong> <code>null</code> if user is not allowed to run specified <code>action</code> on specified <code>subjectType</code>, otherwise returns AST.</li>
</ul>
<h2 id="rulestofields">rulesToFields</h2>
<p>This is a helper function that allows to extract field values from <code>Ability</code> conditions. This may be useful to extract default values from permissions for a new object.</p>
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>ability: TAbility</code></li>
<li><code>action: string</code></li>
<li><code>subjectType: SubjectType</code></li>
</ul>
</li>
<li>
<p><strong>Returns</strong> an object with values from conditions.</p>
</li>
<li>
<p><strong>Usage</strong><br>
This function processes values of conditions that are not objects. Makes sure to call <code>ability.can</code> on resulting object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">rulesToFields</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$regex</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">/^\[Draft\]/i</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">defaultValues</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rulesToFields</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defaultValues</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// { public: true, authorId: 1 }
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">newArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">...</span><span style="color:#000">defaultValues</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;...&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div></li>
</ul>
<h2 id="permittedfieldsof">permittedFieldsOf</h2>
<p>This function returns fields of <code>subject</code> which specified <code>action</code> may be applied on. Accepts single generic parameter <code>TAbility</code> (<code>T</code> to be short).</p>
<ul>
<li>
<p><strong>Parameters</strong></p>
<ul>
<li><code>ability: T</code></li>
<li><code>action: string</code></li>
<li><code>subject: Subject</code></li>
<li><code>options: PermittedFieldsOptions&lt;T&gt;</code></li>
</ul>
</li>
<li>
<p><strong>Returns</strong> an array of fields</p>
</li>
<li>
<p><strong>Usage</strong><br>
This function is especially useful for backend API because it allows to filter out disallowed properties from request body (e.g., in <a href="https://expressjs.com/">expressjs</a> middleware)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permittedFieldsOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">pick</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isEmpty</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;lodash&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">patch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/api/articles/:id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">updatableFields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">fieldsFrom</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rule</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span>
      <span style="color:#000">rule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">||</span>
      <span style="color:#000;font-weight:bold">[</span>
        <span style="color:#8f5902;font-style:italic">/* list of all fields for Article */</span>
      <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">changes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pick</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updatableFields</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">isEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">changes</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Nothing to update&#34;</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">updateArticleById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">changes</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>So, now even if user try to send fields that he is not allowed to update, <code>permittedFieldsOf</code> will filter them out!</p>
</li>
<li>
<p><strong>See also</strong>: <a href="../../guide/restricting-fields">Restricting fields access</a>, <a href="../../package/casl-mongoose#accessible-fields-plugin">@casl/mongoose</a></p>
</li>
</ul>
<h2 id="packrules">packRules</h2>
<p>This function <strong>reduces serialized rules size in 2 times</strong> (in comparison to its raw representation), by converting objects to arrays. This is useful if you plan to cache rules in <a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JWT</a> token.</p>
<blockquote>
<p>Don’t use result returned by packRules directly, its format is not public and may change in future versions.</p>
</blockquote>
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>rules: TRawRule[]</code></li>
<li><code>packSubject?: (subjectType: SubjectType) =&gt; string</code> - we need to pass this parameter only if we use classes as subject types. It should return subject type&rsquo;s string representation.</li>
</ul>
</li>
<li>
<p><strong>Returns</strong> <code>PackRule&lt;TRawRule&gt;[]</code></p>
</li>
<li>
<p><strong>Usage</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">packRules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">jwt</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;jsonwebtoken&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineRulesFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../services/appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/session&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jwt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sign</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">req.user.id</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">rules</span>: <span style="color:#204a87;font-weight:bold">packRules</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)),</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#4e9a06">&#34;jwt secret&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">expiresIn</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1d&#34;</span> <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">token</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="../../cookbook/cache-rules">Cache abilities</a>, <a href="#unpack-rules"><code>unpackRules</code></a></p>
</li>
</ul>
<h2 id="unpackrules">unpackRules</h2>
<p>This function unpacks rules previously packed by <a href="#pack-rules"><code>packRules</code></a>, so they can be consumed by <code>Ability</code> instance.</p>
<ul>
<li>
<p><strong>Parameters</strong>:</p>
<ul>
<li><code>rules: PackRule&lt;TRawRule&gt;[]</code></li>
<li><code>unpackSubject?: (type: string) =&gt; SubjectType</code> - we need to pass this parameter only if we use classes as subject types. It should return subject type out of its string representation.</li>
</ul>
</li>
<li>
<p><strong>Returns</strong> <code>TRawRule[]</code></p>
</li>
<li>
<p><strong>Usage</strong><br>
If backend sends packed rules, we need to use <code>unpackRules</code> before passing them into <code>Ability</code> instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">unpackRules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">jwt</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;jsonwebtoken&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../services/appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LoginComponent</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">login</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/session&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jwt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">unpackRules</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">));</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div></li>
<li>
<p><strong>See also</strong>: <a href="../../cookbook/cache-rules">Cache abilities</a>, <a href="#pack-rules"><code>packRules</code></a></p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4ad47675a7d3929a1b9a62c20847b0f6">6 - 支持</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e0abdd3f2b860a0f75c5b7a292a326c8">6.1 - Support CASL.js Development</h1>
    
	<p>CASL.js is an MIT licensed open source project and completely free to use. However, the amount of effort needed to maintain and develop new features for the project is not sustainable without proper financial backing. You can support CASL.js development via the following methods:</p>
<h2 id="one-time-donations">One-time Donations</h2>
<p>We accept donations through these channels:</p>
<p><one-time-donations></one-time-donations></p>
<h2 id="recurring-pledges">Recurring Pledges</h2>
<p>Recurring pledges come with exclusive perks, e.g. having your name listed in the CASL GitHub repository, have your company logo placed on this website, personal consultation or project support through live chat or screen-sharing.</p>
<p>Get more details about different options to</p>
<ul>
<li><a href="https://opencollective.com/casljs">become a backer or sponsor via OpenCollective</a></li>
<li><a href="https://patreon.com/sstotskyi">become a backer or sponsor via Patreon</a></li>
</ul>
<h2 id="why-is-it-important-for-you">Why is it important for you?</h2>
<p>If you run a business and are using CASL.js in a revenue-generating product, it makes business sense to sponsor CASL.js development: it ensures the project that your product relies on stays healthy and actively maintained. It can also help your exposure in the JavaScript community and makes it easier to attract developers.</p>
<p>If you are an individual user and have enjoyed the productivity of using CASL, consider donating as a sign of appreciation - like <a href="https://opencollective.com/casljs/donate/details">buying me coffee</a> once in a while :)</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bad9e3ce98c380a5f47dd9da802bfbe1">7 - 未找到</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-7018e070557995a2ac48303e0b59ac22">7.1 - Not Found</h1>
    
	<p>Such page does not exist.</p>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 kamilmysliwiec 保留所有权利</small>
        <small class="ml-1"><a href="https://kamilmysliwiec.com/" target="_blank" rel="noopener">隐私政策</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/casl-docs/js/tabpane-persist.js'></script>


















<script src="/casl-docs/js/main.min.9a2012c9716c36c3da0c29adaa4e22338e4fdd8d8b24ce3efc0ca172697a9196.js" integrity="sha256-miASyXFsNsPaDCmtqk4iM45P3Y2LJM4&#43;/Ayhcml6kZY=" crossorigin="anonymous"></script>




  </body>
</html>
