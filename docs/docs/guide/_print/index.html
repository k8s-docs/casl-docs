<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<link rel="canonical" type="text/html" href="https://wdk-docs.github.io/casl-docs/docs/guide/">
<link rel="alternate" type="application/rss&#43;xml" href="https://wdk-docs.github.io/casl-docs/docs/guide/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/casl-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/casl-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/casl-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/casl-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-192x192.png" sizes="192x192">

<title>指南 | NestJS 文档</title>
<meta name="description" content="">
<meta property="og:title" content="指南" />
<meta property="og:description" content="NestJs 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://wdk-docs.github.io/casl-docs/docs/guide/" /><meta property="og:site_name" content="NestJS 文档" />

<meta itemprop="name" content="指南">
<meta itemprop="description" content="NestJs 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="指南"/>
<meta name="twitter:description" content="NestJs 文档"/>




<link rel="preload" href="/casl-docs/scss/main.scss" as="style">
<link href="/casl-docs/scss/main.scss" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/casl-docs/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">NestJS 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/casl-docs/docs/" ><span class="active">文档</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/casl-docs/docs/guide/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">指南</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-9d064ae46378a7ea4cd8395fa6f188b4">安装</a></li>


    
  
    
    
	
<li>2: <a href="#pg-c08345e7a1a6422ae94efe2cdf79b2e4">介绍</a></li>


    
  
    
    
	
<li>3: <a href="#pg-51a9859bc2f83b67fa71be170d88d343">定义规则</a></li>


    
  
    
    
	
<li>4: <a href="#pg-649681944f858128de1b5f1a01c61b2f">深度条件下</a></li>


    
  
    
    
	
<li>5: <a href="#pg-3498bbe7f8714db5f02e2accf63aa843">限制字段访问</a></li>


    
  
    
    
	
<li>6: <a href="#pg-c7e6f9001127982861f81d00fd317eaa">主题类型检测</a></li>


    
  
    
    
	
<li>7: <a href="#pg-d4173def6f5a3fd9c84a2973d3878334">行动定义别名</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9d064ae46378a7ea4cd8395fa6f188b4">1 - 安装</h1>
    
	<h2 id="需求">需求</h2>
<p>CASL 是同构的，所以可以在浏览器和 Nodejs 环境中使用。
它需要 ES5 兼容环境和 ES6 的“Map”类，这意味着最低支持的 ie 版本是 IE11，最低的 Nodejs 版本是 8.x。
但我们强烈建议使用最新的 Node.js 环境和浏览器，因为他们的 JS VM 工作得更快。</p>
<p>此外，' @casl/vue &lsquo;和&rsquo; @casl/aurelia &lsquo;使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap">ES6 WeakMap</a>，所以它需要 polyfill 或更新版本的浏览器。</p>
<h2 id="语义版本控制">语义版本控制</h2>
<p>CASL 在其所有官方项目中遵循<a href="https://semver.org/">语义版本管理</a>。
可以在<a href="https://github.com/stalniy/casl/releases">发布说明</a>或每个包中的&rsquo; CHANGELOG.md &lsquo;文件中找到更改。</p>
<h2 id="官方软件包及其版本">官方软件包及其版本</h2>
<table>
<thead>
<tr>
<th>Project</th>
<th>Status</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="../intro">@casl/ability</a></td>
<td><a href="https://www.npmjs.com/package/@casl/ability"><img src="https://img.shields.io/npm/v/@casl/ability.svg" alt="@casl/ability-status"></a></td>
<td>CASL&rsquo;s core package</td>
</tr>
<tr>
<td><a href="../../package/casl-mongoose">@casl/mongoose</a></td>
<td><a href="https://www.npmjs.com/package/@casl/mongoose"><img src="https://img.shields.io/npm/v/@casl/mongoose.svg" alt="@casl/mongoose-status"></a></td>
<td>integration with <a href="http://mongoosejs.com/">Mongoose</a></td>
</tr>
<tr>
<td><a href="../../package/casl-prisma">@casl/prisma</a></td>
<td><a href="https://www.npmjs.com/package/@casl/prisma"><img src="https://img.shields.io/npm/v/@casl/prisma.svg" alt="@casl/prisma-status"></a></td>
<td>integration with <a href="https://www.prisma.io/">Prisma</a></td>
</tr>
<tr>
<td><a href="../../package/casl-angular">@casl/angular</a></td>
<td><a href="https://www.npmjs.com/package/@casl/angular"><img src="https://img.shields.io/npm/v/@casl/angular.svg" alt="@casl/angular-status"></a></td>
<td>integration with <a href="https://angular.io/">Angular</a></td>
</tr>
<tr>
<td><a href="../../package/casl-react">@casl/react</a></td>
<td><a href="https://www.npmjs.com/package/@casl/react"><img src="https://img.shields.io/npm/v/@casl/react.svg" alt="@casl/react-status"></a></td>
<td>integration with <a href="https://reactjs.org/">React</a></td>
</tr>
<tr>
<td><a href="../../package/casl-vue">@casl/vue</a></td>
<td><a href="https://www.npmjs.com/package/@casl/vue"><img src="https://img.shields.io/npm/v/@casl/vue.svg" alt="@casl/vue-status"></a></td>
<td>integration with <a href="https://vuejs.org">Vue</a></td>
</tr>
<tr>
<td><a href="../../package/casl-aurelia">@casl/aurelia</a></td>
<td><a href="https://www.npmjs.com/package/@casl/aurelia"><img src="https://img.shields.io/npm/v/@casl/aurelia.svg" alt="@casl/aurelia-status"></a></td>
<td>integration with <a href="http://aurelia.io">Aurelia</a></td>
</tr>
</tbody>
</table>
<h2 id="第三方包">第三方包</h2>
<p>我们也可以在我们的项目中使用第三方包。
要找到它们，只需<a href="https://www.npmjs.com/search?q=keywords:casl">使用“casl”关键字在 NPM 上搜索</a></p>
<blockquote>
<p>在<a href="https://docs.npmjs.com/cli/v7/configuring-npm/package-json#keywords">package.json#keywords</a>数组中添加“casl”，以显示基于 casl 的包在该列表中</p>
</blockquote>
<h2 id="npm-yarn-pnpm">NPM, YARN, PNPM</h2>
<p>通过包管理器安装是推荐的 CASL 安装方式。
要安装最新的稳定版本，请运行:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm install @casl/ability
<span style="color:#8f5902;font-style:italic"># or</span>
yarn add @casl/ability
<span style="color:#8f5902;font-style:italic"># or</span>
pnpm add @casl/ability
</code></pre></div><h2 id="cdn">CDN</h2>
<p>为了进行原型设计或学习，你可以使用最新的版本:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@casl/ability&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><p>对于产品，我们建议链接到一个特定的版本号，以避免来自新版本的意外破坏:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@casl/ability@5.1.0&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><p>记住，CASL 依赖于<a href="https://www.npmjs.com/package/@ucast/mongo">@ucast/mongo2js</a>，而<a href="https://www.npmjs.com/package/@ucast/core">@ucast/core</a>， <a href="https://www.npmjs.com/package/@ucast/js">@ucast/js</a>和<a href="https://www.npmjs.com/package/@ucast/mongo">@ucast/mongo</a>，这就是为什么你需要在&rsquo; @casl/ability &lsquo;之前指定所有这些库:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html"><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@ucast/core&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@ucast/mongo&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@ucast/js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@ucast/mongo2js&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">script</span> <span style="color:#c4a000">src</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;https://cdn.jsdelivr.net/npm/@casl/ability&#34;</span><span style="color:#000;font-weight:bold">&gt;&lt;/</span><span style="color:#204a87;font-weight:bold">script</span><span style="color:#000;font-weight:bold">&gt;</span>
</code></pre></div><h2 id="下载和使用-ltscriptgt-标签">下载和使用 &lt;script&gt; 标签</h2>
<p>只需<a href="https://cdn.jsdelivr.net/npm/@casl/ability">从 CDN 下载 CASL</a>并包含一个脚本标记。
' casl &lsquo;将被注册为一个全局变量。</p>
<blockquote>
<p>希望你知道自己在做什么</p>
</blockquote>
<h2 id="不同构建的解释">不同构建的解释</h2>
<p>In the <code>dist/</code> <a href="https://cdn.jsdelivr.net/npm/@casl/ability/dist/">directory of the NPM package</a> you will find many different builds of CASL.js.
Here’s an overview of the difference between them:</p>
<table>
<thead>
<tr>
<th>Build</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>es6m/index.mjs</td>
<td>minified ES6 code with ES modules support.</td>
</tr>
<tr>
<td>Intended for bundlers (e.g., <a href="https://rollupjs.org/guide/en/">rollup</a>, <a href="https://webpack.js.org/">webpack</a>) to create bundle for modern browsers or modern Nodejs version that support ES modules</td>
<td></td>
</tr>
<tr>
<td>es6c/index.js</td>
<td>minified ES6 code with Commonjs modules support.</td>
</tr>
<tr>
<td>Intended for modern nodejs environments that support ES6 but doesn&rsquo;t support ES modules</td>
<td></td>
</tr>
<tr>
<td>es5m/index.js</td>
<td>minified ES5 code with ES modules support.</td>
</tr>
<tr>
<td>Should be used by bundlers (e.g., <a href="https://rollupjs.org/guide/en/">rollup</a>, <a href="https://webpack.js.org/">webpack</a>) to tree shake the module and skip babel&rsquo;s transpile process</td>
<td></td>
</tr>
<tr>
<td>umd/index.js</td>
<td><strong>deprecated</strong>, minified ES5 code with UMD.</td>
</tr>
<tr>
<td>Intended for AMD apps and simple prototypes in a browser</td>
<td></td>
</tr>
<tr>
<td>types</td>
<td>contains <a href="http://www.typescriptlang.org/">typescript</a> type declaration files</td>
</tr>
</tbody>
</table>
<p>All official packages has the same directory layout (except of <code>@casl/mongoose</code> which does not have es5m version and packages that integrate CASL with UI frameworks which don&rsquo;t have es6c version).</p>
<h2 id="webpack">Webpack</h2>
<p>Webpack 在严格的模式下运行 ESM JavaScript。
问题是 webpack4 只读取&rsquo; package.json &lsquo;的&rsquo; main &lsquo;属性，而忽略&rsquo; resolve.mainFields &lsquo;中的其他所有内容。
所有 casl 相关的包，包括 ucast，在&rsquo; main &lsquo;属性中分发 CommonJS 文件。
这就导致了下一个问题</p>
<blockquote>
<p>ERROR in ./node_modules/@casl/ability/dist/es6m/index.mjs
Can&rsquo;t import the named export &lsquo;xxx&rsquo; from non EcmaScript module (only default export is available)</p>
</blockquote>
<p>The best way to fix it is to upgrade to webpack 5 which reads <code>exports</code> property of package.json when import packages and properly and works with ESM imports.
But if you stuck with webpack 4, read <a href="https://github.com/stalniy/casl/issues/427#issuecomment-757539486">this comment</a> for possible workarounds.</p>
<h2 id="csp-环境">CSP 环境</h2>
<p>一些环境，如谷歌 Chrome 应用程序，强制内容安全策略(CSP)，禁止使用“new Function()”来计算表达式。</p>
<p>CASL 不使用任何被禁止的函数，因此可以在任何环境中使用它。</p>
<h2 id="开发构建">开发构建</h2>
<p><strong>Important</strong>: GitHub ' /dist &lsquo;文件夹中的构建文件在发布期间不会签入。要从 GitHub 上最新的源代码中使用 CASL，您必须自己构建它!导航你的项目根目录并运行:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">git clone git@github.com:stalniy/casl.git
<span style="color:#204a87">cd</span> casl
pnpm i -r
<span style="color:#204a87">cd</span> packages/casl-ability
npm run build
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c08345e7a1a6422ae94efe2cdf79b2e4">2 - 介绍</h1>
    
	<p><a href="https://badge.fury.io/js/%40casl%2Fability"><img src="https://badge.fury.io/js/%40casl%2Fability.svg" alt="@casl/ability NPM version"></a>
<a href="https://www.npmjs.com/package/%40casl%2Fability"><img src="https://img.shields.io/npm/dm/%40casl%2Fability.svg" alt=""></a>
<a href="https://gitter.im/stalniy-casl/casl"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="CASL Join the chat"></a></p>
<h2 id="什么是-casl">什么是 CASL?</h2>
<p>CASL (pronounced /ˈkæsəl/, like <strong>castle</strong>) is an isomorphic authorization JavaScript library which restricts what resources a given client is allowed to access. It&rsquo;s designed to be incrementally adoptable and can easily scale between a simple claim based and fully featured subject and attribute based authorization. It makes it easy to manage and share permissions across UI components, API services, and database queries.</p>
<blockquote>
<p>CASL implements <a href="https://en.wikipedia.org/wiki/Attribute-based_access_control">Attribute Based Access Control</a></p>
</blockquote>
<h2 id="入门">入门</h2>
<p>The easiest way to try out CASL.js is using the <a href="https://codesandbox.io/s/github/stalniy/casl-examples/tree/master/packages/hello-world">Hello World example</a>. Feel free to open it in another tab and follow along as we go through some basic examples. Alternatively you can create Nodejs project and install <code>@casl/ability</code> as a dependency.</p>
<blockquote>
<p>The <a href="../install">Installation page</a> provides more options of installing CASL.</p>
</blockquote>
<h2 id="基本">基本</h2>
<p>CASL operates on the abilities level, that is what a user can actually do in the application. An ability itself depends on the 4 parameters (last 3 are optional):</p>
<ol>
<li><strong>User Action</strong><br>
Describes what user can actually do in the app. User action is a word (usually a verb) which depends on the business logic (e.g., <code>prolong</code>, <code>read</code>). Very often it will be a list of words from CRUD - <code>create</code>, <code>read</code>, <code>update</code> and <code>delete</code>.</li>
<li><strong>Subject</strong><br>
The subject or subject type which you want to check user action on. Usually this is a business (or domain) entity (e.g., <code>Subscription</code>, <code>Article</code>, <code>User</code>). The relation between subject and subject type is the same as relation between an object instance and its class.</li>
<li><strong>Fields</strong><br>
Can be used to restrict user action only to matched subject&rsquo;s fields (e.g., to allow moderator to update <code>status</code> field of an <code>Article</code> and disallow to update <code>description</code> or <code>title</code>)</li>
<li><strong>Conditions</strong><br>
Criteria which restricts user action only to matched subjects. This is useful when you need to give a permission on specific subjects (e.g., to allow user to manage own <code>Article</code>)</li>
</ol>
<p>At the core of CASL is a system that enables us to declaratively define and check user permissions using clear javascript syntax:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><blockquote>
<p>CASL has sophisticated support for TypeScript but in this guide we will use JavaScript for the purpose of ease. See <a href="../../advanced/typescript">CASL TypeScript</a> for details</p>
</blockquote>
<p>In the example above, we have just defined an <code>Ability</code> instance which permits doing anything in the app except for deleting users. As you probably guessed, <code>can</code> and <code>cannot</code> accept the same arguments but have different meanings: <code>can</code> permits an action on the specified subject and <code>cannot</code> forbids it. Both may accept up to 4 arguments (in exactly the same order as listed in <a href="#basics">concepts section</a>). In this case, <code>manage</code> and <code>delete</code> are user actions and <code>all</code> and <code>User</code> are subjects.</p>
<blockquote>
<p><code>manage</code> and <code>all</code> are special keywords in CASL. <code>manage</code> represents any action and <code>all</code> represents any subject.</p>
</blockquote>
<p>Now let&rsquo;s try to check permissions</p>
<div class="highlight" data-filename="app.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility.js&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>In the example above, the <code>Ability</code> instance allows us to check permissions in a pretty readable way. By the way, all these examples demonstrate checking permissions based on a subject type (i.e. an object type or class), but CASL really shines when you need to restrict objects based on their attributes (i.e. properties).</p>
<h2 id="条件">条件</h2>
<p>The most common requirement for mid-sized apps is the ability to limit users so that they can perform actions only on their own resources. CASL allows us to do this by passing an object of conditions as the 3rd argument to <code>can</code> and <code>cannot</code> methods on the definition step.</p>
<p>Before diving into the details, let&rsquo;s first consider requirements for the permissions of a blog website. In such a blog, a user</p>
<ul>
<li>can <code>read</code> any <code>Article</code></li>
<li>can <code>update</code> own <code>Article</code>&rsquo;s</li>
<li>can <code>create</code> a <code>Comment</code> for any Article</li>
<li>can <code>update</code> own <code>Comment</code></li>
</ul>
<p>Let&rsquo;s translate this to CASL:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span>
  <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isLoggedIn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
      <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Do you see how real business requirements are easily translated to code? Now let&rsquo;s check them!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#39;./defineAbility&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#8f5902;font-style:italic">/* intentionally not defined */</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>As you see, you can do checks on the subject the same way you do it on the subject&rsquo;s type! But what does the <code>article</code> variable hold inside? How does CASL know the subject type of the object referenced by this variable?</p>
<p>Do you remember that a subject and its type belong to each other in the same way as an object instance and its class? CASL remembers this as well and retrieves <code>article.constructor.name</code> as its subject type.</p>
<blockquote>
<p>Classes are natural in backend but not always makes sense in frontend development. CASL supports other ways to detect subject type, see <a href="../subject-type-detection">Subject type detection</a> for details.</p>
</blockquote>
<p>Let&rsquo;s get back to our example and define classes for <code>Article</code> and <code>Comment</code> entities:</p>
<div class="highlight" data-filename="entities.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Entity</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">attrs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">assign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">attrs</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Entity</span> <span style="color:#000;font-weight:bold">{}</span>
</code></pre></div><p>And this is how the example with missed <code>article</code> variable looks eventually:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// user can read any article
</span></code></pre></div><p>And few more examples just to get familiar with:</p>
<div class="highlight" data-filename="app.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isLoggedIn</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ownArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">anotherArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">anotherArticle</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false, we can&#39;t update articles which were not written by us
</span></code></pre></div><blockquote>
<p>Despite the fact that <code>can</code> and <code>cannot</code> functions in <code>defineAbility</code> callback are similar to <code>can</code> and <code>cannot</code> methods of <code>Ability</code> class, they have completely different purposes and accept different arguments. See <a href="../../cookbook/less-confusing-can-api">Make <code>can</code> API less confusing</a> if it confuses you.</p>
</blockquote>
<p><strong>Pay attention</strong> that conditions object contains the same keys as the entity we want to check. This is how CASL matches entities by conditions. In our case, it just checks that <code>authorId</code> in <code>Article</code> instance equals to <code>authorId</code> in conditions object. Conditions may have several fields, in that case all fields should match (<code>AND</code> logic).</p>
<p>But conditions are not restricted to simple equality checks! Thanks to <a href="https://github.com/stalniy/ucast">ucast</a> <code>Ability</code> instances can match objects using <a href="http://docs.mongodb.org/manual/reference/operator/query/">MongoDB query language</a>.</p>
<blockquote>
<p>If you are not familiar with MongoDB query language, see <a href="../conditions-in-depth">CASL conditions in depth</a> for details</p>
</blockquote>
<p>You can define the same pair of action and subject with different conditions multiple times. For example, let&rsquo;s allow our blog users to share drafts and publish articles:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sharedWith</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>In such case, the pair of action/subject rules are combined by logical <code>OR</code>. More formally, this can be translated as &ldquo;users can read Article if it&rsquo;s published OR users can read Article if it&rsquo;s not published AND shared with them&rdquo;.</p>
<p>But that&rsquo;s not all, if you need more granular permission checks, you can define them on subject&rsquo;s attributes (i.e., fields)!</p>
<h2 id="fields">Fields</h2>
<p>Sometimes you may need to restrict which fields a user can access. For example, let&rsquo;s allow only moderators to publish <code>Article</code>:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span>
  <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isModerator</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">]);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Here we defined that any user can update <code>title</code> and <code>description</code> fields of their own <code>Article</code>s and only moderators can update <code>published</code> field.</p>
<blockquote>
<p>If fields are not specified, a user is allowed to access any field.</p>
</blockquote>
<p>To check permissions use the same <code>can</code> and <code>cannot</code> methods of <code>Ability</code> instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">moderator</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isModerator</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ownArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">moderator</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">foreignArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">moderator</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">foreignArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span></code></pre></div><blockquote>
<p>For more complex cases, you can use nested fields and wildcards, see <a href="../restricting-fields">Restricting field access</a> for details</p>
</blockquote>
<h2 id="检查逻辑">检查逻辑</h2>
<p>Let&rsquo;s consider a simple example where user can publish articles:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// (1)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;do&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;SomethingUndeclared&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// (2)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// (3)
</span></code></pre></div><p>Line <code>(1)</code> returns <code>true</code> as we expected. Line <code>(2)</code> return <code>false</code> because for any unknown subject or action CASL returns <code>false</code>, by default everything is forbidden (if <code>manage</code> and <code>all</code> keywords are not used). But what would you expect line <code>(3)</code> to return? The answer may be unexpected for some of you, it returns <code>true</code> as well. <strong>Why?!</strong></p>
<p>Let&rsquo;s get back to our experience for a while. Historically, majority of permissions management libs were built on top of roles or flags. So, a user either has permission or not. This can be expressed in pseudo code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read_article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update_article&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>This is interpreted as &ldquo;user can read ALL articles and user can update ALL articles&rdquo;. So, this is &ldquo;all or nothing&rdquo; mindset.</p>
<p><strong>But CASL is different!</strong> It allows us to ask different questions to our permissions. So, when you check on a</p>
<ul>
<li>subject, you ask &ldquo;can I read THIS article?&rdquo;</li>
<li>subject type, you ask &ldquo;can I read SOME article?&rdquo; (i.e., at least one article)</li>
</ul>
<p>It&rsquo;s very useful when you don&rsquo;t have an instance to check but know its type (for example, during creation), so this allows your app to fail fast.</p>
<blockquote>
<p>If you do checks on a subject type, you need to check permissions one more time on the final subject, right before sending request to API or database.</p>
</blockquote>
<h2 id="反向规则">反向规则</h2>
<p>This guide talk a lot about allowable permissions but nothing about disallowable ones. This is for the reason. The direct logic is much simpler to understand, and we recommend to use it whenever possible.</p>
<p>To define an inverted rule, you need to use the 2nd argument in the callback of <code>defineAbility</code>. Let&rsquo;s give a user a permission to do anything but not delete:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span></code></pre></div><p>As you should know direct rules are checked by logical <code>OR</code> on the other hand inverted ones are checked by logical <code>AND</code>. So, in the example above user:</p>
<ul>
<li>can do anything on all entities</li>
<li>and cannot delete any entity</li>
</ul>
<p>When defining direct and inverted rules for the same pair of action and subject the order of rules matters: <code>cannot</code> declarations should follow after <code>can</code>, otherwise they will be overridden by <code>can</code>. For example, let&rsquo;s disallow to read all private objects (those that have property <code>private = true</code>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// true!
</span></code></pre></div><p>Here we got an unexpected result because direct rule is the last one. To fix the result just revert those rules and <strong>always remember to put inverted rules after the direct one!</strong></p>
<h3 id="禁止的原因">禁止的原因</h3>
<p>The good point about inverted rules is that they help to explicitly forbid particular actions. Moreover they allow to add explanation. Let&rsquo;s see how</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">because</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You are not allowed to read private information&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>We can get this message back by checking permissions using <code>ForbiddenError</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// You are not allowed to read private information
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>To learn more about <code>ForbiddenError</code>, see <a href="../../api#forbidden-error">ForbiddenError API</a></p>
</blockquote>
<h2 id="更新规则">更新规则</h2>
<p>Sometimes, especially in frontend application development, we need to update <code>Ability</code> instance&rsquo;s rules (e.g., on login or logout). To do this, we can use <code>update</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">([]);</span> <span style="color:#8f5902;font-style:italic">// forbids everything
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#8f5902;font-style:italic">// switch to readonly mode
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;all&#34;</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>
</code></pre></div><p>Also we can use <code>AbilityBuilder</code> to create rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>To track when rules are updated, we can subscribe to <code>update</code> (before ability is updated) or <code>updated</code> (after ability is updated) events of <code>Ability</code> instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">unsubscribe</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">({</span> <span style="color:#000">rules</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">target</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `rules` is an array passed to `update` method
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// `target` is an Ability instance that triggered event
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">unsubscribe</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// removes subscription
</span></code></pre></div><h2 id="还有什么">还有什么?</h2>
<p>CASL does not have a concept of &ldquo;a role&rdquo; and this makes it very powerful! As CASL allows to describe user abilities in your application, you can use it to:</p>
<ol>
<li>Implement <a href="https://en.wikipedia.org/wiki/Feature_toggle">feature toggles</a><br>
Hide unfinished feature or show it to beta testers only.</li>
<li>Conduct <a href="https://en.wikipedia.org/wiki/A/B_testing">A/B testing</a><br>
Based on age, region, country or whatever hide features for some users and show for others</li>
<li>Simple Business Logic<br>
Disallow users to watch video if their subscription has been expired</li>
</ol>
<blockquote>
<p>See <a href="../../cookbook/roles-with-static-permissions">Roles with predefined permissions</a> for details.</p>
</blockquote>
<h2 id="准备好了">准备好了?</h2>
<p>我们已经简要介绍了 CASL.js 核心的所有特性——本指南的其余部分将涵盖它们和其他高级特性，并提供更详细的细节，所以请务必通读全文!</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-51a9859bc2f83b67fa71be170d88d343">3 - 定义规则</h1>
    
	<p>There are 3 ways you can define abilities:</p>
<ul>
<li>using <code>defineAbility</code> function</li>
<li>using <code>AbilityBuilder</code> class</li>
<li>using <code>JSON</code> objects</li>
</ul>
<p>In order to understand which way to use, let&rsquo;s learn more about each one.</p>
<h2 id="defineability-function">defineAbility function</h2>
<p>This function is a <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> that allows to create <code>Ability</code> instance using <code>can</code> and <code>cannot</code> methods. It allows to define and use <code>Ability</code> instance without writing too much code.</p>
<h3 id="defineability-example">defineAbility example</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>You can pass multiple actions, subjects and fields in the single <code>can</code> (or <code>cannot</code>) function. So, instead of</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>you can do:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Comment&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><blockquote>
<p>To learn more about <code>can</code> and <code>cannot</code> functions' parameters, read <a href="../../api#abilitybuilder">AbilityBuilder API</a></p>
</blockquote>
<h3 id="when-to-use-defineability">When to use defineAbility</h3>
<ul>
<li>unit tests</li>
<li>examples and learning resources</li>
<li>prototypes or really simple applications</li>
</ul>
<p>So, to keep examples simple and clear, we will use <code>defineAbility</code> in majority of code snippets in this documentation.</p>
<h3 id="why-defineability-is-not-recommended">Why defineAbility is not recommended</h3>
<p>There is nothing extremely wrong with this function but there are several drawbacks when you use it in your app:</p>
<ol>
<li>In most cases, rules depends on user request, so using callback style to define permissions, adds additional nesting and increases cognitive complexity.</li>
<li>It can create only <code>Ability</code> instance which works with <a href="../conditions-in-depth">MongoDB conditions</a>, so you won&rsquo;t be able to use another language to match conditions.</li>
</ol>
<blockquote>
<p>See <a href="../../advanced/customize-ability">Customize Ability</a> to know more about different ability classes and possibilities to customize it.</p>
</blockquote>
<h2 id="abilitybuilder-class">AbilityBuilder class</h2>
<p>This class implements <code>can</code> and <code>cannot</code> functions, that makes possible to write rules using <a href="https://en.wikipedia.org/wiki/Domain-specific_language">DSL</a> syntax. <strong>This is the recommended way to define rules using DSL syntax</strong></p>
<h3 id="abilitybuilder-example">AbilityBuilder example</h3>
<p><a href="#defineability-example">defineAbility example</a> written using <code>AbilityBuilder</code> class looks a bit more wordy:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>But it allows to define rules without additional nesting, this is especially important when you build rules based on conditional logic:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isAdmin</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// read-write access to everything
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// read-only access to everything
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>To learn more about <code>can</code> and <code>cannot</code> functions' parameters, read <a href="../../api#abilitybuilder">AbilityBuilder API</a></p>
</blockquote>
<p>For more advanced cases, it&rsquo;s possible to use <code>rules</code> property of <code>AbilityBuilder</code> and create <code>Ability</code> instance manually:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// defined permissions
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="when-to-use-abilitybuilder">When to use AbilityBuilder</h3>
<ul>
<li>in apps which have static permissions (i.e., permissions are not changed by admin user but defined inside system)</li>
<li>anywhere where you use custom subclasses of <code>PureAbility</code></li>
</ul>
<blockquote>
<p>See <a href="../../advanced/customize-ability">Customize Ability</a> to learn more about <code>PureAbility</code> class.</p>
</blockquote>
<h2 id="json-objects">JSON objects</h2>
<p>It&rsquo;s not required to use <code>AbilityBuilder</code> to define rules in the app, especially if your rules are dynamic (i.e., stored in database or managed by admin users). In such cases, the preferred way is to use <code>JSON</code> objects. You can directly pass array of <code>JSON</code> rules into <code>Ability</code> constructor. Such rules are called raw rules</p>
<blockquote>
<p>you can read more about TypeScript types and their shapes in <a href="../../advanced/typescript">TypeScript Support</a></p>
</blockquote>
<h3 id="json-objects-example">JSON objects example</h3>
<p>The same example using <code>JSON</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">inverted</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">conditions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>
</code></pre></div><p>Pay attention to the <code>inverted</code> field, it indicates that a rule is an inverted one (i.e., forbids something).</p>
<h3 id="the-shape-of-raw-rule">The shape of raw rule</h3>
<p>The simplified version (without generics) of raw rule shape in <a href="http://www.typescriptlang.org/">TypeScript</a> looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">RawRule</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">action</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#000">subject?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#8f5902;font-style:italic">/** an array of fields to which user has (or not) access */</span>
  <span style="color:#000">fields?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#8f5902;font-style:italic">/** an object of conditions which restricts the rule scope */</span>
  <span style="color:#000">conditions?</span>: <span style="color:#204a87;font-weight:bold">any</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#8f5902;font-style:italic">/** indicates whether rule allows or forbids something */</span>
  <span style="color:#000">inverted?</span>: <span style="color:#204a87;font-weight:bold">boolean</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#8f5902;font-style:italic">/** message which explains why rule is forbidden */</span>
  <span style="color:#000">reason?</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Don&rsquo;t worry if you are not familiar with TypeScript, you still have time to learn it ;) Kidding, or not?</p>
<p>In the example above, <code>?</code> after field name means optional field, so everything is optional except <code>action</code>. <code>string[]</code> means an array of strings and <code>string | string[]</code> means either regular <code>string</code> or an array of strings. Now you know almost everything about TypeScript, do not thank :)</p>
<h3 id="when-to-use-json-objects">When to use JSON objects</h3>
<ul>
<li>in apps, that have dynamic permissions (i.e., permissions are changed by admin user)</li>
<li>in apps, that receive permissions via network layer (e.g., single page applications or microservices)</li>
<li>to make the app&rsquo;s bundle size smaller (if you don&rsquo;t use <code>AbilityBuilder</code> or <code>defineAbility</code>, they can be shook out by bundlers such as <a href="https://rollupjs.org/guide/en/">rollup</a> or <a href="https://webpack.js.org/">webpack</a>)</li>
</ul>
<p>Now, as we know all possible ways to define rules, let&rsquo;s dive deeper into <code>can</code> and <code>cannot</code> methods.</p>
<h2 id="rules">Rules</h2>
<p>You can define as much rules as you need, CASL builds an index under the hood to keep checking logic fast. So, don&rsquo;t worry about performance.</p>
<p>You can define the same pair of action and subject with different conditions multiple times. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;review&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>In such case, the pair of action/subject rules are combined by logical <code>OR</code>. More formally this can be translated as &ldquo;users can read Article if it&rsquo;s published OR users can read Article if it&rsquo;s not published AND in review status&rdquo;.</p>
<p>But be careful, because <code>OR</code> logic returns <code>true</code> if one of its expressions are <code>true</code>, so the next code will always return <code>true</code>, even for articles that were not published:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// (2)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>More formally this code can be read as &ldquo;can read any article OR can read published articles&rdquo;. As you see, the first statement always valid, so the <code>(2)</code> <code>can</code> with conditions has no effect.</p>
<p>It&rsquo;s also possible to restrict scope of direct rule with the inverted one for the same pair of action and subject. In such case, inverted rules are combined with direct ones by logical <code>AND</code>.</p>
<p>Let&rsquo;s change the example above to disallow reading unpublished articles:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// direct rule
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// inverted rule
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This is read as &ldquo;can read any article AND cannot read unpublished articles&rdquo;.</p>
<h3 id="inverted-rules-order">Inverted rules order</h3>
<p>It is important that in the example above <code>cannot read article unpublished</code> line comes after the <code>can read article</code> line. If they were reversed, <code>cannot read article unpublished</code> would be overridden by <code>can read article</code>.</p>
<blockquote>
<p>The rule of thumb is to define general rules first and more specific after general ones.</p>
</blockquote>
<p>It was done so in order to be able to override inverted rules by regular ones.</p>
<h3 id="best-practice">Best practice</h3>
<p>Direct logic is easier to reason about for human mind, so use direct rules as much as possible! Moreover, this allows to keep permissions clean, more readable and reduces the risk of giving wrong permissions to the wrong users.</p>
<blockquote>
<p>You can remember this rule as: <strong>Give permissions, don&rsquo;t take them away</strong></p>
</blockquote>
<p>So, are there a valid usecases for inverted rules? <strong>Yes</strong>! They work very well when are not combined with regular rules and defined explicitly to express why particular action on particular subject was forbidden, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">hasPaidSubscription</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hasPaidSubscription</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">hasPaidSubscription</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;BlogPost&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;BlogPost&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">because</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You have not paid for monthly subscription&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-649681944f858128de1b5f1a01c61b2f">4 - 深度条件下</h1>
    
	<p>Thanks to <a href="https://github.com/stalniy/ucast">ucast</a>, we can define permissions using <a href="http://docs.mongodb.org/manual/reference/operator/query/">MongoDB query language</a>.</p>
<p>Don&rsquo;t worry, if you are not familiar with MongoDB query language. We will go through some of its operators in this guide. But before we start, let&rsquo;s see how useful it may be by creating simple article scheduling logic, that allows to read articles only if their <code>createdAt</code> is in the past:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">today</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">setHours</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">createdAt</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$lte</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">today</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Or let&rsquo;s allow to read articles that are in <code>review</code> or <code>published</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Do you see the power it brings?</p>
<h2 id="mongodb-and-its-query-language">MongoDB and its query language</h2>
<p><a href="https://www.mongodb.com/">MongoDB</a> is a general purpose, document-based, distributed database built for modern applications and for the cloud era. In simple words, this is a <a href="https://en.wikipedia.org/wiki/NoSQL">NoSQL</a> database that stores records in <code>JSON</code> (actually in <a href="https://docs.mongodb.com/manual/reference/glossary/#term-bson">BSON</a>) format.</p>
<p>As they decided to store records in <code>JSON</code>, they needed a new query language that would allow to get filtered records from their database. This is how they created own query language.</p>
<p>JavaScript is a superset of <code>JSON</code>, that&rsquo;s why we decided to use MongoDB query language to restrict permissions for subjects based on their properties.</p>
<p><strong>You don&rsquo;t need to know anything about MongoDB</strong> in order to use CASL, you need to know only subset of its query language operators.</p>
<p>Query is what you pass in conditions to <code>can</code> and <code>cannot</code> functions (3rd or 4th argument if you pass fields). So, it&rsquo;s an object which defines restrictions on a JavaScript object and if that restrictions are matched then a matched object is returned.</p>
<p>Let&rsquo;s see at examples of queries:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">queries</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// (1)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hidden</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// (2)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$exists</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;inProgress&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">price</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$gte</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$lte</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">50</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// (3)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">tags</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$all</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;permission&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;casl&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$regex</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">/@gmail.com$/i</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;cities.address&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$elemMatch</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">postalCode</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$regex</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">/^AB/</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span> <span style="color:#8f5902;font-style:italic">// (4)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">];</span>
</code></pre></div><p>We can combine any amount of fields inside single query, all their restrictions are tested according to <code>AND</code> logic. If we do not specify operator, the query uses <code>$eq</code> operator (equality operator). So, a query like <code>(2)</code> matches objects if their <code>private</code> and <code>hidden</code> property values equal to <code>false</code> (i.e., <code>!object.private &amp;&amp; !object.hidden</code>).</p>
<p>We can specify multiple operators for the same field, in this case each operator must return <code>true</code> to match a field value. So, <code>(3)</code> matches objects only if <code>price</code> property value is between 10 and 50 inclusively (i.e., <code>object.price &gt;= 10 &amp;&amp; object.price &lt;= 50</code>).</p>
<p>To access nested property value, you can use dot notation as in <code>(4)</code>.</p>
<h2 id="supported-operators">Supported operators</h2>
<p>CASL uses only subset of MongoDB operators which cover majority of cases.</p>
<blockquote>
<p>If you need to use more operators or define custom ones, read <a href="../../advanced/customize-ability">Customize ability</a></p>
</blockquote>
<p>The list of operators:</p>
<ol>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/eq">$eq</a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/ne">$ne</a><br>
object value should equal specified value. <code>$ne</code> means <code>not $eq</code></li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/lt">$lt</a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/lte">$lte</a><br>
object value should be less than specified value. Can be used for <code>Date</code>s, numbers and strings. <code>$lte</code> is a combination of <code>$lt</code> and <code>$eq</code>, so it&rsquo;s an inclusive check.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/gt">$gt</a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/gte">$gte</a><br>
object value should be greater than specified value. Can be used for <code>Date</code>s, numbers and strings. <code>$gte</code> is a combination of <code>$gt</code> and <code>$eq</code>, so it&rsquo;s an inclusive check.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/in">$in</a> and <a href="https://docs.mongodb.com/manual/reference/operator/query/nin">$nin</a><br>
Checks that object&rsquo;s property is of the specified array values. Can be used for single value and for arrays as well. If object&rsquo;s property is an array it checks for intersection. <code>$nin</code> means <code>not $in</code></li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/all">$all</a><br>
Checks that object&rsquo;s property should contain all elements from the specified array. Can be used for arrays only.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/size">$size</a><br>
Checks that array length equals to specified value. Can be used for arrays only</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/regex">$regex</a><br>
Allows to test object&rsquo;s property value using <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expression</a>. Can be used for strings only</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/exists">$exists</a><br>
Checks that property exists in the object.</li>
<li><a href="https://docs.mongodb.com/manual/reference/operator/query/elemMatch">$elemMatch</a><br>
Checks nested elements shape. Use <code>$elemMatch</code> operator to specify multiple criteria on the elements of an array such that at least one array element satisfies all the specified criteria. If you specify only a single condition in the <code>$elemMatch</code> expression, <code>$elemMatch</code> is not necessary. See <a href="https://docs.mongodb.com/manual/tutorial/query-arrays/#specify-multiple-criteria-for-array-elements">Specify Multiple Conditions for Array Elements</a> for details.</li>
</ol>
<h2 id="why-logical-query-operators-are-not-included">Why logical query operators are not included</h2>
<p>CASL doesn&rsquo;t use <code>$and</code>, <code>$or</code>, <code>$nor</code> and <code>$not</code> operators. This is because the same behavior can be achieved by combining <code>can</code> and <code>cannot</code> rules. Combination of <code>can</code> rules for the same pair of action and subject allows to mimic <code>$or</code> operator and combination of <code>cannot</code> rules allows to mimic <code>$not</code> and <code>$and</code> operators. Moreover as we discussed in this guide, all properties inside conditions object are checked by <code>AND</code> logic, this is another way to mimic <code>$and</code> operator.</p>
<p><code>$nor</code> cannot be reproduced in any way, so if you are sure that you need it, I&rsquo;d recommend to rethink your permission logic together with the client or product owner. But if you are 100% sure, please read how to <a href="../../advanced/customize-ability">Customize ability</a>.</p>
<h2 id="checking-logic-in-casl">Checking logic in CASL</h2>
<p>When you define rules with conditions, the last are converted to functions that checks whether object matches specified MongoDB query. Let&rsquo;s see an example:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defaultAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defaultAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">createdAt</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$lte</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>The example above says that article can be read if it&rsquo;s in review or published and its creation date is in the past or today. Before starting let&rsquo;s define simple class that represents <code>Article</code> entity.</p>
<div class="highlight" data-filename="entities.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createdAt</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createdAt</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createdAt</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>It&rsquo;s not mandatory to use classes, CASL perfectly works with plain javascript objects, see <a href="../subject-type-detection">Subject type detection</a> for details.</p>
</blockquote>
<p>Now we can test which articles user can read:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#39;./defineAbility&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#39;./entities&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">today</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">setHours</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">tomorrow</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#8f5902;font-style:italic">/* logic to calculate date for tomorrow */</span> <span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;review&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">today</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// (1), true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;published&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">today</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// (2), true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;draft&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">today</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// (3), false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;read&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;review&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tomorrow</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// (4), false
</span></code></pre></div><p><code>(1)</code> and <code>(2)</code> returns <code>true</code> because article&rsquo;s status is one of the specified and <code>today</code> less then the specified value in conditions.
<code>(3)</code> fails because article&rsquo;s status is not listed inside <code>$in</code> operator and <code>(4)</code> fails because article&rsquo;s <code>createdAt</code> is in future.</p>
<p>The same logic is applicable to other operators in conditions.</p>
<h2 id="common-conditions">Common conditions</h2>
<p>This section describes the way to construct conditions for common cases.</p>
<h3 id="match-one-of-few-items-in-a-scalar-property">Match one of few items in a scalar property</h3>
<p>Suppose we have an <code>Article</code> object which has a property <code>status</code>. We want to restrict the user to access only articles that are in few specific statuses.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">status</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;inReview&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h3 id="match-specified-item-in-an-array-property">Match specified item in an array property</h3>
<p>Suppose we have an <code>Article</code> object which has a property <code>categories</code>. We want to restrict the user to access only articles in one specified category.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">categories</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;javascript&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">categories</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">categories</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">categories</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;javascript&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;acl&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h3 id="match-one-of-few-items-in-an-array-property">Match one of few items in an array property</h3>
<p>Suppose we have an <code>Article</code> object which has a property <code>categories</code>. We want to restrict the user to access only articles in few specified categories.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">categories</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;javascript&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;frontend&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">categories</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">categories</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">categories</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;javascript&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;acl&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h3 id="match-nested-property-value">Match nested property value</h3>
<p>Suppose we have an <code>Address</code> object which has property <code>country</code> which is an object of 2 fields: <code>isoCode</code> and <code>name</code>. We want to restrict user to access only those addresses that are located in the specified country.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Address&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;country.isoCode&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;UA&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Address</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">isoCode</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">country</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">isoCode</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">isoCode</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// const address = new Address(&#39;UA&#39;, &#39;Ukraine&#39;);
</span><span style="color:#8f5902;font-style:italic">// console.log(ability.can(&#39;read&#39;, address)); // true
</span></code></pre></div><h3 id="match-several-properties-of-a-nested-array-property">Match several properties of a nested array property</h3>
<p>Suppose we have a wishlist of products in some e-shop and we want to share wishlist item to somebody else and give him <code>update</code> permission.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;WishlistItem&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">sharedWith</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">$elemMatch</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permission</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">WishlistItem</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sharedWith</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sharedWith</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sharedWith</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">wishlistItem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">WishlistItem</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL in Action&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permission</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permission</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wishlistItem</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3498bbe7f8714db5f02e2accf63aa843">5 - 限制字段访问</h1>
    
	<p>Sometimes you may need to restrict which fields a user can access. For example, let&rsquo;s allow only moderators to publish <code>Article</code>:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isModerator</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now we can check permissions on fields:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">moderator</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isModerator</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">moderator</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p><strong>Be attentive when you define rules for fields with conditions</strong>, the result of the check will be different depending on whether you pass a subject or subject type! To illustrate the difference let&rsquo;s define a simple class:</p>
<div class="highlight" data-filename="entities.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">description</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">authorId</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">title</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">description</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">description</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authorId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">authorId</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">published</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And let&rsquo;s check permissions:</p>
<div class="highlight" data-filename="app.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./entities&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ownArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL in Action&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">anotherArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;CASL in Vue apps&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">anotherArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true!
</span></code></pre></div><p>So, the last check returned <code>true</code> and at the first sight it seems wrong! But it&rsquo;s not. Similarly to <a href="../intro#checking-logic">checking logic</a> without fields, we ask different questions:</p>
<ul>
<li>when we check on particular <code>Article</code> instance, we are asking <strong>can user update this article&rsquo;s title</strong></li>
<li>and when we check on subject type, we are asking <strong>can user update title of at least one article?</strong></li>
</ul>
<p>Another way to check permissions is to extract all permitted fields from <code>Ability</code> instance using <code>permittedFieldsOf</code> helper from <code>@casl/ability/extra</code> sub-module. The same checking logic applies here:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permittedFieldsOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// the same code from app.js, the example above
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ARTICLE_FIELDS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;authorId&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">fieldsFrom</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rule</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">rule</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">ARTICLE_FIELDS</span> <span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// [&#39;title&#39;, &#39;description&#39;]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">anotherArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// []
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// [&#39;title&#39;, &#39;description&#39;] !
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fields</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;published&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// do something if can update published field
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>CASL knows nothing about shapes of our entities, so the only way to tell him is to provide a <code>fieldsFrom</code> function. This function should return a list of fields from rule. Rule has no fields if it&rsquo;s allowed (or disallowed) to manage all of them. In this case, we return all fields, otherwise return what is inside our rule.</p>
<p>This method is very useful in combination with <a href="https://lodash.com/docs/4.17.15#pick">lodash.pick</a> to extract permitted fields from user request</p>
<blockquote>
<p>If you need <code>pick</code> with support for wildcards, check [this implementation][pick.wildcars]</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">pick</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;lodash/pick&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permittedFieldsOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability/extra&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// the same code from app.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">reqBody</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;CASL&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;powerful&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">published</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// only moderators are allowed to change this field!
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">};</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fields</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">permittedFieldsOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ownArticle</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rawArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">pick</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reqBody</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fields</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// { title: &#39;CASL&#39;, description: &#39;powerful&#39; }
</span></code></pre></div><p>Thanks to this, users, who try to send attributes, won&rsquo;t be able to overcome permissions' restrictions.</p>
<blockquote>
<p>To know more about <code>@casl/ability/extra</code> check its <a href="../../api#extra-submodule">API documentation</a></p>
</blockquote>
<h2 id="nested-fields">Nested fields</h2>
<p>CASL allows you to define permissions on nested fields, to do this just use dot notation, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;address.city&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="field-patterns">Field patterns</h2>
<p>It&rsquo;s also possible to define permissions for fields using patterns. You can use <code>*</code> to match any symbol except dot (i.e., <code>.</code>) and <code>**</code> to match any symbol. For example, you want to allow access to all fields of a nested field (in spite of the nesting level):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;address.**&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.city.name&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>Or you can give access to only first level of nested fields:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;address.*&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.street&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;address.city.name&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false
</span></code></pre></div><p>Or you can give access to top level fields using pattern. Suppose <code>User</code> instance has multiple fields for street like <code>street1</code>, <code>street2</code>, etc:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;street*&#34;</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;street&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;street1&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;street2&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h3 id="field-patterns-table">Field patterns table</h3>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Example</th>
<th>Result</th>
</tr>
</thead>
<tbody>
<tr>
<td>address.*</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td>address.**</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.lat')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td>address.*.name</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.*.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.name')</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td>address.**.name</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.*.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td>*.name</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', '*.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.name')</code></td>
<td><code>false</code></td>
</tr>
<tr>
<td>**.name</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', '*.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.location.name')</code></td>
<td><code>true</code></td>
</tr>
<tr>
<td></td>
<td><code>ability.can('read', 'User', 'address.city.code')</code></td>
<td><code>false</code></td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c7e6f9001127982861f81d00fd317eaa">6 - 主题类型检测</h1>
    
	<p>Let&rsquo;s consider an example:</p>
<div class="highlight" data-filename="defineAbility.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>We allowed everyone to read articles, now let&rsquo;s test it:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>What do you think the last line returns? It returns <code>false</code>, but why? Because <code>article</code> variable is not of <code>Article</code> type. Now you should have a question:</p>
<h2 id="how-does-casl-detect-subject-type">How does CASL detect subject type?</h2>
<p>The first thing to clarify is &ldquo;what is subject type?&rdquo;. A subject type is basically a type of an object, in OOP class represents instance metadata and represents object metadata information.</p>
<blockquote>
<p>Starting from v5, CASL perceives string, function and class as a subject type. Any other type is perceived as a subject, for which CASL needs to detect subject type.</p>
</blockquote>
<p>When we pass an object as the 2nd argument in <code>ability.can</code>, CASL gets <code>object.constructor.modelName</code> as subject type, and fallbacks to <code>object.constructor.name</code> if <code>modelName</code> is not specified.</p>
<p>In the example above, <code>article</code> variable contains a plain object, its constructor doesn&rsquo;t have <code>modelName</code>, so CASL gets its <code>constructor.name</code> as a subject type. Eventually, we get <code>Object</code>. There are no rules for <code>Object</code> subject type, that&rsquo;s why we got <code>false</code> when tried to check whether it&rsquo;s possible to read that object. So, how can we fix that example? The easiest way is to use a special class for our <code>Article</code> model:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p><strong>The example above won&rsquo;t work</strong> in production if we use minimization. To fix it, we need to set a static property on <code>Article</code> class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">get</span> <span style="color:#000">modelName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>This is fine for backend where classes are naturally used to describe and encapsulate Domain Logic but not for frontend. Usually frontend deals with <a href="https://en.wikipedia.org/wiki/Data_transfer_object">DTO</a> objects (i.e., plain js objects).</p>
<p>CASL provides 2 options to handle DTO objects:</p>
<ol>
<li>Use <code>subject</code> helper.</li>
<li>Use custom subject type detection algorithm.</li>
</ol>
<h2 id="subject-helper">subject helper</h2>
<p>CASL provides built-in <code>subject</code> helper which sets subject type to provided object. So, the example above we can rewrite to:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">ability</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>It defines readonly non-configurable and non-enumerable <code>__caslSubjectType__</code> property on the provided DTO, so it can be used in the subject&rsquo;s type detection algorithm.</p>
<blockquote>
<p>CASL will throw an exception if you try to use <code>subject</code> helper with different subject type for an object processed by the helper previously</p>
</blockquote>
<p>So, now you have 2 options:</p>
<ol>
<li>Use <code>subject</code> helper everywhere you use <code>ability.can</code> as shown in the example above.</li>
<li>Set subject type for all <a href="https://en.wikipedia.org/wiki/Data_transfer_object">DTO</a>s after retrieving them from server</li>
</ol>
<p>So, let&rsquo;s see what we mean for the 2nd option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getArticles</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/api/articles&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">article</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>The 2nd approach is a bit hacky because it mixes responsibilities. Now, your services coupled with CASL. This is fine for short term or small-medium apps but should be avoided for large apps</p>
</blockquote>
<p>Now we can safely check permissions on articles using <code>ability.can</code> without worrying about subject&rsquo;s type as it was defined previously.</p>
<p>To make a code a bit more readable, you can alias <code>subject</code> to <code>a</code> or <code>an</code> depending on the context, so the example above may look like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">subject</span> <span style="color:#000">as</span> <span style="color:#000">an</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">getArticles</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">response</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">fetch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/api/articles&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">an</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// read as &#34;an Article object&#34;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h2 id="custom-subject-type-detection">Custom subject type detection</h2>
<p>Sometimes you will need to define your own type detection algorithm (e.g., <a href="https://graphql.org/">GraphQL</a> provides metadata field <code>__typename</code> which returns the type of the object)</p>
<p>For such cases, we can override built-in algorithm by providing <code>detectSubjectType</code> option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">__</span><span style="color:#000">typename</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#0000cf;font-weight:bold">__</span><span style="color:#000">typename</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>Custom detection function must return a subject type (either string, class or function).</p>
<p>The same can be achieved using <code>defineAbility</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">__</span><span style="color:#000">typename</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">article</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#0000cf;font-weight:bold">__</span><span style="color:#000">typename</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>It&rsquo;s important to note that <code>detectSubjectType</code> is responsible for mapping objects to their corresponding types. When we pass a class, a function or a string in <code>ability.can</code>, they are automatically perceived as a subject type and <code>detectSubjectType</code> is not called for them.</p>
<h3 id="use-classes-as-subject-types">Use classes as subject types</h3>
<p>As we said before, it&rsquo;s common to use classes to model Domain Logic on backend. So, some of you may want to use classes as subject types in permission definition. To do this, we need a custom <code>detectSubjectType</code> function:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>Or with <code>AbilityBuilder</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>If you want to use classes in TypeScript, you need to cast <code>object.constructor</code> (read <a href="https://github.com/microsoft/TypeScript/issues/3841">this TypeScript issue</a> for details):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ExtractSubjectType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{}</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;read&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Subjects</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Article</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Actions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Subjects</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#8f5902;font-style:italic">// if you don&#39;t use permission specific types, you can cast return value to `SubjectType` type
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">detectSubjectType</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">constructor</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">ExtractSubjectType</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Subjects</span><span style="color:#000;font-weight:bold">&gt;,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d4173def6f5a3fd9c84a2973d3878334">7 - 行动定义别名</h1>
    
	<p>Aliases gives a possibility to combine several actions into one. This also simplifies checks when we need to ensure that user can do both actions together (e.g., <code>delete</code> and <code>update</code>).</p>
<p>To define an alias, we need to use <code>createAliasResolver</code> function. It accepts a single argument - aliases to actions map. For example, here we define modify alias as a combination of update and delete actions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createAliasResolver</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">resolveAction</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAliasResolver</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">modify</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">resolveAction</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>When you check abilities by alias, it means that user has all required actions (or doesn&rsquo;t have at least one), so:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><strong>Be aware</strong> that aliases work only in one direction! It means that <code>modify</code> is an alias for <code>update</code> and <code>delete</code> but <code>update</code> and <code>delete</code> do not automatically form <code>modify</code> alias. To understand what this means, let&rsquo;s consider the same example but with different rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createAliasResolver</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">resolveAction</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAliasResolver</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">modify</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">resolveAction</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// false &lt;---
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><p>We got <code>false</code> for <code>modify</code> action, even though we can <code>delete</code> and <code>update</code> a Post! Aliases are resolved once on <code>Ability</code> instantiation level or when you call <code>ability.update</code>. It was done this way in order to make <code>ability.can</code> faster.</p>
<p>You can also define aliases on aliases, they are resolved recursively:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createAliasResolver</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">resolveAction</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAliasResolver</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">modify</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">access</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">],</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;access&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">resolveAction</span> <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;access&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;modify&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// true
</span></code></pre></div><h2 id="invalid-usage">Invalid usage</h2>
<p>In any environment that is not production (determined by <code>process.env.NODE_ENV</code>), <code>createAliasResolver</code> analyses passed in object and forbids to:</p>
<ol>
<li>Create an alias for <code>manage</code> action.<br>
<code>manage</code> is reserved and represents any action, so there is no need to alias it (e.g., <code>createAliasResolver({ access: 'manage' })</code>).</li>
<li>Create an alias to itself (e.g., <code>createAliasResolver({ access: 'access' })</code>).</li>
</ol>
<p>It doesn&rsquo;t detect cycles through several levels of indirection, so you need to ensure this by yourself.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 kamilmysliwiec 保留所有权利</small>
        <small class="ml-1"><a href="https://kamilmysliwiec.com/" target="_blank" rel="noopener">隐私政策</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/casl-docs/js/tabpane-persist.js'></script>


















<script src="/casl-docs/js/main.min.9a2012c9716c36c3da0c29adaa4e22338e4fdd8d8b24ce3efc0ca172697a9196.js" integrity="sha256-miASyXFsNsPaDCmtqk4iM45P3Y2LJM4&#43;/Ayhcml6kZY=" crossorigin="anonymous"></script>




  </body>
</html>
