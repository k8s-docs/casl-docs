<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<link rel="canonical" type="text/html" href="https://wdk-docs.github.io/casl-docs/docs/cookbook/">
<link rel="alternate" type="application/rss&#43;xml" href="https://wdk-docs.github.io/casl-docs/docs/cookbook/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/casl-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/casl-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/casl-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/casl-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/casl-docs/favicons/android-192x192.png" sizes="192x192">

<title>食谱 | NestJS 文档</title>
<meta name="description" content="">
<meta property="og:title" content="食谱" />
<meta property="og:description" content="NestJs 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://wdk-docs.github.io/casl-docs/docs/cookbook/" /><meta property="og:site_name" content="NestJS 文档" />

<meta itemprop="name" content="食谱">
<meta itemprop="description" content="NestJs 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="食谱"/>
<meta name="twitter:description" content="NestJs 文档"/>




<link rel="preload" href="/casl-docs/scss/main.scss" as="style">
<link href="/casl-docs/scss/main.scss" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/casl-docs/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">NestJS 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/casl-docs/docs/" ><span class="active">文档</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/casl-docs/docs/cookbook/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">食谱</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-e885a88fdfc50203dbb9ee3a8bad01d0">Cookbook Introduction</a></li>


    
  
    
    
	
<li>2: <a href="#pg-34cd71443a17b1e740561cc7115b3277">Less confusing can API</a></li>


    
  
    
    
	
<li>3: <a href="#pg-4c6eef94c958d52006827a9da7ccc6e3">Claim based Authorization</a></li>


    
  
    
    
	
<li>4: <a href="#pg-b3edd3f097341ab85af67ee61c3e5879">Cache abilities</a></li>


    
  
    
    
	
<li>5: <a href="#pg-001366d799f10789e049c841de4397c9">Roles with predefined permissions</a></li>


    
  
    
    
	
<li>6: <a href="#pg-7afd37d55b8ffbfe5b2b6d5b29e6800b">Roles with persisted permissions</a></li>


    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e885a88fdfc50203dbb9ee3a8bad01d0">1 - Cookbook Introduction</h1>
    
	<h2 id="the-cookbook-vs-the-guide">The Cookbook vs the Guide</h2>
<p>How is the cookbook different from the guide? Why is this necessary?</p>
<ul>
<li><strong>Greater Focus</strong>. In the guide, we&rsquo;re essentially telling a story. Each section builds on and assumes knowledge from each previous section. In the cookbook, each recipe stands on its own. This means recipes focus on one specific topic or use case, rather than having to give a general overview.</li>
<li><strong>Greater Depth</strong>. To avoid making the guide too long, we try to include only the simplest possible examples to help you understand each feature. Then we move on. In the cookbook, we can include more complex examples, combining features in interesting ways. Each recipe can also be as long and detailed as it needs to be, in order to fully explore its niche.</li>
<li><strong>Greater Complexity</strong>. In the guide, we assume at least intermediate familiarity with ES2015 JavaScript. In the cookbook however, you will see more TypeScript code, frontend and backend frameworks and libraries and real-world examples.</li>
</ul>
<blockquote>
<p>For most of cookbook&rsquo;s content, you are expected to have a basic understanding of concepts like JavaScript, npm/yarn, commonjs, ES import/export, Node.js module resolution algorithm. Depending on the recipe you are expected to know frontend or backend libraries and frameworks.</p>
</blockquote>
<h2 id="cookbook-contributions">Cookbook Contributions</h2>
<p>The Cookbook gives developers examples to work off of that both cover common or interesting use cases, and also progressively explain more complex detail. Our goal is to move beyond a simple introductory example, and demonstrate concepts that are more widely applicable, as well as some caveats to the approach.</p>
<p>If you’re interested in contributing, please initiate collaboration by filing an issue under the tag <strong>cookbook idea</strong> with your concept so that we can help guide you to a successful pull request. After your idea has been approved, please follow the template below as much as possible. Some sections are required, and some are optional. Following the numerical order is strongly suggested, but not required.</p>
<p>Recipes should generally:</p>
<ul>
<li>Solve a specific, common problem</li>
<li>Start with the simplest possible example to demonstrate the issue</li>
<li>Introduce complexities one at a time</li>
<li>Link to other docs, rather than re-explaining concepts</li>
<li>Describe the problem, rather than assuming familiarity</li>
<li>Explain the process, rather than just the end result</li>
<li>Explain the pros and cons of your strategy, including when it is and isn&rsquo;t appropriate</li>
<li>Mention alternative solutions, if relevant, but leave in-depth explorations to a separate recipe</li>
</ul>
<p>We ask you to follow the template below. We understand, however, that there are times when you may necessarily need to deviate for clarity or flow. Either way, all recipes should at some point discuss the nuance of the choice made using this pattern, preferably in the form of the alternative patterns section.</p>
<h3 id="the-issue">The issue</h3>
<p><em>required</em></p>
<ol>
<li>Articulate the problem in a sentence or two.</li>
<li>Show the simplest possible solution which leads to issues in the long run.</li>
<li>Explain the <strong>disadvantages</strong> of this solution</li>
</ol>
<h3 id="the-solution">The solution</h3>
<p><em>required</em></p>
<ol>
<li>Provide the suggested way to solve the issue</li>
<li>Explain the <strong>advantages</strong> in comparison to the simplest solution described in the section above</li>
<li>Discuss why this may be a compelling solution. Links for a reference are not required but encouraged</li>
<li>Walk through a few terse examples</li>
</ol>
<h3 id="demo">Demo</h3>
<p><em>required</em></p>
<p>Demonstrate the code that would power a common or interesting use case by embedding a codesandbox/scrimba/codepen/jsfiddle example.</p>
<h3 id="when-to-avoid">When To Avoid</h3>
<p><em>optional</em></p>
<p>This section is not required, but heavily recommended. Here, we’ll take an honest look at when the pattern is useful and when it should be avoided, or when something else makes more sense.</p>
<h3 id="alternative-ways">Alternative Ways</h3>
<p><em>optional</em></p>
<p>Similar to the previous section this one is optional, but very encouraged. The answer to most questions about development is <strong>&ldquo;It depends!&quot;</strong>. So, it’s important to explore other methods to let people compare and understand whether this solution makes sense in their situation.</p>
<h2 id="thank-you">Thank you</h2>
<p>It takes time to contribute to documentation, and if you spend the time to submit a PR to this section of our docs, you do so with our gratitude.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-34cd71443a17b1e740561cc7115b3277">2 - Less confusing can API</h1>
    
	<h2 id="the-issue">The issue</h2>
<p>CASL uses <code>can</code> and <code>cannot</code> function names to both define and check permissions. For some of you, it may look confusing and you would like to be more explicit and not rely on the execution context.</p>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// define abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// check abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><strong>The main disadvantage</strong> is that you need to remember the context and differences between function signatures of <a href="../../guide/intro"><code>can</code> that defines ability</a> and <code>can</code> that checks it.</p>
<h2 id="the-solution">The solution</h2>
<p>What we can do is to use different variables' names, so the example above looks this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// define abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">allow</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">forbid</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">forbid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// check abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The same example using pure <code>AbilityBuilder</code> can be written in similar way using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment#Assigning_to_new_variable_names">object-destructuring</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// define abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span>: <span style="color:#204a87;font-weight:bold">allow</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cannot</span>: <span style="color:#204a87;font-weight:bold">forbid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">build</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">allow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">forbid</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">private</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// check abilities
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Post&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><strong>The main advantage</strong> is that everybody clearly sees that <code>allow</code> and <code>can</code> are different methods and potentially may have different signatures (because they different!).</p>
<blockquote>
<p>See <a href="../../guide/define-rules">Define rules</a> for other ways to define ability.</p>
</blockquote>
<h2 id="when-to-avoid">When to avoid</h2>
<p>This approach really makes it easy to work with CASL for junior developers and those who prefers explicit code over conventions or context. If contextual code doesn&rsquo;t bother you, you can avoid this.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4c6eef94c958d52006827a9da7ccc6e3">3 - Claim based Authorization</h1>
    
	<h2 id="the-issue">The issue</h2>
<p>You need to implement simple authorization (i.e., permission management) logic based on claims (or actions). In other words, you have action (or a claim) but don&rsquo;t have the concept of &ldquo;subject&rdquo; on which this action can be applied (or it&rsquo;s not important in your app). This concept is very similar to <a href="https://en.wikipedia.org/wiki/Claims-based_identity">claim based identity</a>.</p>
<p>The easiest way to achieve this is to create an array of all possible actions (or claims) and check if a claim exists on the user object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ACTIONS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;publish&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">];</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">publishArticle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">article</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;publish&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You cannot publish articles&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// logic to publish article
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>What are <strong>the disadvantages</strong> of handmade solution:</p>
<ol>
<li>You need to test.<br>
It&rsquo;s very important to know that your permissions logic is reliable otherwise it doesn&rsquo;t make sense.</li>
<li>You need to support it (i.e., fix bugs).<br>
If you find a bug, you need to fix it and add tests. But what would you do if the bug is found by the attacker?</li>
<li>You need to evolve it.<br>
The world constantly changes, the same way your business requirements changes. If you need to add more complex permissions logic (e.g., permission per subject or per attribute), you will need to implement and test it yourself.</li>
</ol>
<p>All that consumes time and resources, as a result postpones the delivery of your product.</p>
<h2 id="the-solution">The solution</h2>
<p>Fortunately, CASL supports claim based authorization. The example above can be represented in CASL:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">PureAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PureAbility</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Actions</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;review&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;publish&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbility</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;((</span><span style="color:#000">can</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;review&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;publish&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">publishArticle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">article</span>: <span style="color:#204a87;font-weight:bold">object</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ability</span>: <span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cannot</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;publish&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;You cannot publish articles&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// logic to publish article
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p><strong>The advantages</strong> of this:</p>
<ol>
<li>You can start with simple permissions logic and evolve it together with your business requirements.</li>
<li>Thanks to tree-shaking in <a href="https://rollupjs.org/guide/en/">rollup</a> and <a href="https://webpack.js.org/">webpack</a> CASL takes only 1.5KB for claim based authorization.</li>
<li>No need to support own solution. Lots of people use and create issues for OpenSource libraries like CASL, so you get support, bug fix and new features for free.</li>
</ol>
<h2 id="when-to-avoid">When To Avoid</h2>
<p>Sometimes applications use merged action and subject as a claim: <code>create_article</code>, <code>read_article</code>, <code>read_user</code>. In such cases, it&rsquo;d better separate actions and subjects. This will allow you to add conditions and fields to your abilities later without refactoring the whole application.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b3edd3f097341ab85af67ee61c3e5879">4 - Cache abilities</h1>
    
	<blockquote>
<p>This recipe targets backend developers. We use <a href="https://expressjs.com/">express</a> library in this guide, so its knowledge (or knowledge of similar framework) is required.</p>
</blockquote>
<h2 id="the-issue">The issue</h2>
<p>It takes considerable amount of time or requires additional roundtrip to the database to construct an <code>Ability</code> instance.</p>
<p>Let&rsquo;s consider an example where user can manage own devices but <strong>devices doesn&rsquo;t have</strong> a reference to the owner. In such cases, we need to fetch all device ids in order to create an <code>Ability</code>:</p>
<div class="highlight" data-filename="defineAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Abilities</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">getDevicesOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../services/device&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">devices</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">getDevicesOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ids</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">devices</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">device</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Device&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">$in</span>: <span style="color:#204a87;font-weight:bold">ids</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#8f5902;font-style:italic">// other rules
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">rules</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rules</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AppAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>The underlying database is not important for this guide. The same principles works for any other database system.</p>
</blockquote>
<h2 id="the-solution">The solution</h2>
<p>To speed things up, you can cache creation of the ability instance.</p>
<h2 id="demo">Demo</h2>
<p>There are several ways to do this:</p>
<blockquote>
<p>Make sure that you wrap all async express middlewares in try/catch as express 4.x doesn&rsquo;t support <code>Promise</code> rejections. We don&rsquo;t do this in the examples below for the sake of simplicity.</p>
</blockquote>
<h3 id="in-memory-lru-cache">In memory LRU cache</h3>
<p><a href="https://en.wikipedia.org/wiki/Cache_replacement_policies#Least_Recently_Used_.28LRU.29">LRU cache</a> is a type of cache which discards least recently used entries, hence allows to store abilities for the most active users, that users who generate the highest load on your system.</p>
<blockquote>
<p>There is quite popular <a href="https://www.npmjs.com/package/lru-cache">lru-cache</a> Node.js package which we will use in this guide but you can use any other implementation the same way.</p>
</blockquote>
<p>So, let&rsquo;s create a middleware that defines <code>Ability</code> instance of <code>Request</code> object:</p>
<div class="highlight" data-filename="provideAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">LruCache</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;lru-cache&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// store abilities of 1000 most active users
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ABILITIES_CACHE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">LruCache</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ABILITIES_CACHE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">has</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ABILITIES_CACHE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">ABILITIES_CACHE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">next</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now we can use this middleware to provide <code>Ability</code> instance for a particular user and check its permissions:</p>
<div class="highlight" data-filename="boot.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">provideAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./provideAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">express</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">express</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// app configuration and other middlewares
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;app is listening on http://localhost:3000&#34;</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><blockquote>
<p>Don&rsquo;t forget to invalidate cache when user adds or removes devices</p>
</blockquote>
<h3 id="in-session-storage">In session storage</h3>
<p>If the application uses stored sessions and <a href="#in-memory-lru-cache">LRU cache</a> doesn&rsquo;t satisfy your needs, you can store <code>Ability</code> rules in user&rsquo;s session (e.g., Redis, Memcached). Why do we store rules and not <code>Ability</code> instance? Because session storage serializes object before storing it. Rules are easily serializable and <code>Ability</code> instance is not, but can be created from rules.</p>
<p>Sessions in express usually are implemented with help of <a href="https://www.npmjs.com/package/express-session">express-session</a> and <a href="https://www.npmjs.com/package/connect-redis">connect-redis</a>. We will do it the same way.</p>
<p>So, the only thing which is left is to implement <code>provideAbility</code> middleware that saves rules for a particular user in his session storage. Pay attention that we use <code>defineRulesFor</code> and not <code>defineAbilityFor</code> function:</p>
<div class="highlight" data-filename="provideAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Abilities</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineRulesFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">rules</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abilityRules</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abilityRules</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">rules</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abilityRules</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rules</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">next</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And make sure that you correctly configure express-session in your <code>app.ts</code> file. It should be something like this:</p>
<div class="highlight" data-filename="app.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">provideAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./provideAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">express</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">session</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;express-session&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">redis</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">createRedisStore</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;connect-redis&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">express</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">RedisStore</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createRedisStore</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">session</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000">session</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#000">store</span>: <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RedisStore</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">client</span>: <span style="color:#204a87;font-weight:bold">redis.createClient</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000">secret</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;my app session secret&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">})</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// app configuration and other middlewares
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="in-jwt-token-payload">In JWT token payload</h3>
<p>If the app uses stateless <a href="https://en.wikipedia.org/wiki/JSON_Web_Token">JWT</a> tokens, you can embed the rules into its payload:</p>
<div class="highlight" data-filename="login.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">jwt</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;jsonwebtoken&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineRulesFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">login</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jwt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sign</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">req.user.id</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">rules</span>: <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">defineRulesFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#4e9a06">&#34;secret&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">expiresIn</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;1d&#34;</span> <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">token</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And implement <code>provideAbility</code> middleware that creates ability out of jwt token which is provided by client in <code>Authorization</code> header:</p>
<div class="highlight" data-filename="provideAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Abilities</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">jwt</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;jsonwebtoken&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineRulesFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./defineAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">provideAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">next</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">token</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authorization</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">rules</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jwt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">verify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">token</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;jwtSecret&#34;</span><span style="color:#000;font-weight:bold">));</span>

    <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">next</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">next</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>You can use <code>packRules</code> and <code>unpackRules</code> to minimize rules payload size in 2 times. Check the <a href="../../api/casl-ability-extra#pack-rules">API docs of @casl/ability/extra</a> for details</p>
</blockquote>
<h2 id="when-to-avoid">When to avoid</h2>
<p>There are few cases when you should avoid caching:</p>
<ol>
<li>The amount of abilities is small.</li>
<li>The requests to the database are cached in service layer.</li>
<li>Your permissions are dynamic and it makes hard to keep cache in sync with the datastore state.</li>
<li>You can rethink domain model to simplify permissions logic (denormalize some entities or add additional foreign keys).</li>
</ol>
<h2 id="alternative-ways">Alternative ways</h2>
<p>Another way is to rethink domain (or data) model, so that you can build abilities from the information which you load for every request (e.g., completely on <code>user</code>&rsquo;s details). In the case described in <a href="#the-issue">The issue</a>, we could add <code>userId</code> field to <code>Device</code> model and that would make things work fast without additional caching.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-001366d799f10789e049c841de4397c9">5 - Roles with predefined permissions</h1>
    
	<blockquote>
<p>This recipe targets backend developers. We use <a href="https://www.typescriptlang.org">TypeScript</a> and <a href="https://en.wikipedia.org/wiki/Relational_database">RDBMS</a> in this guide, so the basic knowledge of both is required.</p>
</blockquote>
<h2 id="the-issue">The issue</h2>
<p>The application can be used by multiple users with different roles. Each role has predefined set of permissions.</p>
<blockquote>
<p>This is also known as <a href="https://searchsecurity.techtarget.com/definition/role-based-access-control-RBAC">RBAC (Role based access control)</a>.</p>
</blockquote>
<h2 id="the-solution">The solution</h2>
<p>First of all, we need to define tables for <code>users</code> and <code>roles</code>. <code>users</code> table stores <code>id</code>, <code>email</code>, <code>password</code> and <code>roleId</code>. <code>roles</code> table stores only <code>id</code> and <code>name</code>.</p>
<blockquote>
<p>Tables' structure may be different in your application. We are going to use the simplest but sufficient structure to solve <a href="#the-issue">The issue</a></p>
</blockquote>
<p>As our roles has a predefined set of permissions which are not required to be changeable in runtime, we are going to define role permissions in the code. For each role we will have a separate function. Then depending on the role name, we will call that function to define permissions and create <code>Ability</code> instance. Using <code>Ability</code> instance we can guarantee that a user can do only what his role allows him to do.</p>
<blockquote>
<p>In the next Demo, we are not going to implement REST API as the main intention of this recipe is to solve <a href="#the-issue">The issue</a>.</p>
</blockquote>
<h2 id="demo">Demo</h2>
<p>To make things simple, we will use SQLite database. This also allows to quickly setup the demo on local machine and even run it in a browser.</p>
<p>The demo domain is very simple, this is an app that allows to invite users. This app has 2 roles:</p>
<ul>
<li><code>member</code> user can
<ul>
<li>invite any user</li>
<li>update information about himself</li>
</ul>
</li>
<li><code>admin</code> user can
<ul>
<li>manage everything</li>
</ul>
</li>
</ul>
<p>In order to start, we need to create a migration script for <code>users</code> and <code>roles</code> tables and seed our database with default records. To do this, we will use <a href="http://knexjs.org/">knex</a> SQL builder.</p>
<blockquote>
<p>We are not going to walk through knex&rsquo;s API and usage, so if you are not familiar with it, take some time to look through its documentation. Anyway, don&rsquo;t worry, it&rsquo;s quite expressive.</p>
</blockquote>
<details>
<summary>Initial migration</summary>
<div class="highlight" data-filename="migrations/20200401110244_init.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">up</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schema</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">integer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roleId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">unsigned</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>

      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">foreign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roleId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">references</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">inTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">down</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div></details>
<details>
<summary>Initial seeds</summary>
<div class="highlight" data-filename="seeds/init.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">()]);</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin&#34;</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member&#34;</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">roleId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">roleId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div></details>
<p>Now, let&rsquo;s define all possible actions and subjects.</p>
<h3 id="abilities">Abilities</h3>
<p>This app has only <code>User</code> subject, users can only <code>update</code> himself and invite other users, so:</p>
<div class="highlight" data-filename="appAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;invite&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">subjects</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">actions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">subjects</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Exclude</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">typeof</span> <span style="color:#c4a000">subjects</span><span style="color:#a40000">[</span><span style="color:#c4a000">number</span><span style="color:#a40000">],</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">all</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbilities</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">AbilityClass</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;;</span>
</code></pre></div><blockquote>
<p>See <a href="../../advanced/typescript#useful-type-helpers">TypeScript support</a> to get details about type helpers.</p>
</blockquote>
<p><code>typeof actions[number]</code> converts readonly array into union of its values, this allows to reuse actions and subjects defined in value scope inside type scope.</p>
<p>Having all possible subjects and actions, we can define roles' permissions in the same file:</p>
<div class="highlight" data-filename="appAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityClass</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../models/User&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// abilities definition from previous example
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">DefinePermissions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">builder</span>: <span style="color:#204a87;font-weight:bold">AbilityBuilder</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Roles</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;member&#34;</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rolePermissions</span>: <span style="color:#204a87;font-weight:bold">Record</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Roles</span><span style="color:#a40000">,</span> <span style="color:#c4a000">DefinePermissions</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">member</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;invite&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">user.id</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000">admin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">can</span> <span style="color:#000;font-weight:bold">})</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">can</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><blockquote>
<p>Do you see how readable this definition object is? The function signature says &ldquo;member user can&rdquo; and the body describes what the member user can do. Looks very similar to how we described our requirements at the beginning of <a href="#demo">Demo</a> section, don&rsquo;t it?</p>
</blockquote>
<p>We imported <code>User</code> data class in order to make our functions a bit more strongly typed, its shape is the following:</p>
<div class="highlight" data-filename="models/User.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">password</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">role</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>We created <code>rolePermissions</code> object that holds our permission definitions functions instead of using regular functions. This allows us to retrieve role specific function by accessing properties of this object, this is very convenient and efficient.</p>
</blockquote>
<p>Finally, let&rsquo;s create a function that defines <code>Ability</code> instance for our user, let&rsquo;s do this in the same file:</p>
<div class="highlight" data-filename="services/appAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">AbilityBuilder</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../models/User&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// abilities definition from the example above
</span><span style="color:#8f5902;font-style:italic">// roles definition from the example above
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span>: <span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">AppAbility</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">builder</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbilityBuilder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">rolePermissions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">role</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;function&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">rolePermissions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">role</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">builder</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Trying to use unknown role &#34;</span><span style="color:#4e9a06">${</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">role</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;`</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">builder</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">build</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>We need to ensure that permissions' definition function for a particular role exists because TypeScript can&rsquo;t help us to ensure that roles in the database reflects our types. So, we fail fast.</p>
</blockquote>
<h3 id="putting-together">Putting together</h3>
<p>First of all, we need a function that returns a user by its email and another one that updates a user by its id:</p>
<div class="highlight" data-filename="services/users.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">db</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./db&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./models/User&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">findUserByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users.email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;roles.name&#34;</span> <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">innerJoin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;roles.id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users.roleId&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UserChanges</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Exclude</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">User</span><span style="color:#a40000">,</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">role</span><span style="color:#a40000">&#34;</span> <span style="color:#a40000">|</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">id</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">updateUserById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">changes</span>: <span style="color:#204a87;font-weight:bold">UserChanges</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000">users</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">changes</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now we can implement <code>updateUserDetails</code> function:</p>
<div class="highlight" data-filename="updateUserDetails.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">defineAbilityFor</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">findUserByEmail</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updateUserById</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">UserChanges</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/users&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">updateUserDetails</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#8f5902;font-style:italic">/** email of a user who initiates the request (i.e., logged in user) */</span>
  <span style="color:#000">initiatorEmail</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#8f5902;font-style:italic">/** an email of user to be updated */</span>
  <span style="color:#000">userToBeUpdatedEmail</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#8f5902;font-style:italic">/** an object of changes to be applied */</span>
  <span style="color:#000">changes</span>: <span style="color:#204a87;font-weight:bold">UserChanges</span>
<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findUserByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">initiatorEmail</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ability</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">defineAbilityFor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">userToBeUpdated</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">userToBeUpdatedEmail</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">initiatorEmail</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">user</span> : <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">findUserByEmail</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userToBeUpdatedEmail</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">userToBeUpdated</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">updateUserById</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">userToBeUpdated</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">changes</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><blockquote>
<p>We intentionally made this function to accept both initiator and user whose details needs to be updated in order to show that permissions' logic works correctly. In real world apps, this function should accept only initiator and update his details!</p>
</blockquote>
<p>Let&rsquo;s go line by line in order to understand the code:</p>
<ol>
<li>We created <code>updateUserDetails</code> that accepts 3 arguments: 1st represents user&rsquo;s email who initiates the request (i.e., logged in user), 2nd is an email of a user whose details will be updated and 3rd is an object of changes.</li>
<li>Inside the function, we find initiator user in order to create <code>Ability</code> instance for it.</li>
<li>We also find user whose details needs to be updated, so we have his id.</li>
<li>Using <code>ForbiddenError</code> class, we ensure that user can update own details. If not, a <code>ForbiddenError</code> will be thrown. Also pay attention that we call <code>subject</code> function. It assigns a particular subject type to a plain JavaScript object (see <a href="../../guide/subject-type-detection#subject-helper">subject helper</a> for details).</li>
<li>We call <code>updateUserById</code> function to update user details by id in the database.</li>
</ol>
<p>To test this function, let&rsquo;s create a simple script:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">updateUserDetails</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./updateUserDetails&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">updateUserDetails</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;654321&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: own details were successfully updated&#34;</span><span style="color:#000;font-weight:bold">))</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: cannot update own details&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">updateUserDetails</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;admin@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;654321&#34;</span> <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: admin details were successfully updated&#34;</span><span style="color:#000;font-weight:bold">))</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: admin details are NOT ALLOWED to be updated&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>If you run this code, you will get:</p>
<pre tabindex="0"><code>[member]: own details were successfully updated
[member]: admin details are NOT ALLOWED to be updated
</code></pre><p>At this point, you have enough details to implement <code>inviteUser</code> function by yourself ;) So, we will just go through its logic:</p>
<ol>
<li><code>inviteUser</code> accepts 2 arguments: initiator&rsquo;s email and email of the user to be invited.</li>
<li>Retrieve initiator user by its email.</li>
<li>Check that initiator is allowed to invite a user.</li>
<li>Check if the user to be invited has not been registered in the system before.</li>
<li>If not, send an email to this user with invitation message.</li>
</ol>
<h3 id="conclusion">Conclusion</h3>
<p>That&rsquo;s it! You now have a powerful role based access control powered by CASL! We hope this tutorial was helpful and made your understanding of CASL.js even better :)</p>
<h2 id="alternative-patterns">Alternative patterns</h2>
<p>This pattern is very powerful and scales very good. Even if at some point in the future, you will need to allow users to change permissions dynamically (e.g., via REST API or User Interface), you can easily do this, read <a href="../roles-with-persisted-permissions">Roles with persisted permissions</a> recipe for details.</p>
<p>If you need to implement claim based permissions, check <a href="../claim-authorization">Claim based Authorization</a> recipe.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7afd37d55b8ffbfe5b2b6d5b29e6800b">6 - Roles with persisted permissions</h1>
    
	<blockquote>
<p>This recipe targets backend developers. We use <a href="https://www.typescriptlang.org">TypeScript</a> and <a href="https://en.wikipedia.org/wiki/Relational_database">RDBMS</a> in this guide, so the basic knowledge of both is required.</p>
</blockquote>
<h2 id="the-issue">The issue</h2>
<p>The application can be used by multiple users with different roles. Roles' permissions should be configurable through API (e.g., REST API or User Interface). So, we don&rsquo;t need to change or redeploy the app in order to change permissions.</p>
<blockquote>
<p>This is also known as <a href="https://searchsecurity.techtarget.com/definition/role-based-access-control-RBAC">RBAC (Role based access control)</a>.</p>
</blockquote>
<h2 id="the-solution">The solution</h2>
<p>In order to achieve this, we need to store permissions in the database.</p>
<p>First of all, we need to gather all possible actions and subjects, in order to validate them before saving permission to the database.</p>
<p>When all combinations of actions and subjects are known, we can create a table for <code>roles</code>. It should have at least 2 columns: <code>id</code> and <code>name</code>. Then we need to choose one of 2 options to connect roles with permissions:</p>
<ol>
<li>Add <code>permissions</code> column of JSON (or TEXT) data type into <code>roles</code> and store all rules in that single column.<br>
<strong>The main advantage</strong> is that it&rsquo;s very simple to manage and retrieve.
<strong>The main disadvantage</strong> is that most ORMs doesn&rsquo;t support partial updates of JSON (and especially TEXT) column, instead they update the whole value as a primitive value. This may lead to unexpected results if several users update permissions of the same role at the same time (the last one will reset changes of others).</li>
<li>Create a separate table for <code>permissions</code> which has <code>action</code>, <code>subject</code>, <code>conditions</code> and <code>roleId</code> fields.<br>
<strong>The main advantage</strong> is that you can do partial updates using regular SQL.
<strong>The main disadvantage</strong> more complicated queries (you need to join <code>roles</code> and <code>permissions</code>) and bigger eventual database size.</li>
</ol>
<p>We will use the 1st option in this guide because permissions are not changed often, so the risk of conflict is acceptable for us. Moreover this <code>permissions</code> field will contain an array that is acceptable by <code>Ability</code> instance (i.e., <code>RawRuleOf&lt;AppAbility&gt;[]</code>).</p>
<blockquote>
<p>If it&rsquo;s not acceptable for your situation, use raw SQL syntax of your RDBMS to partially update JSON column or use 2nd option.</p>
</blockquote>
<p>We also need a table for <code>users</code>. Every user may have only 1 role, in other words every row in <code>users</code> table should have <code>roleId</code> field.</p>
<p>Having users, roles and permissions, we can create <code>Ability</code> instance for every user request. The logic for the REST API is the following:</p>
<ol>
<li>User sends request to access some resources.</li>
<li>If it&rsquo;s not authenticated, sends back an error that he needs to login.</li>
<li>If it&rsquo;s authenticated, the app fetches it together with permissions from the database.</li>
<li>The app creates an <code>Ability</code> instance based on user&rsquo;s permissions</li>
<li>Using <code>Ability</code> instance, the app checks whether user can do a particular action on requested resource.</li>
<li>If not, it&rsquo;s sends error back that user has no permission to do what he attempted to do.</li>
<li>If user has permissions, then proceed with the actual action.</li>
</ol>
<p>Enough theory, let&rsquo;s see some examples!</p>
<blockquote>
<p>In the next Demo, we are not going to implement REST API as the main intention of this recipe is to solve <a href="#the-issue">The issue</a>.</p>
</blockquote>
<h2 id="demo">Demo</h2>
<p>To make things simple, we will use SQLite database. This also allows to quickly setup the demo on local machine and even run it in a browser.</p>
<p>As a domain, we will use blog application. This is the most known domain, so we won&rsquo;t spent time explaining its details and instead will concentrate on the actual issue.</p>
<p>In our blog, we have 2 roles: <code>member</code> (any registered user) and <code>admin</code>. So, <code>admin</code> can do everything and <code>member</code>:</p>
<ul>
<li>can read all articles</li>
<li>can manage own articles</li>
</ul>
<p>We will use <a href="http://knexjs.org/">knex</a> SQL builder to work with the database.</p>
<blockquote>
<p>We are not going to walk through knex&rsquo;s API and usage, so if you are not familiar with it, take some time to look through its documentation. Anyway, don&rsquo;t worry, it&rsquo;s quite expressive.</p>
</blockquote>
<p>So, let&rsquo;s define the table structure for our database. It includes 3 tables: <code>users</code>, <code>roles</code> and <code>articles</code>. Also we will seed our database with default records:</p>
<ul>
<li>2 roles: admin and member</li>
<li>2 users: 1 admin and 1 member</li>
</ul>
<p>You can find the migration and seeds below:</p>
<details>
<summary>Initial migration</summary>
<div class="highlight" data-filename="migrations/20200401110234_init.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">up</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schema</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">integer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roleId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">unsigned</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>

      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">foreign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roleId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">references</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">inTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;articles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;title&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;description&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">integer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authorId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">unsigned</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>

      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">foreign</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;authorId&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">references</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">inTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">createTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">increments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;id&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000">table</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;permissions&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">notNullable</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">down</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">schema</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;articles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">dropTable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div></details>
<p>and initial seed:</p>
<div class="highlight" data-filename="seeds/init.js"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">seed</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">()]);</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">permissions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">([{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;all&#34;</span> <span style="color:#000;font-weight:bold">}]),</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">permissions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">([</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">},</span>
        <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">conditions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${user.id}&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">]),</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">knex</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">roleId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member@casl.io&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">roleId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><blockquote>
<p>We used <code>${user.id}</code> in <code>conditions</code> property of permissions. This is just a placeholder which we will replace it later with the id of a particular user.</p>
</blockquote>
<p>Now, let&rsquo;s define all possible actions and subjects:</p>
<div class="highlight" data-filename="services/appAbility.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">RawRuleOf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ForcedSubject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">actions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;manage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">subjects</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;all&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">const</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Abilities</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">actions</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">subjects</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">ForcedSubject</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Exclude</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">typeof</span> <span style="color:#c4a000">subjects</span><span style="color:#a40000">[</span><span style="color:#c4a000">number</span><span style="color:#a40000">],</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">all</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
<span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">createAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">rules</span>: <span style="color:#204a87;font-weight:bold">RawRuleOf</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;[])</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Ability</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Abilities</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#000">rules</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><blockquote>
<p>See <a href="../../advanced/typescript#useful-type-helpers">TypeScript support</a> to get details about type helpers.</p>
</blockquote>
<p><code>typeof actions[number]</code> converts readonly array into union of its values, this allows to reuse actions and subjects defined in value scope inside type scope. We also export <code>createAbility</code> function to make it easier to create <code>Ability</code> instance with bound generic parameters.</p>
<p>In order to work with our database on higher level, we need to create services.</p>
<h3 id="services">Services</h3>
<p>We need to create 2 services: one to fetch <code>users</code> and another to manage <code>articles</code>.</p>
<p>Let&rsquo;s start from a function that will allow us to fetch a single user by some conditions from the database. This function also will prepare user&rsquo;s permissions, so we can directly pass them in <code>createAbility</code> function:</p>
<div class="highlight" data-filename="services/users.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">db</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../db&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../models/User&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">interpolate</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../helpers/interpolate&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">findBy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">where</span>: <span style="color:#204a87;font-weight:bold">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Record</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">keyof</span> <span style="color:#c4a000">User</span><span style="color:#a40000">,</span> <span style="color:#c4a000">any</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">...</span><span style="color:#000">user</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">User</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#4e9a06">&#34;users&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">innerJoin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users.roleId&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;roles.id&#34;</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">select</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.id&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users.email&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;roles.permissions&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;roles.name&#34;</span> <span style="color:#000;font-weight:bold">})</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#000">user</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">permissions</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">interpolate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">user</span> <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Let&rsquo;s go line by line to understand what happens in the function:</p>
<ul>
<li>
<p>we import <code>db</code>, this is a knex connection instance</p>
</li>
<li>
<p>we import <code>User</code>, this is just an interface for users that has the next shape:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">RawRuleOf</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../services/appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">User</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">email</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">role</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">permissions</span>: <span style="color:#204a87;font-weight:bold">RawRuleOf</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">&gt;[];</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>As you can see, its permissions property has the type that <code>Ability</code> instance accepts in the first parameter. This was done intentionally to simplify ability creation.</p>
</li>
<li>
<p>we import <code>interpolate</code> function, this function takes a JSON template and replaces all placeholder (e.g., <code>${user.id}</code>) with the provided variables inside context. This function uses <code>reviver</code> argument of <code>JSON.parse</code> method to iterate deeply over the object but it&rsquo;s not important for this guide. You can use any template library you like (e.g., <a href="https://mustache.github.io/">mustache</a>, <a href="http://underscorejs.org/#template">underscore template</a>).</p>
</li>
<li>
<p>in <code>findBy</code> function, we join users and roles to get user&rsquo;s permissions and role and preprocess permissions' template with the <code>interpolate</code> function (so that, it replaces <code>${user.id}</code> placeholders with the actual <code>user.id</code> value).</p>
</li>
</ul>
<p>The service for articles is more complicated, it will check users' ability to do a particular action on the provided article instance. For the sake of simplicity, we&rsquo;ll show only <code>create</code> function (all the rest are similar):</p>
<div class="highlight" data-filename="services/articles.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;@casl/ability&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">AppAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">db</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../db&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;../models/Article&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">articles</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Article</span><span style="color:#000;font-weight:bold">&gt;(</span><span style="color:#4e9a06">&#34;articles&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span>: <span style="color:#204a87;font-weight:bold">AppAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">partialArticle</span>: <span style="color:#204a87;font-weight:bold">Omit</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Article</span><span style="color:#a40000">,</span> <span style="color:#a40000">&#34;</span><span style="color:#c4a000">id</span><span style="color:#a40000">&#34;</span><span style="color:#000;font-weight:bold">&gt;)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">ForbiddenError</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ability</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">throwUnlessCan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">subject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">partialArticle</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">partialArticle</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">...</span><span style="color:#000">partialArticle</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">Article</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// other functions
</span></code></pre></div><p>In this service, we use <code>ForbiddenError</code> class which allows to throw an error if user doesn&rsquo;t have an ability to do something. We also wrap <code>partialArticle</code> with <code>subject</code> call. This allows <code>Ability</code> instance to detect subject type of a plain object.</p>
<blockquote>
<p>See <a href="../../guide/subject-type-detection#subject-helper">Subject type detection</a> for details.</p>
</blockquote>
<p><code>Article</code> is an interface that enforces the shape of our articles:</p>
<div class="highlight" data-filename="models/Article.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Article</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">id</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">title</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">description</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Now, when service layer is finished, we can put it together!</p>
<h3 id="putting-together">Putting together</h3>
<p>We need to start from connecting things together, to do so we need to fetch users and create <code>Ability</code> instances for each one:</p>
<div class="highlight" data-filename="main.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">findBy</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/users&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">createAbility</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/appAbility&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">main() {</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">admin</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">author</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">findBy</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;admin@casl.io&#34;</span> <span style="color:#000;font-weight:bold">}),</span> <span style="color:#000">findBy</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">email</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;member@casl.io&#34;</span> <span style="color:#000;font-weight:bold">})]);</span>

  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">adminAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">admin</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">authorAbility</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createAbility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">author</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">permissions</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// the rest of the code
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>We also need to create 2 articles, one that is written by admin and another by author:</p>
<div class="highlight" data-filename="main.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#8f5902;font-style:italic">// imports here
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">main() {</span>
  <span style="color:#8f5902;font-style:italic">// fetch users &amp; create ability instances
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">adminArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;CASl and TypeScript&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Is very powerful&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">admin</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">};</span>

  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">authorArticle</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">title</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;CASl and TypeScript&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">description</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Is very powerful&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">authorId</span>: <span style="color:#204a87;font-weight:bold">author</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">};</span>

  <span style="color:#8f5902;font-style:italic">// the rest of the code
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>And finally let&rsquo;s check our permissions:</p>
<ul>
<li><code>admin</code> user should be able to create article in spite of who wrote it</li>
<li><code>member</code> user should be able to only create articles that were written by him</li>
</ul>
<div class="highlight" data-filename="main.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#8f5902;font-style:italic">// other imports here
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">articles</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./services/articles&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">main() {</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adminAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">adminArticle</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[admin]: created article written by himself&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">authorAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">adminArticle</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[member]: cannot create an article written by admin&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">adminAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">authorArticle</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[admin]: created article written by author&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">authorAbility</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">authorArticle</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[author]: created article written by himself&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;\nAll articles &#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rawArticles</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">articles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">find</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#000">rawArticles</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forEach</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">article</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">prefix</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">article</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">authorId</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">admin</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#4e9a06">&#34;[admin]&#34;</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;[author]&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">prefix</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">: </span><span style="color:#4e9a06">${</span><span style="color:#000">article</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">title</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Let&rsquo;s call <code>main</code> function and see the results:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ npm start

<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by himself
<span style="color:#ce5c00;font-weight:bold">[</span>author<span style="color:#ce5c00;font-weight:bold">]</span>: cannot create an article written by admin
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by author
<span style="color:#ce5c00;font-weight:bold">[</span>author<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by himself

All articles
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>author<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>author<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
</code></pre></div><p>Everything works as we it should! Now let&rsquo;s allow members to create any article. To do so, we need to update permissions of <code>member</code> role and we will do this using <a href="http://knexjs.org/">knex</a>:</p>
<div class="highlight" data-filename="updateMemberRole.ts"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">db</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./db&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">db</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;roles&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#000">permissions</span>: <span style="color:#204a87;font-weight:bold">JSON.stringify</span><span style="color:#000;font-weight:bold">([</span>
      <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;read&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;create&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">action</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;update&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;delete&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">subject</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Article&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">conditions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">authorId</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;${user.id}&#34;</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">]),</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">where</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;member&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Permissions of &#34;member&#34; role has been updated&#39;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">destroy</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>After updating member&rsquo;s permissions and running <code>main</code> function again, we got this results:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ npm start

<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: created own article
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by admin &lt;---
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by author
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: created article written by himself

All articles
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>admin<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
<span style="color:#ce5c00;font-weight:bold">[</span>member<span style="color:#ce5c00;font-weight:bold">]</span>: CASl and TypeScript
</code></pre></div><p>As you can see, member is now allowed to create articles created by admins!</p>
<h3 id="conclusion">Conclusion</h3>
<p>That&rsquo;s it! You now have a fully manageable CASL powered permissions logic in your app. We hope this tutorial was helpful and made your development experience with CASL.js even more enjoyable :)</p>
<p>You can find the source code of this solution on <a href="https://github.com/stalniy/casl-persisted-permissions-example">Github</a>.</p>
<h2 id="when-to-avoid">When to avoid</h2>
<ol>
<li>If you have a predefined set of permissions for every role which very unlikely to change.</li>
<li>If you start a new project and not sure whether you need to dynamically configure permissions.</li>
</ol>
<h2 id="alternative-patterns">Alternative patterns</h2>
<p>As an alternative you can implement <a href="../roles-with-static-permissions">predefined permissions with CASL</a>. It brings the same benefits but with less overhead.</p>
<p>If you need to implement claim based permissions, check <a href="../claim-authorization">Claim based Authorization</a> recipe.</p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 kamilmysliwiec 保留所有权利</small>
        <small class="ml-1"><a href="https://kamilmysliwiec.com/" target="_blank" rel="noopener">隐私政策</a></small>
	
		
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/casl-docs/js/tabpane-persist.js'></script>


















<script src="/casl-docs/js/main.min.9a2012c9716c36c3da0c29adaa4e22338e4fdd8d8b24ce3efc0ca172697a9196.js" integrity="sha256-miASyXFsNsPaDCmtqk4iM45P3Y2LJM4&#43;/Ayhcml6kZY=" crossorigin="anonymous"></script>




  </body>
</html>
